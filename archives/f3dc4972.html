<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>若依框架实战项目 - 中州养老 | Norlcyan's Blog</title><meta name="author" content="Zhao"><meta name="copyright" content="Zhao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文档以及资料：‍﻿‬‬‬‌‬‬‍﻿﻿‌‌‌﻿‬‍‍‌⁠‬‌04-企业级智能物联网项目（中州养老） - 飞书云文档 项目中的护理模块相关内容已经在若依框架资料中实现 入住办理在开发之前呢，重新搞定一套新的环境，详细请参考：初始代码-环境准备 需求分析入住办理列表页原型文件如下：    搜索：老人姓名为模糊搜索，老人身份证号为精准搜索； 列表数据：列表中所展示的数据是入住成功且未退住的老人信息 发起入">
<meta property="og:type" content="article">
<meta property="og:title" content="若依框架实战项目 - 中州养老">
<meta property="og:url" content="http://example.com/archives/f3dc4972.html">
<meta property="og:site_name" content="Norlcyan&#39;s Blog">
<meta property="og:description" content="文档以及资料：‍﻿‬‬‬‌‬‬‍﻿﻿‌‌‌﻿‬‍‍‌⁠‬‌04-企业级智能物联网项目（中州养老） - 飞书云文档 项目中的护理模块相关内容已经在若依框架资料中实现 入住办理在开发之前呢，重新搞定一套新的环境，详细请参考：初始代码-环境准备 需求分析入住办理列表页原型文件如下：    搜索：老人姓名为模糊搜索，老人身份证号为精准搜索； 列表数据：列表中所展示的数据是入住成功且未退住的老人信息 发起入">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/avatar.jpg">
<meta property="article:published_time" content="2026-01-15T14:13:56.000Z">
<meta property="article:modified_time" content="2026-01-15T14:31:12.161Z">
<meta property="article:author" content="Zhao">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="Java Web入门">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.jpg"><link rel="shortcut icon" href="/img/z.png"><link rel="canonical" href="http://example.com/archives/f3dc4972.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '若依框架实战项目 - 中州养老',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2026-01-15 22:31:12'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/footer.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/bodybg.css"><meta name="generator" content="Hexo 7.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/loading.gif" data-original="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">142</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa fa-comments"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Norlcyan's Blog"><span class="site-name">Norlcyan's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa fa-comments"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">若依框架实战项目 - 中州养老</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-15T14:13:56.000Z" title="发表于 2026-01-15 22:13:56">2026-01-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-15T14:31:12.161Z" title="更新于 2026-01-15 22:31:12">2026-01-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="若依框架实战项目 - 中州养老"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><p>文档以及资料：<a target="_blank" rel="noopener" href="https://dcnb1zlrk6z5.feishu.cn/wiki/ZYfMwbM4uiJpQ9kcal6cKCX9nvh">‍﻿‬‬‬‌‬‬‍﻿﻿‌‌‌﻿‬‍‍‌⁠‬‌04-企业级智能物联网项目（中州养老） - 飞书云文档</a></p>
<p>项目中的护理模块相关内容已经在若依框架资料中实现</p>
<h1 id="入住办理"><a href="#入住办理" class="headerlink" title="入住办理"></a>入住办理</h1><p>在开发之前呢，重新搞定一套新的环境，详细请参考：<a target="_blank" rel="noopener" href="https://rant7bdsfuy.feishu.cn/wiki/AEtgwlNH0izYFtkaXgtcsJBunMd">初始代码-环境准备</a></p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><h3 id="入住办理列表页"><a href="#入住办理列表页" class="headerlink" title="入住办理列表页"></a>入住办理列表页</h3><p>原型文件如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/zzyl1.png" alt="1280X1280 (2)"/>

<ol>
<li>搜索：老人姓名为模糊搜索，老人身份证号为精准搜索；</li>
<li>列表数据：列表中所展示的数据是入住成功且未退住的老人信息</li>
<li>发起入住办理：点击【发起入住申请】进入到【入住申请详情页】；</li>
<li>查看：点击【查看】进入到【入住详情页】，数据回显，不可编辑，不显示文本框，只显示已填写&#x2F;已选择的内容；</li>
</ol>
<h3 id="入住办理详情页"><a href="#入住办理详情页" class="headerlink" title="入住办理详情页"></a>入住办理详情页</h3><p>通过原型打开入住办理详情页，详细如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/1280X1280 (3).PNG" alt="1280X1280 (3)"/>

<p>上述需求中，共包含了四部分：</p>
<ul>
<li>基本信息：入住老人的基本信息，包含了姓名、年龄、身份证号、性别，住址、照片等信息</li>
<li>家属信息：入住老人的家属列表，可以有多个</li>
<li>入住配置：入住老人在养老院选择的费用信息，包含了护理等级，入住床位、入住期限等信息</li>
<li>签约办理：入住老人签订的合同信息</li>
</ul>
<h2 id="表结构设计"><a href="#表结构设计" class="headerlink" title="表结构设计"></a>表结构设计</h2><h3 id="后端开发流程"><a href="#后端开发流程" class="headerlink" title="后端开发流程"></a>后端开发流程</h3><p>在开发接口之前呢，需要先熟悉一下后端开发的流程，如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/0f60625c-0e54-44ea-9a8e-3ec9c5b66313.png" alt="0f60625c-0e54-44ea-9a8e-3ec9c5b66313"/>

<ul>
<li>需求分析(基于原型和PRD)</li>
<li>开发计划(工期评估)</li>
<li><strong>表结构设计(基于原型和PRD)</strong></li>
<li>接口设计(基于原型和PRD)</li>
<li>功能实现(基于接口设计+原型+PRD)</li>
<li>前后端联调</li>
<li>测试提bug</li>
<li>前后端优化，再联调</li>
<li>测试回归bug</li>
<li>功能验收</li>
</ul>
<h3 id="如何设计表"><a href="#如何设计表" class="headerlink" title="如何设计表"></a>如何设计表</h3><h4 id="ER图"><a href="#ER图" class="headerlink" title="ER图"></a>ER图</h4><p>E-R图也称实体-联系图(Entity Relationship Diagram)，提供了表示<strong>实体</strong>类型、<strong>属性</strong>和<strong>联系</strong>的方法，用来描述现实世界的概念模型。</p>
<p>一个栗子：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">假设咱们要设计一个简单的图书馆数据库系统。咱们可以使用E-R图来描述这个系统的数据模型</span><br><span class="line">咱们可能会有以下实体（Entities）：</span><br><span class="line"><span class="bullet">-</span> 书籍（Book）</span><br><span class="line"><span class="bullet">-</span> 作者（Author）</span><br><span class="line"><span class="bullet">-</span> 图书馆会员（Library Member）</span><br><span class="line">然后，咱们可以描述它们之间的关系（Relationships）：</span><br><span class="line"><span class="bullet">-</span> 一本书可以由一个或多个作者编写，这是一个&quot;一对多&quot;的关系。</span><br><span class="line"><span class="bullet">-</span> 图书馆成员可以借阅多本书，而每本书也可以被多个图书馆成员借阅，这是一个&quot;多对多&quot;的关系。</span><br><span class="line">最后，咱们可以添加一些属性（Attributes）：</span><br><span class="line"><span class="bullet">-</span> 书籍实体可能包括书名、ISBN号、出版日期等属性。</span><br><span class="line"><span class="bullet">-</span> 作者实体可能包括姓名、国籍、出生日期等属性。</span><br><span class="line"><span class="bullet">-</span> 图书馆成员实体可能包括会员号、姓名、联系信息等属性。</span><br><span class="line">通过E-R图，咱们可以清晰地展示这些实体之间的关系和它们的属性，从而更好地理解图书馆数据库系统的数据模型。</span><br></pre></td></tr></table></figure>

<p>上述例子的E-R图：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (4).png" alt="whiteboard_exported_image (4)"/>



<h4 id="详细设计"><a href="#详细设计" class="headerlink" title="详细设计"></a>详细设计</h4><ul>
<li>命名规则参考阿里开发手册（见名知意）  </li>
<li>数据类型<ul>
<li>基本准则：<ul>
<li>可靠性：考虑字段存储的内容长度，尽可能的合适<ul>
<li>name  30-50</li>
</ul>
</li>
<li>存储空间：在考虑可靠性的前提下，再考虑存储空间</li>
</ul>
</li>
<li>常见数据类型 <a target="_blank" rel="noopener" href="https://rant7bdsfuy.feishu.cn/wiki/TEdRwkWSqiE3QykoYSHcxUWjnid">MySQL常见数据类型</a></li>
</ul>
</li>
<li>主键（必须存在）<ul>
<li>自增</li>
<li>UUID</li>
<li>雪花算法</li>
</ul>
</li>
<li>冗余字段<ul>
<li>创建时间</li>
<li>修改时间</li>
<li>创建人</li>
<li>修改人</li>
<li>备注</li>
<li>要结合业务的情况，再去设计冗余字段（为了提升性能，减少多表查询）</li>
</ul>
</li>
</ul>
<h4 id="建表工具"><a href="#建表工具" class="headerlink" title="建表工具"></a>建表工具</h4><ul>
<li>方式一：传统的数据库连接工具</li>
</ul>
<p>创建表的工具，可以选择使DataGrip或者IDEA中集成的DataGrip工具，协助开发人员来设计表结构</p>
<ul>
<li>方式二：AI协助帮忙创建表结构</li>
</ul>
<p>可以借助AI大模型问答，写对应的提示词来创建表结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">你是一个软件工程师，帮我生成MySQL的表结构，需求如下：</span><br><span class="line">1，入住表（check_in），包含的字段有：主键(ID)，老人id(elder_id)、身份证号、入住开始时间、入住结束时间、护理等级、入住床位、状态（0:已入住、1:已退住）</span><br><span class="line">2，表中其他必要字段：排序编号、创建时间(create_time)、修改时间(update_time)、创建人(create_by)、修改人(update_by)、备注(remark)这些字段</span><br><span class="line">3，表的主键都是自增的</span><br><span class="line">4，请为每个字段都添加上comment</span><br><span class="line">5，帮我给生成的表中插入一些示例数据 </span><br></pre></td></tr></table></figure>



<h3 id="入住相关表结构设计"><a href="#入住相关表结构设计" class="headerlink" title="入住相关表结构设计"></a>入住相关表结构设计</h3><h4 id="表结构的E-R图"><a href="#表结构的E-R图" class="headerlink" title="表结构的E-R图"></a>表结构的E-R图</h4><p>通过需求分析，咱们可以得到以下信息</p>
<ol>
<li>老人的<strong>基本信息</strong>里面的所有字段，都可以存储到老人表中（elder表）</li>
<li>老人关联的<strong>家属</strong>是一个列表</li>
<li>老人选择的<strong>入住配置</strong>字段有很多，可以创建入住表来进行存储</li>
<li><strong>签约办理</strong>相关的内容可以存储到合同表中</li>
</ol>
<p>整体的E-R图结构如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (5).png" alt="whiteboard_exported_image (5)" style="zoom:50%;" />

<p>如果这么设计的话，其中的check_in表的字段就非常的多，将会带来以下问题</p>
<ul>
<li><strong>性能下降</strong>，字段越多，数据库在执行查询时需要处理的数据量就越大，插入和更新尤为明显</li>
<li><strong>维护困难</strong>：字段过多会使得表结构复杂，导致难以理解和维护，同时修改表结构也会变得更加复杂和耗时</li>
<li><strong>存储空间增加</strong>：每个额外的字段，即使大多数情况下为空或数据很少，也会占用额外存储空间，并可能导致数据库备份和恢复操作耗时增加</li>
<li><strong>可扩展性差</strong>：当表结构变得过于复杂时，添加新功能或进行其他类型的扩展可能会变得更加困难</li>
</ul>
<p>为了缓解这些问题，可以考虑以下策略：</p>
<ul>
<li>归档旧数据：将不经常访问的旧数据归档到单独的表中或数据库中</li>
<li>优化数据类型：确保使用适当的数据类型来存储数据，以减少存储空间的浪费并提高性能</li>
<li><strong>垂直分割</strong>：将表垂直分割成多个较小的表，每个表包含相关的字段集</li>
</ul>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (6).png" alt="whiteboard_exported_image (6)" style="zoom:50%;" />

<h4 id="什么是垂直分割"><a href="#什么是垂直分割" class="headerlink" title="什么是垂直分割"></a>什么是垂直分割</h4><p>垂直分割表是数据库管理中常用的一种优化技术，它通过将一个大表中的列分割成多个小表，每个小表包含原始表的一部分列，以达到优化数据存储和访问效率的目的。以下是垂直分割表的优缺点总结：</p>
<p><strong>优点</strong></p>
<ol>
<li>提高查询性能：通过减少表的宽度，可以加快查询速度，特别是在**<font color='red'>涉及大量列的表</font>**中。当查询只需要访问部分列时，数据库系统只需扫描包含这些列的小表，减少了不必要的数据扫描量</li>
<li>减少I&#x2F;O操作：在读取数据时，数据库系统可以只读取需要的列，而无需扫描整个表，从而减少了I&#x2F;O操作的次数和数据传输量</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>增加复杂性：垂直分割表会<strong>增加数据库结构的复杂性</strong>，需要更多的管理和维护工作。例如，需要修改应用程序中的查询和更新操作，以适应新的表结构</li>
<li>事务处理复杂：垂直分割表后，事务的处理可能会变得更加复杂。因为事务可能需要跨越多个子表，这<strong>增加了事务管理的难度和开销</strong></li>
<li>表连接操作增加：由于数据被分散到多个子表中，因此在查询时可能需要更多的<strong>表连接操作</strong>，这可能会增加CPU的开销和查询的响应时间</li>
</ol>
<p>经过垂直分割之后，其中的入住表可以分割为两个表</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (7).png" alt="whiteboard_exported_image (7)" style="zoom:67%;" />

<p>其中列表查询所展示的字段可以认为是经常访问的字段，详情中查看的字段认为是访问较少的字段，由此可以得出：</p>
<table>
<thead>
<tr>
<th align="center"><strong>经常访问的字段</strong></th>
<th align="center"><strong>访问较少的字段</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">ID主键</td>
<td align="center">ID主键</td>
</tr>
<tr>
<td align="center">老人姓名</td>
<td align="center">入住ID</td>
</tr>
<tr>
<td align="center">老人id(elder_id)</td>
<td align="center">护理等级ID</td>
</tr>
<tr>
<td align="center">身份证号</td>
<td align="center">护理等级名称</td>
</tr>
<tr>
<td align="center">入住开始时间</td>
<td align="center">入住床位</td>
</tr>
<tr>
<td align="center">入住结束时间</td>
<td align="center">费用开始时间</td>
</tr>
<tr>
<td align="center">护理等级名称</td>
<td align="center">费用结束时间</td>
</tr>
<tr>
<td align="center">入住床位</td>
<td align="center">押金（元）</td>
</tr>
<tr>
<td align="center">状态（0:已入住、1:已退住）</td>
<td align="center">护理费用（元&#x2F;月）</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">床位费用（元&#x2F;月）</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">医保支付（元&#x2F;月）</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">政府补贴（元&#x2F;月）</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">其他费用（元&#x2F;月）</td>
</tr>
</tbody></table>
<p>其中在经常访问的字段中，有一些<strong>冗余</strong>字段：</p>
<ul>
<li>老人姓名（elder表中存在）</li>
<li>身份证号（elder表中存在）</li>
<li>护理等级名称（check_in_config表中存在）</li>
<li>入住床位（check_in_config表中存在）</li>
</ul>
<blockquote>
<p>在设计数据库表时，引入<strong>冗余字段</strong>是一种常见的优化手段，主要目的：</p>
<ol>
<li>冗余字段减少查询时的表连接操作，降低查询复杂性和执行时间</li>
<li>冗余字段<strong>简化查询逻辑</strong>，使查询语句更简洁易懂，易于维护和减少出错概率</li>
</ol>
</blockquote>
<h4 id="最终表结构"><a href="#最终表结构" class="headerlink" title="最终表结构"></a>最终表结构</h4><img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (8).png" alt="whiteboard_exported_image (8)" style="zoom:67%;" />

<ul>
<li>上图中的四张表的关系都是一对一的关系</li>
<li>废弃了老人家属表，由于老人家属信息主要用于回显展示，可以以json格式存储到入住表中的remark字段中</li>
</ul>
<p>根据之前的分析结合需求文档，可以使用AI协助创建表结构，共为三张表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">你是一个软件工程师，帮我生成MySQL的表结构，需求如下：</span><br><span class="line">1，入住表（check_in），包含的字段有：主键(ID)，老人姓名(elder_name)、老人id(elder_id)、身份证号(id_card_no)、入住开始时间、入住结束时间、护理等级名称(nursing_level_name)、入住床位、状态（0:已入住、1:已退住）</span><br><span class="line">2，入住配置表(check_in_config)，包含的字段有：主键(ID)，入住表ID、护理等级ID(nursing_level_id)、护理等级名称(nursing_level_name)、费用开始时间、费用结束时间、押金（元）、护理费用（元/月）、床位费用（元/月）、医保支付（元/月）、政府补贴（元/月）、其他费用（元/月）</span><br><span class="line">其他要求：</span><br><span class="line">1，表中其他必要字段：排序编号、创建时间(create_time)、修改时间(update_time)、创建人(create_by)、修改人(update_by)、备注(remark)这些字段</span><br><span class="line">2，入住表和入住配置表是一对一的关系，不需要设置外键约束</span><br><span class="line">3，表的主键都是自增的，类型为bigint</span><br><span class="line">4，请为每个字段都添加上comment</span><br><span class="line">5，帮我给生成的表中插入一些示例数据</span><br></pre></td></tr></table></figure>



<p>最终生成的SQL语句为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `check_in` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `elder_name` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;老人姓名&#x27;</span>,</span><br><span class="line">  `elder_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;老人ID&#x27;</span>,</span><br><span class="line">  `id_card_no` <span class="type">CHAR</span>(<span class="number">18</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;身份证号&#x27;</span>,</span><br><span class="line">  `start_date` <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;入住开始时间&#x27;</span>,</span><br><span class="line">  `end_date` <span class="type">DATE</span> COMMENT <span class="string">&#x27;入住结束时间&#x27;</span>,</span><br><span class="line">  `nursing_level_name` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;护理等级名称&#x27;</span>,</span><br><span class="line">  `bed_number` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;入住床位&#x27;</span>,</span><br><span class="line">  `status` TINYINT <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态 (0: 已入住, 1: 已退住)&#x27;</span>,</span><br><span class="line">  `sort_order` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;排序编号&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `create_by` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">  `update_by` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">  `remark` <span class="type">VARCHAR</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `check_in_config` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `check_in_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;入住表ID&#x27;</span>,</span><br><span class="line">  `nursing_level_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;护理等级ID&#x27;</span>,</span><br><span class="line">  `nursing_level_name` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;护理等级名称&#x27;</span>,</span><br><span class="line">  `fee_start_date` <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;费用开始时间&#x27;</span>,</span><br><span class="line">  `fee_end_date` <span class="type">DATE</span> COMMENT <span class="string">&#x27;费用结束时间&#x27;</span>,</span><br><span class="line">  `deposit` <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;押金（元）&#x27;</span>,</span><br><span class="line">  `nursing_fee` <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;护理费用（元/月）&#x27;</span>,</span><br><span class="line">  `bed_fee` <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;床位费用（元/月）&#x27;</span>,</span><br><span class="line">  `insurance_payment` <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;医保支付（元/月）&#x27;</span>,</span><br><span class="line">  `government_subsidy` <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;政府补贴（元/月）&#x27;</span>,</span><br><span class="line">  `other_fees` <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;其他费用（元/月）&#x27;</span>,</span><br><span class="line">  `sort_order` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;排序编号&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `create_by` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">  `update_by` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">  `remark` <span class="type">VARCHAR</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>



<p>老人表已经存在了，接下来使用AI生成<strong>合同表</strong>，提示词如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">你是一个软件工程师，帮我生成MySQL的表结构，需求如下：</span><br><span class="line">1，合同表（contract），包含的字段有：主键(ID)，老人id(elder_id)、合同名称、合同编号、协议地址、丙方手机号、丙方姓名、老人姓名、开始时间、结束时间、状态(status   0：未生效，1：已生效，2：已过期, 3：已失效)、签约日期、解除提交人、解除日期、解除协议地址</span><br><span class="line">2，表中其他必要字段：排序编号、创建时间(create_time)、修改时间(update_time)、创建人(create_by)、修改人(update_by)、备注(remark)这些字段，这些字段默认为null</span><br><span class="line">3，表的主键都是自增的，类型为bigint</span><br><span class="line">4，请为每个字段都添加上comment</span><br><span class="line">5，帮我给生成的表中插入一些示例数据</span><br></pre></td></tr></table></figure>

<p>最终生成的SQL语句为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `contract` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `elder_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;老人ID&#x27;</span>,</span><br><span class="line">  `contract_name` <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;合同名称&#x27;</span>,</span><br><span class="line">  `contract_number` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;合同编号&#x27;</span>,</span><br><span class="line">  `agreement_path` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;协议地址（文件路径或URL）&#x27;</span>,</span><br><span class="line">  `third_party_phone` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;丙方手机号&#x27;</span>,</span><br><span class="line">  `third_party_name` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;丙方姓名&#x27;</span>,</span><br><span class="line">  `elder_name` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;老人姓名&#x27;</span>,</span><br><span class="line">  `start_date` <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;开始时间&#x27;</span>,</span><br><span class="line">  `end_date` <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;结束时间&#x27;</span>,</span><br><span class="line">  `status` TINYINT <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态 (0: 未生效, 1: 已生效, 2: 已过期, 3: 已失效)&#x27;</span>,</span><br><span class="line">  `sign_date` <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;签约日期&#x27;</span>,</span><br><span class="line">  `termination_submitter` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;解除提交人&#x27;</span>,</span><br><span class="line">  `termination_date` <span class="type">DATE</span> COMMENT <span class="string">&#x27;解除日期&#x27;</span>,</span><br><span class="line">  `termination_agreement_path` <span class="type">VARCHAR</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;解除协议地址（文件路径或URL）&#x27;</span>,</span><br><span class="line">  `sort_order` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;排序编号&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `create_by` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">  `update_by` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">  `remark` <span class="type">VARCHAR</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>



<p>其他修改：由于AI生成的字段都要求是必填的，这样在后期操作数据的时候有很多的限制，咱们可以通过数据库连接工具调整一下</p>
<p>重点调整的字段：sort_order、create_time、update_time、create_by、update_by、remark</p>
<p><img src="/img/loading.gif" data-original="/img/assests/dd29d1ae-147c-491b-925b-4dfecd82af4d.png" alt="dd29d1ae-147c-491b-925b-4dfecd82af4d"></p>
<h2 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h2><h3 id="接口四要素"><a href="#接口四要素" class="headerlink" title="接口四要素"></a>接口四要素</h3><p>搞明白需求之后，下面就可以来设计接口了，一个接口包含了四个基本要素，分别是：请求路径、请求方式、接口入参、接口出参</p>
<ul>
<li><strong>请求路径</strong> 命名：以模块名称进行区分（英文）</li>
<li><strong>请求方式（需要符合restful风格）</strong><ul>
<li>查询  GET</li>
<li>新增 POST</li>
<li>修改 PUT</li>
<li>删除 DELETE</li>
</ul>
</li>
<li>接口入参<ul>
<li>路径中的参数<ul>
<li>问号传参—-&gt;后端形参接收</li>
<li>path传参—-&gt;后端PathVariable注解接收</li>
</ul>
</li>
<li>请求体中的参数<ul>
<li>前端：json对象</li>
<li>后端：对象接收，DTO</li>
</ul>
</li>
</ul>
</li>
<li>接口出参<ul>
<li>统一格式 <code>&#123;code:200,msg:&quot;成功&quot;,data:&#123;&#125;&#125;</code></li>
<li>数据封装，一般为VO<ul>
<li>敏感数据过滤</li>
<li>整合数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h3><p>测试工具有很多，以下几个是比较常见的接口测试工具</p>
<ul>
<li>Postman</li>
<li>ApiPost</li>
<li>Apifox</li>
<li>Swagger   在线接口文档</li>
<li>Knife4j     对swagger的增强，可生成离线接口文档</li>
</ul>
<blockquote>
<p>使用postman或者apifox工具测试接口，需要知道明确的接口信息</p>
</blockquote>
<h3 id="入住相关的接口"><a href="#入住相关的接口" class="headerlink" title="入住相关的接口"></a>入住相关的接口</h3><p>接口文档：<a target="_blank" rel="noopener" href="https://rant7bdsfuy.feishu.cn/wiki/MWrYwiZ48iublnkWIVwcWYmanWb">入退管理-接口文档</a></p>
<p>入住办理这个模块中共6个接口，分别是：</p>
<ol>
<li>分页查询入住列表<ol>
<li>请求方式：GET</li>
<li>参数：分页条件查询（elderName、idNumber、pageNum、pageSize）</li>
<li>响应结果：参考若依框架定义的分页对象：<code>&#123;total:120,rows:[],code:200,msg:成功或失败&#125;</code></li>
</ol>
</li>
</ol>
<p><img src="/img/loading.gif" data-original="/img/assests/dd1300a5-76ef-45ef-b8cc-7b8a4b03468e.png" alt="dd1300a5-76ef-45ef-b8cc-7b8a4b03468e"></p>
<ol start="2">
<li><p>查询所有护理等级信息</p>
<ul>
<li><p>请求方式：GET</p>
</li>
<li><p>参数：无</p>
</li>
<li><p>响应结果：参考若依框架定义的普通返回对象：<code>&#123;msg:成功或失败,code:200,data:[]&#125;</code></p>
</li>
</ul>
</li>
</ol>
<p><img src="/img/loading.gif" data-original="/img/assests/7a7a0385-afe3-46af-8ee0-ef8f6abad910.png" alt="7a7a0385-afe3-46af-8ee0-ef8f6abad910"></p>
<p>选择护理等级之后，可以自动填充<strong>护理费用</strong></p>
<p><img src="/img/loading.gif" data-original="/img/assests/95cacb25-ef5a-4698-9083-47b0668b234e.png" alt="95cacb25-ef5a-4698-9083-47b0668b234e"></p>
<ol start="3">
<li><p>根据床位状态查询所有楼层数据</p>
<ul>
<li><p>请求方式：GET</p>
</li>
<li><p>参数：status(比较通用，只查询未入住的床位)</p>
</li>
<li><p>响应结果：参考若依框架定义的普通返回对象：<code>&#123;msg:成功或失败,code:200,data:[]&#125;</code></p>
</li>
</ul>
</li>
</ol>
<p><img src="/img/loading.gif" data-original="/img/assests/c8fb6f41-fdb9-40cb-8de6-61ec4230caeb.png" alt="c8fb6f41-fdb9-40cb-8de6-61ec4230caeb"></p>
<ol start="4">
<li><p>查询房间数据（楼层、房间、价格）</p>
<ul>
<li><p>请求方式：GET</p>
</li>
<li><p>参数：选择之后的房间ID(房间可以决定床位价格)</p>
</li>
<li><p>响应结果：参考若依框架定义的普通返回对象：<code>&#123;msg:成功或失败,code:200,data:&#123;&#125;&#125;</code></p>
</li>
</ul>
</li>
</ol>
<p><img src="/img/loading.gif" data-original="/img/assests/efab6561-8bcb-48e4-a668-ebebe1e97a78.png" alt="efab6561-8bcb-48e4-a668-ebebe1e97a78"></p>
<ol start="5">
<li><p>申请入住</p>
<ul>
<li><p>填写入住信息之后，提交表单数据，进行保存，需要涉及到多张表(老人表、入住表、入住配置表、合同表)</p>
</li>
<li><p>请求方式：POST</p>
</li>
<li><p>参数：请求体数据，表单中的所有数据</p>
</li>
<li><p>响应结果：参考若依框架定义的普通返回对象：<code>&#123;msg:成功或失败,code:200&#125;</code></p>
</li>
</ul>
</li>
<li><p>查询入住详情</p>
<ul>
<li><p>请求方式：GET</p>
</li>
<li><p>参数：入口在入住列表查询，可以传入入住ID</p>
</li>
<li><p>响应结果：参考若依框架定义的普通返回对象：<code>&#123;msg:成功或失败,code:200,data:&#123;&#125;&#125;</code></p>
</li>
</ul>
</li>
</ol>
<p><img src="/img/loading.gif" data-original="/img/assests/b21890a9-3c7e-4bf8-9257-50ee035b574a.png" alt="b21890a9-3c7e-4bf8-9257-50ee035b574a"></p>
<h2 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a>接口开发</h2><p>通过若依的代码生成，根据之前创建的四张表（elder、contract、check_in、check_in_config）生成代码，生成前先确保生成配置是否正确</p>
<p>生成完毕后，<strong>不需要调整前端代码</strong>，只要将生成的后端代码移动到当前项目中，以下是提供的测试数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `check_in`(`end_date`,`id_card_no`,`nursing_level_name`,`create_time`,`remark`,`elder_id`,`create_by`,`update_time`,`elder_name`,`id`,`bed_number`,`sort_order`,`start_date`,`status`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2024-09-30&#x27;</span>,<span class="string">&#x27;132123196712131234&#x27;</span>,<span class="string">&#x27;测试护理等级&#x27;</span>,<span class="string">&#x27;2024-08-27 16:43:20.0&#x27;</span>,<span class="string">&#x27;[&#123;&quot;kinship&quot;:&quot;1&quot;,&quot;name&quot;:&quot;13211223322&quot;,&quot;phone&quot;:&quot;13211223322&quot;&#125;]&#x27;</span>,<span class="number">325</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2024-08-27 08:43:19.0&#x27;</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;104-1&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;2024-08-27&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `check_in`(`end_date`,`id_card_no`,`nursing_level_name`,`create_time`,`remark`,`elder_id`,`create_by`,`update_time`,`elder_name`,`id`,`bed_number`,`sort_order`,`start_date`,`status`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2024-09-30&#x27;</span>,<span class="string">&#x27;132123196712131239&#x27;</span>,<span class="string">&#x27;1号护理计划&#x27;</span>,<span class="string">&#x27;2024-08-27 16:50:09.0&#x27;</span>,<span class="string">&#x27;[&#123;&quot;kinship&quot;:&quot;0&quot;,&quot;name&quot;:&quot;李天&quot;,&quot;phone&quot;:&quot;13222334439&quot;&#125;]&#x27;</span>,<span class="number">326</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2024-08-27 08:50:08.0&#x27;</span>,<span class="string">&#x27;李天龙&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;104-2&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;2024-08-27&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `check_in`(`end_date`,`id_card_no`,`nursing_level_name`,`create_time`,`remark`,`elder_id`,`create_by`,`update_time`,`elder_name`,`id`,`bed_number`,`sort_order`,`start_date`,`status`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2024-10-31&#x27;</span>,<span class="string">&#x27;132123195612132345&#x27;</span>,<span class="string">&#x27;2号护理等级&#x27;</span>,<span class="string">&#x27;2024-09-12 18:51:36.0&#x27;</span>,<span class="string">&#x27;[&#123;&quot;kinship&quot;:&quot;1&quot;,&quot;name&quot;:&quot;小李&quot;,&quot;phone&quot;:&quot;13212349900&quot;&#125;]&#x27;</span>,<span class="number">327</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2024-09-12 18:51:36.0&#x27;</span>,<span class="string">&#x27;老李&#x27;</span>,<span class="number">3</span>,<span class="string">&#x27;101-2&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;2024-09-12&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `check_in`(`end_date`,`id_card_no`,`nursing_level_name`,`create_time`,`remark`,`elder_id`,`create_by`,`update_time`,`elder_name`,`id`,`bed_number`,`sort_order`,`start_date`,`status`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2024-10-31&#x27;</span>,<span class="string">&#x27;410725196904056698&#x27;</span>,<span class="string">&#x27;2号护理等级&#x27;</span>,<span class="string">&#x27;2024-09-12 19:10:23.0&#x27;</span>,<span class="string">&#x27;[&#123;&quot;kinship&quot;:&quot;0&quot;,&quot;name&quot;:&quot;老王&quot;,&quot;phone&quot;:&quot;15100000002&quot;&#125;]&#x27;</span>,<span class="number">328</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2024-09-12 19:10:23.0&#x27;</span>,<span class="string">&#x27;老李头儿&#x27;</span>,<span class="number">4</span>,<span class="string">&#x27;101-1&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;2024-09-12&#x27;</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>插入数据后，重启项目并访问入住办理页面</p>
<h3 id="查询所有护理等级列表"><a href="#查询所有护理等级列表" class="headerlink" title="查询所有护理等级列表"></a>查询所有护理等级列表</h3><h4 id="控制层"><a href="#控制层" class="headerlink" title="控制层"></a>控制层</h4><p>基于接口文档的定义，在NursingLevelController定义新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;获取所有护理等级&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R&lt;List&lt;NursingLevel&gt;&gt; <span class="title function_">listAll</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;NursingLevel&gt; list = nursingLevelService.listAll();</span><br><span class="line">    <span class="keyword">return</span> R.ok(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Service层"><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有护理等级</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  护理等级列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;NursingLevel&gt; <span class="title function_">listAll</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Service层实现类"><a href="#Service层实现类" class="headerlink" title="Service层实现类"></a>Service层实现类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有护理等级 </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 护理等级列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;NursingLevel&gt; <span class="title function_">listAll</span><span class="params">()</span> &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;NursingLevel&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(NursingLevel::getStatus, <span class="number">1</span>);</span><br><span class="line">    List&lt;NursingLevel&gt; list = list(queryWrapper);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="根据床位状态查询所有楼层数据"><a href="#根据床位状态查询所有楼层数据" class="headerlink" title="根据床位状态查询所有楼层数据"></a>根据床位状态查询所有楼层数据</h3><h4 id="思路说明"><a href="#思路说明" class="headerlink" title="思路说明"></a>思路说明</h4><p>最终的效果图如下：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/c8fb6f41-fdb9-40cb-8de6-61ec4230caeb.png" alt="c8fb6f41-fdb9-40cb-8de6-61ec4230caeb"></p>
<p>结合<strong>接口文档的数据结构</strong>，这个接口需要查询三张表的数据，分别是<strong>楼层表、房间表、床位表</strong>，它们的关系如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (9).png" alt="whiteboard_exported_image (9)" style="zoom:67%;" />

<h4 id="控制层-1"><a href="#控制层-1" class="headerlink" title="控制层"></a>控制层</h4><p>在FloorController中定义新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getRoomAndBedByBedStatus/&#123;status&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;按照状态查询楼层房间床位-树形结构&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R&lt;List&lt;TreeVo&gt;&gt; <span class="title function_">getRoomAndBedByBedStatus</span><span class="params">(<span class="meta">@ApiParam(value = &quot;床位状态(未入住0, 已入住1)&quot;, required = true)</span> <span class="meta">@PathVariable(&quot;status&quot;)</span> Integer status)</span> &#123;</span><br><span class="line">    List&lt;TreeVo&gt; list = floorService.getRoomAndBedByBedStatus(status);</span><br><span class="line">    <span class="keyword">return</span> R.ok(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TreeVo(需要结合着接口文档的数据结构来编写vo类)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.vo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;树形结构VO&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeVo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 菜单ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;菜单ID&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 菜单名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;菜单名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String label;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 子菜单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;子菜单&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;TreeVo&gt; children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="业务层"><a href="#业务层" class="headerlink" title="业务层"></a>业务层</h4><p>在IFloorService中定义新的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据状态获取房间和床位信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status    状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>          结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;TreeVo&gt; <span class="title function_">getRoomAndBedByBedStatus</span><span class="params">(Integer status)</span>;</span><br></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据状态获取房间和床位信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status 状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;TreeVo&gt; <span class="title function_">getRoomAndBedByBedStatus</span><span class="params">(Integer status)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> floorMapper.getRoomAndBedByBedStatus(status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="持久层（重点）"><a href="#持久层（重点）" class="headerlink" title="持久层（重点）"></a>持久层（重点）</h4><p>在FloorMapper中定义查询的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;TreeVo&gt; <span class="title function_">getRoomAndBedByBedStatus</span><span class="params">(Integer status)</span>;</span><br></pre></td></tr></table></figure>

<p>xml映射文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;TreeVoResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.zzyl.nursing.vo.TreeVo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;fid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;value&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span> <span class="attr">property</span>=<span class="string">&quot;label&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;children&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;com.zzyl.nursing.vo.TreeVo&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;rid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;value&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;code&quot;</span> <span class="attr">property</span>=<span class="string">&quot;label&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;children&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;com.zzyl.nursing.vo.TreeVo&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;bid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;value&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;bed_number&quot;</span> <span class="attr">property</span>=<span class="string">&quot;label&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRoomAndBedByBedStatus&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;TreeVoResultMap&quot;</span>&gt;</span></span><br><span class="line">    select f.id fid, f.name, r.id rid, r.code, b.id bid, b.bed_number</span><br><span class="line">    from floor f</span><br><span class="line">             left join room r on f.id = r.floor_id</span><br><span class="line">             left join bed b on r.id = b.room_id</span><br><span class="line">    where b.bed_status = #&#123;status&#125;</span><br><span class="line">    order by f.id, r.id, b.id</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="根据房间id查询房间数据（楼层、房间、价格）"><a href="#根据房间id查询房间数据（楼层、房间、价格）" class="headerlink" title="根据房间id查询房间数据（楼层、房间、价格）"></a>根据房间id查询房间数据（楼层、房间、价格）</h3><h4 id="思路说明-1"><a href="#思路说明-1" class="headerlink" title="思路说明"></a>思路说明</h4><p>效果图：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/df4b14f4-acba-4f3b-8a3f-3683ad373741.png" alt="df4b14f4-acba-4f3b-8a3f-3683ad373741"></p>
<p>当选择了某一个床位之后，需要根据床位所在的房间，查询所匹配的价格，结合接口文档的返回结果来分析，这里面涉及到了3张表：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (10).png" alt="whiteboard_exported_image (10)" style="zoom:67%;" />

<h4 id="控制层-2"><a href="#控制层-2" class="headerlink" title="控制层"></a>控制层</h4><p>在RoomController中定义新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/one/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;按照房间id查询楼层、房间、价格&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R&lt;RoomVo&gt; <span class="title function_">getRoomById</span><span class="params">(<span class="meta">@ApiParam(value = &quot;房间ID&quot;, required = true)</span> <span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">    <span class="type">RoomVo</span> <span class="variable">roomVo</span> <span class="operator">=</span> roomService.getRoomById(id);</span><br><span class="line">    <span class="keyword">return</span> R.ok(roomVo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RoomVo在代码中已提供，符合接口返回的要求</p>
<h4 id="业务层-1"><a href="#业务层-1" class="headerlink" title="业务层"></a>业务层</h4><p>在IRoomService中定义新的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按照房间id查询楼层、房间、价格</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RoomVo <span class="title function_">getRoomById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按照房间id查询楼层、房间、价格</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RoomVo <span class="title function_">getRoomById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> roomMapper.getRoomById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="持久层（重点）-1"><a href="#持久层（重点）-1" class="headerlink" title="持久层（重点）"></a>持久层（重点）</h4><p>在RoomMapper中定义新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RoomVo <span class="title function_">getRoomById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>

<p>xml映射文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRoomById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.zzyl.nursing.vo.RoomVo&quot;</span>&gt;</span></span><br><span class="line">    select f.name floorName, f.id floorId, r.id roomId, r.code, rt.price</span><br><span class="line">    from floor f left join room r on f.id = r.floor_id</span><br><span class="line">                 left join room_type rt on rt.name = r.type_name</span><br><span class="line">    where r.id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="申请入住"><a href="#申请入住" class="headerlink" title="申请入住"></a>申请入住</h3><h4 id="控制层-3"><a href="#控制层-3" class="headerlink" title="控制层"></a>控制层</h4><p>在CheckInController中定义申请入住的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/apply&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">apply</span><span class="params">(<span class="meta">@RequestBody</span> CheckInApplyDto dto)</span>&#123;</span><br><span class="line">    checkInService.apply(dto);</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于接口的入参分析，需要定义多个dto来接收参数。可以自己根据接口文档定义类来接收数据，也可以使用AI大模型，基于json格式的请求数据生成java类来接收数据</p>
<p>基本的结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheckInApplyDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 老人信息</span></span><br><span class="line">    <span class="keyword">private</span> CheckInElderDto checkInElderDto;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 家属信息</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ElderFamilyDto&gt; elderFamilyDtoList;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 入住配置</span></span><br><span class="line">    <span class="keyword">private</span> CheckInConfigDto checkInConfigDto;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 签约办理</span></span><br><span class="line">    <span class="keyword">private</span> CheckInContractDto checkInContractDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：属性名称要与json结构中保持一致</strong></p>
<h4 id="业务层（重点）"><a href="#业务层（重点）" class="headerlink" title="业务层（重点）"></a>业务层（重点）</h4><p>在ICheckInService中定义新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 申请入住</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> checkInApplyDto</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(CheckInApplyDto checkInApplyDto)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>思路说明</strong></p>
<p>申请入住的流程较长，涉及到多张表的操作，流程如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (15).png" alt="whiteboard_exported_image (15)" style="zoom:50%;" />



<h2 id="接口添加缓存"><a href="#接口添加缓存" class="headerlink" title="接口添加缓存"></a>接口添加缓存</h2><p>下图分析了各个接口的情况，重点标明了哪些接口推荐使用缓存</p>
<table>
<thead>
<tr>
<th><strong>接口名称</strong></th>
<th><strong>是否需要使用缓存</strong></th>
<th><strong>理由</strong></th>
</tr>
</thead>
<tbody><tr>
<td>分页查询入住列表</td>
<td>否</td>
<td>不涉及多表，量也不大</td>
</tr>
<tr>
<td>查询所有护理等级</td>
<td>是</td>
<td>组件加载需要查询，有效率要求，并且是检索表中所有数据</td>
</tr>
<tr>
<td>根据床位状态查询树形数据</td>
<td>否</td>
<td>经常性的有<strong>写操作</strong>（比如：老人入住后需要更新床位状态）</td>
</tr>
<tr>
<td>查询房间价格等数据</td>
<td>是</td>
<td>可以添加，涉及到多表查询</td>
</tr>
<tr>
<td>申请入住</td>
<td>否</td>
<td>新增，不是查询</td>
</tr>
<tr>
<td>查询入住详情</td>
<td>否</td>
<td>并非高频访问</td>
</tr>
</tbody></table>
<h3 id="护理等级添加缓存"><a href="#护理等级添加缓存" class="headerlink" title="护理等级添加缓存"></a>护理等级添加缓存</h3><p>在护理等级中添加缓存基本思路如下：</p>
<ul>
<li>查询所有护理等级的时候，<strong>先到缓存查，缓存有则返回，缓存没有则查数据库，同时放到缓存中</strong></li>
<li>增删改操作之后，需要删除缓存</li>
<li>需要修改NursingLevelServiceImpl类中的方法，详细代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.common.utils.DateUtils;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.vo.NursingLevelVo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.mapper.NursingLevelMapper;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.domain.NursingLevel;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.service.INursingLevelService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 护理等级Service业务层处理</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-09-07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NursingLevelServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">INursingLevelService</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NursingLevelMapper nursingLevelMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;nursingLevel:all&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询护理等级</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 护理等级主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 护理等级</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> NursingLevel <span class="title function_">selectNursingLevelById</span><span class="params">(Long id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> nursingLevelMapper.selectNursingLevelById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询护理等级列表</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nursingLevel 护理等级</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 护理等级</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;NursingLevelVo&gt; <span class="title function_">selectNursingLevelList</span><span class="params">(NursingLevel nursingLevel)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> nursingLevelMapper.selectNursingLevelList(nursingLevel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增护理等级</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nursingLevel 护理等级</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insertNursingLevel</span><span class="params">(NursingLevel nursingLevel)</span></span><br><span class="line">    &#123;</span><br><span class="line">        nursingLevel.setCreateTime(DateUtils.getNowDate());</span><br><span class="line">        <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> nursingLevelMapper.insertNursingLevel(nursingLevel);</span><br><span class="line">        <span class="comment">// 删除缓存</span></span><br><span class="line">        deleteCache();</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 删除缓存</span></span><br><span class="line">        redisTemplate.delete(CACHE_KEY_PREFIX);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改护理等级</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nursingLevel 护理等级</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateNursingLevel</span><span class="params">(NursingLevel nursingLevel)</span></span><br><span class="line">    &#123;</span><br><span class="line">        nursingLevel.setUpdateTime(DateUtils.getNowDate());</span><br><span class="line">        <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span>  nursingLevelMapper.updateNursingLevel(nursingLevel);</span><br><span class="line">        deleteCache();</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除护理等级</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids 需要删除的护理等级主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteNursingLevelByIds</span><span class="params">(Long[] ids)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> nursingLevelMapper.deleteNursingLevelByIds(ids);</span><br><span class="line">        deleteCache();</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除护理等级信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 护理等级主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteNursingLevelById</span><span class="params">(Long id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> nursingLevelMapper.deleteNursingLevelById(id);</span><br><span class="line">        deleteCache();</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有护理等级</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;NursingLevel&gt; <span class="title function_">listAll</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从缓存中获取</span></span><br><span class="line">        List&lt;NursingLevel&gt; list = (List&lt;NursingLevel&gt;) redisTemplate.opsForValue().get(CACHE_KEY_PREFIX);</span><br><span class="line">        <span class="comment">// 缓存中有数据，直接返回</span></span><br><span class="line">        <span class="keyword">if</span>(list != <span class="literal">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 缓存中没有数据，从数据库中查询</span></span><br><span class="line">        list = nursingLevelMapper.listAll();</span><br><span class="line">        <span class="comment">// 将数据写入缓存</span></span><br><span class="line">        redisTemplate.opsForValue().set(CACHE_KEY_PREFIX, list);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="智能评估"><a href="#智能评估" class="headerlink" title="智能评估"></a>智能评估</h1><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h2><p><strong>健康评估</strong>是指老人办理入住前需上传体检报告，由AI自动进行分析，并对报告进行总结，同时给出合理的建议；</p>
<p>下图是健康评估列表页，展示了经过健康评估的老人列表</p>
<p><img src="/img/loading.gif" data-original="/img/assests/fe930de2-cd7e-4db5-b993-df8f649a87d1.png" alt="fe930de2-cd7e-4db5-b993-df8f649a87d1"></p>
<p>当点击了<strong>上传体检报告</strong>按钮之后会弹窗，效果如下，需要输入信息，需要提前准备好老人的体检报告(<strong>PDF格式</strong>)</p>
<p>点击<strong>确定</strong>按钮之后，会使用AI对老人的健康报告进行评估</p>
<p><img src="/img/loading.gif" data-original="/img/assests/382969c7-389f-43f8-ab19-d9f26778f213.png" alt="382969c7-389f-43f8-ab19-d9f26778f213"></p>
<p>下图是健康评估的详情页面，是使用AI分析后的结果页，给了很多的数据，可以让护理员或销售人员来查看老人的健康状况，进一步更好的服务老人或者给老人推荐一些护理服务</p>
<p><img src="/img/loading.gif" data-original="/img/assests/6d17b68c-de02-42f4-9709-695cdd7865a2.png" alt="6d17b68c-de02-42f4-9709-695cdd7865a2"></p>
<h2 id="表结构说明"><a href="#表结构说明" class="headerlink" title="表结构说明"></a>表结构说明</h2><p>基于需求原型，设计出的健康评估表（health_assessment）如下：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/4c6e996c-9448-4e97-af45-fb678ccf8297.png" alt="4c6e996c-9448-4e97-af45-fb678ccf8297"></p>
<blockquote>
<p>特别字段说明：</p>
<ul>
<li>abnormal_analysis(异常分析) 这个字段是字符串类型，会把异常数据转换为json进行存储</li>
</ul>
</blockquote>
<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> &quot;health_assessment&quot; (</span><br><span class="line">  &quot;id&quot; <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  &quot;elder_name&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;老人姓名&#x27;</span>,</span><br><span class="line">  &quot;id_card&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;身份证号&#x27;</span>,</span><br><span class="line">  &quot;birth_date&quot; datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;出生日期&#x27;</span>,</span><br><span class="line">  &quot;age&quot; <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  &quot;gender&quot; <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别(0:男，1:女)&#x27;</span>,</span><br><span class="line">  &quot;health_score&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;健康评分&#x27;</span>,</span><br><span class="line">  &quot;risk_level&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;危险等级(健康, 提示, 风险, 危险, 严重危险)&#x27;</span>,</span><br><span class="line">  &quot;suggestion_for_admission&quot; <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否建议入住(0:建议，1:不建议)&#x27;</span>,</span><br><span class="line">  &quot;nursing_level_name&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;推荐护理等级&#x27;</span>,</span><br><span class="line">  &quot;admission_status&quot; <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;入住情况(0:已入住，1:未入住)&#x27;</span>,</span><br><span class="line">  &quot;total_check_date&quot; <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总检日期&#x27;</span>,</span><br><span class="line">  &quot;physical_exam_institution&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;体检机构&#x27;</span>,</span><br><span class="line">  &quot;physical_report_url&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;体检报告URL链接&#x27;</span>,</span><br><span class="line">  &quot;assessment_time&quot; datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;评估时间&#x27;</span>,</span><br><span class="line">  &quot;report_summary&quot; text COMMENT <span class="string">&#x27;报告总结&#x27;</span>,</span><br><span class="line">  &quot;disease_risk&quot; text COMMENT <span class="string">&#x27;疾病风险&#x27;</span>,</span><br><span class="line">  &quot;abnormal_analysis&quot; text COMMENT <span class="string">&#x27;异常分析&#x27;</span>,</span><br><span class="line">  &quot;system_score&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;健康系统分值&#x27;</span>,</span><br><span class="line">  &quot;create_by&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建者&#x27;</span>,</span><br><span class="line">  &quot;create_time&quot; datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  &quot;update_by&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新者&#x27;</span>,</span><br><span class="line">  &quot;update_time&quot; datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  &quot;remark&quot; text COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (&quot;id&quot;)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">7</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci COMMENT<span class="operator">=</span><span class="string">&#x27;健康评估表&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h2 id="接口说明"><a href="#接口说明" class="headerlink" title="接口说明"></a>接口说明</h2><p>基于需求说明，在健康评估这个模块中，共有4个接口需要开发，分别是</p>
<ul>
<li>列表查询</li>
<li>上传体检报告</li>
<li>智能评测</li>
<li>查看详情</li>
</ul>
<p>前端代码已经全部提供（<a target="_blank" rel="noopener" href="https://gitee.com/alexisyang/zznursing-vue3/tree/dev06-init/">zznursing-vue3</a>），所以要结合接口文档开发后端代码</p>
<p>关于健康评估的接口文档，参考链接：<a target="_blank" rel="noopener" href="https://rant7bdsfuy.feishu.cn/wiki/MWrYwiZ48iublnkWIVwcWYmanWb">入退管理-接口文档</a></p>
<h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><p>整体实现流程如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (16).png" alt="whiteboard_exported_image (16)" style="zoom:50%;" />



<h2 id="读取PDF文件内容"><a href="#读取PDF文件内容" class="headerlink" title="读取PDF文件内容"></a>读取PDF文件内容</h2><p><code>Apache PDFBox</code>库是一个用于处理PDF文档的开源Java工具。该项目允许创建新的PDF文档，编辑现有的文档，以及从文档中提取内容</p>
<p>导入对应的依赖，在zzyl-common模块中导入以下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.pdfbox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pdfbox<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>创建工具类，通过pdf文件来读取内容，工具类路径：zzyl-common模块下的com.zzyl.common.utils.PDFUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.common.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.pdfbox.pdmodel.PDDocument;</span><br><span class="line"><span class="keyword">import</span> org.apache.pdfbox.text.PDFTextStripper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PDFUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">pdfToString</span><span class="params">(InputStream inputStream)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">PDDocument</span> <span class="variable">document</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 加载PDF文档</span></span><br><span class="line">            document = PDDocument.load(inputStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建一个PDFTextStripper实例来提取文本</span></span><br><span class="line">            <span class="type">PDFTextStripper</span> <span class="variable">pdfStripper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PDFTextStripper</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从PDF文档中提取文本</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> pdfStripper.getText(document);</span><br><span class="line">            <span class="keyword">return</span> text;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭PDF文档</span></span><br><span class="line">            <span class="keyword">if</span> (document != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    document.close();</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="百度千帆大模型"><a href="#百度千帆大模型" class="headerlink" title="百度千帆大模型"></a>百度千帆大模型</h2><p>注册地址：<a target="_blank" rel="noopener" href="https://cloud.baidu.com/product-s/qianfan_home">千帆大模型平台</a></p>
<p>应用创建地址：<a target="_blank" rel="noopener" href="https://console.bce.baidu.com/qianfan/ais/console/applicationConsole/application/v2">百度智能云控制台</a></p>
<p>使用流程参考：<a target="_blank" rel="noopener" href="https://dcnb1zlrk6z5.feishu.cn/wiki/HfUqw2dI4iEKIBk9jlGchYoen1a">‌‬‬‬‬﻿‍‌⁠⁠﻿‬‍⁠‍‬‬⁠⁠‍飞书云文档</a></p>
<h3 id="大模型API说明"><a href="#大模型API说明" class="headerlink" title="大模型API说明"></a>大模型API说明</h3><p>当前需求中，prompt是比较多的，也就是说需要更多的token，对话Chat V2支持的模型列表如下：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.baidu.com/doc/WENXINWORKSHOP/index.html">千帆ModelBuilder文档首页-百度智能云</a></p>
<p>经过综合评估，本次采用的是<strong>ERNIE-4.0-8K</strong></p>
<p>官方地址：<a target="_blank" rel="noopener" href="https://cloud.baidu.com/doc/WENXINWORKSHOP/s/clntwmv7t">ERNIE-4.0-8K - ModelBuilder</a></p>
<p><strong>ERNIE 4.0</strong>是百度自研的旗舰级超大规模⼤语⾔模型，相较ERNIE 3.5实现了模型能力全面升级，广泛适用于各领域复杂任务场景；支持自动对接百度搜索插件，保障问答信息时效，支持5K tokens输入+2K tokens输出</p>
<ul>
<li>对话模型，一次请求就是一次对话</li>
<li>提供了java的sdk调用，地址：<a target="_blank" rel="noopener" href="https://cloud.baidu.com/doc/qianfan-docs/s/nm9l6oc8e">https://cloud.baidu.com/doc/qianfan-docs/s/nm9l6oc8e</a></li>
<li>支持单轮对话、多轮对话、流式</li>
<li>部分关键的参数：<a target="_blank" rel="noopener" href="https://cloud.baidu.com/doc/qianfan-api/s/3m7of64lb">https://cloud.baidu.com/doc/qianfan-api/s/3m7of64lb</a></li>
<li>返回参数：<strong>result</strong>可以获取对话返回的结果</li>
</ul>
<h3 id="集成大模型"><a href="#集成大模型" class="headerlink" title="集成大模型"></a>集成大模型</h3><ol>
<li>在zzyl-common模块下新增以下依赖：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.openai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>openai-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.22.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span> # 按需更新版本号</span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于openai用到了kotlin，而这个依赖自带的kotlin版本和项目中的kotlin版本冲突了，所以，还需要排除一些依赖，然后重新引入一个统一的版本，才能正常使用</p>
</blockquote>
<ol start="2">
<li>在父工程pom.xml文件中统一管理依赖的版本：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>zzyl<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.ruoyi.vip<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>中州养老<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">zzyl.version</span>&gt;</span>3.8.9<span class="tag">&lt;/<span class="name">zzyl.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven-jar-plugin.version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">maven-jar-plugin.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.5.15<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.2.23<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bitwalker.version</span>&gt;</span>1.21<span class="tag">&lt;/<span class="name">bitwalker.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">swagger.version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">swagger.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">kaptcha.version</span>&gt;</span>2.3.3<span class="tag">&lt;/<span class="name">kaptcha.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pagehelper.boot.version</span>&gt;</span>1.4.7<span class="tag">&lt;/<span class="name">pagehelper.boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fastjson.version</span>&gt;</span>2.0.53<span class="tag">&lt;/<span class="name">fastjson.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">oshi.version</span>&gt;</span>6.8.1<span class="tag">&lt;/<span class="name">oshi.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commons.io.version</span>&gt;</span>2.19.0<span class="tag">&lt;/<span class="name">commons.io.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">poi.version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">poi.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">velocity.version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">velocity.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jwt.version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">jwt.version</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- override dependency version --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tomcat.version</span>&gt;</span>9.0.105<span class="tag">&lt;/<span class="name">tomcat.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logback.version</span>&gt;</span>1.2.13<span class="tag">&lt;/<span class="name">logback.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-security.version</span>&gt;</span>5.7.12<span class="tag">&lt;/<span class="name">spring-security.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-framework.version</span>&gt;</span>5.3.39<span class="tag">&lt;/<span class="name">spring-framework.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.22<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mybatis-plus-spring-boot.version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">mybatis-plus-spring-boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aliyun.sdk.oss</span>&gt;</span>3.17.4<span class="tag">&lt;/<span class="name">aliyun.sdk.oss</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hutool-all.version</span>&gt;</span>5.8.10<span class="tag">&lt;/<span class="name">hutool-all.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">openai-java.version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">openai-java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">kotlin.version</span>&gt;</span>1.9.23<span class="tag">&lt;/<span class="name">kotlin.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jackson.version</span>&gt;</span>2.16.1<span class="tag">&lt;/<span class="name">jackson.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">okhttp.version</span>&gt;</span>4.12.0<span class="tag">&lt;/<span class="name">okhttp.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 依赖声明 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 覆盖SpringFramework的依赖配置--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-framework-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-framework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 覆盖SpringSecurity的依赖配置--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-security.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- SpringBoot的依赖配置--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 覆盖logback的依赖配置--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;logback.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;logback.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 覆盖tomcat的依赖配置--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;tomcat.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;tomcat.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;tomcat.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 阿里数据库连接池 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 解析客户端操作系统、浏览器等 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>eu.bitwalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>UserAgentUtils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;bitwalker.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- pagehelper 分页插件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;pagehelper.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 获取系统信息 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.oshi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>oshi-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;oshi.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- Swagger3依赖 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;swagger.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-models<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- io常用工具类 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;commons.io.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- excel工具 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;poi.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- velocity代码生成使用模板 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity-engine-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;velocity.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 阿里JSON解析器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;fastjson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- Token生成与解析--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jwt.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 验证码 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>pro.fessional<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kaptcha.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 定时任务--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zzyl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 代码生成--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zzyl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 核心模块--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zzyl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 系统模块--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-system<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zzyl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 通用工具--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zzyl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--护理平台模块--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-nursing-platform<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zzyl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--OSS模块--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zzyl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--Lombok--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- MyBatis-Plus 增强CRUD --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus-spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-annotation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus-spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;aliyun.sdk.oss&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- hutool工具包 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;hutool-all.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kotlin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- Kotlin Standard Library --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kotlin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-reflect<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kotlin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kotlin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk7<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kotlin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-module-kotlin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.openai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>openai-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;openai-java.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;okhttp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>zzyl-admin<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>zzyl-framework<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>zzyl-system<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>zzyl-quartz<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>zzyl-generator<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>zzyl-common<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>zzyl-nursing-platform<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>zzyl-oss<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun nexus<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun nexus<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>接下来，在common模块的pom.xml文件中引入openai-java的依赖，并排除有版本冲突的依赖然后重新引入：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">        common通用工具</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Spring框架基本的核心工具 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- SpringWeb模块 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- spring security 安全认证 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- pagehelper 分页插件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 自定义验证注解 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--常用工具类 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- JSON工具类 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-module-kotlin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-reflect<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk7<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 阿里JSON解析器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- io常用工具类 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- excel工具 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- yml解析器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Token生成与解析--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Jaxb --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- redis 缓存操作 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- pool 对象池 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 解析客户端操作系统、浏览器等 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>eu.bitwalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>UserAgentUtils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- servlet包 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ruoyi-springboot2 / swagger knife4j 配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--Lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--MyBatisPlus--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-reflect<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk7<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-annotation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--hutool工具包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--pdfbox--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.pdfbox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pdfbox<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.openai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>openai-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk7<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-reflect<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk7<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Kotlin Standard Library --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-reflect<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-stdlib-jdk7<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>参考官方示例（<a target="_blank" rel="noopener" href="https://cloud.baidu.com/doc/qianfan-docs/s/nm9l6oc8e%EF%BC%89%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAmain%E6%96%B9%E6%B3%95%E6%9D%A5%E6%B5%8B%E8%AF%95%E5%8D%B3%E5%8F%AF%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A">https://cloud.baidu.com/doc/qianfan-docs/s/nm9l6oc8e）编写一个main方法来测试即可，代码如下：</a></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.openai.client.OpenAIClient;</span><br><span class="line"><span class="keyword">import</span> com.openai.client.okhttp.OpenAIOkHttpClient;</span><br><span class="line"><span class="keyword">import</span> com.openai.models.ResponseFormatJsonObject;</span><br><span class="line"><span class="keyword">import</span> com.openai.models.chat.completions.ChatCompletion;</span><br><span class="line"><span class="keyword">import</span> com.openai.models.chat.completions.ChatCompletionCreateParams;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QianfanAIModelTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">OpenAIClient</span> <span class="variable">client</span> <span class="operator">=</span> OpenAIOkHttpClient.builder()</span><br><span class="line">                .apiKey(<span class="string">&quot;bce-v3/ALTAK-6H6k7kuLyTmZPBmOJ2ajC/2520d4ad36847715153ca819932f1d854bb9e71f&quot;</span>) <span class="comment">//将your_APIKey替换为真实值，如何获取API Key请查看https://cloud.baidu.com/doc/WENXINWORKSHOP/s/Um2wxbaps#步骤二-获取api-key</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://qianfan.baidubce.com/v2/&quot;</span>) <span class="comment">//千帆ModelBuilder平台地址</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">ChatCompletionCreateParams</span> <span class="variable">params</span> <span class="operator">=</span> ChatCompletionCreateParams.builder()</span><br><span class="line">                .addUserMessage(<span class="string">&quot;你好&quot;</span>) <span class="comment">// 对话messages信息</span></span><br><span class="line">                .model(<span class="string">&quot;deepseek-r1&quot;</span>) <span class="comment">// 模型对应的model值，请查看支持的模型列表：https://cloud.baidu.com/doc/WENXINWORKSHOP/s/wm7ltcvgc</span></span><br><span class="line">                .responseFormat(ChatCompletionCreateParams.ResponseFormat.ofJsonObject(ResponseFormatJsonObject.builder().build()))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">ChatCompletion</span> <span class="variable">chatCompletion</span> <span class="operator">=</span> client.chat().completions().create(params);</span><br><span class="line">        System.out.println(chatCompletion.choices().get(<span class="number">0</span>).message().content().orElseGet(() -&gt; <span class="string">&quot;&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a>接口开发</h2><h3 id="基础代码准备"><a href="#基础代码准备" class="headerlink" title="基础代码准备"></a>基础代码准备</h3><p>打开后台管理系统，咱们继续使用代码生成功能，来完成基础代码的准备，导入最新的表结构（健康评估表）</p>
<p><img src="/img/loading.gif" data-original="/img/assests/d4d07bdd-2e26-4f0e-8489-dbc01589fe08.png" alt="d4d07bdd-2e26-4f0e-8489-dbc01589fe08"></p>
<p>修改代码生成</p>
<ul>
<li>生成包路径：<code>com.zzyl.nursing</code></li>
<li>生成的模块名：<code>nursing</code></li>
<li>生成的业务名：<code>healthAssessment</code></li>
<li>上级菜单：不选择（由于目前已经提供了所有的前端和菜单的表结构，无需自己创建选择菜单）</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/9a508d36-c8be-471b-8f04-5204df75130c.png" alt="9a508d36-c8be-471b-8f04-5204df75130c"></p>
<p>配置完成后，下载代码到本地</p>
<p><strong>特别注意</strong>：只需要拷贝后端代码到idea中即可，<strong>不需要执行SQL</strong>，<strong>不需要拷贝前端代码</strong></p>
<p><img src="/img/loading.gif" data-original="/img/assests/60ebf26c-3d28-42d0-a400-30c15a356de4.png" alt="60ebf26c-3d28-42d0-a400-30c15a356de4"></p>
<p>当代码拷贝之后，就已经完成了两个接口的开发，分别是<strong>列表分页查询</strong>和<strong>查看详情</strong>。不过关于上传体检报告和智能评测还需要咱们自行实现。</p>
<p>将后端代码都拷贝到项目中后，可以执行下面这条SQL语句插入一条数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `health_assessment`(`system_score`,`nursing_level_name`,`gender`,`total_check_date`,`create_time`,`disease_risk`,`birth_date`,`health_score`,`id_card`,`abnormal_analysis`,`physical_exam_institution`,`create_by`,`risk_level`,`assessment_time`,`suggestion_for_admission`,`admission_status`,`physical_report_url`,`elder_name`,`id`,`age`,`report_summary`) <span class="keyword">VALUES</span> (<span class="string">&#x27;&#123;&quot;breathingSystem&quot;:100,&quot;digestiveSystem&quot;:85,&quot;endocrineSystem&quot;:90,&quot;immuneSystem&quot;:95,&quot;circulatorySystem&quot;:80,&quot;urinarySystem&quot;:90,&quot;motionSystem&quot;:100,&quot;senseSystem&quot;:90&#125;&#x27;</span>,<span class="string">&#x27;一级护理等级&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;2023-10-10&#x27;</span>,<span class="string">&#x27;2024-10-10T01:07:42&#x27;</span>,<span class="string">&#x27;&#123;&quot;healthy&quot;:60,&quot;caution&quot;:30,&quot;risk&quot;:10,&quot;danger&quot;:0,&quot;severeDanger&quot;:0&#125;&#x27;</span>,<span class="string">&#x27;1960-01-26T00:00&#x27;</span>,<span class="string">&#x27;80.5&#x27;</span>,<span class="string">&#x27;210102196001267626&#x27;</span>,<span class="string">&#x27;[&#123;&quot;conclusion&quot;:&quot;心率略快&quot;,&quot;examinationItem&quot;:&quot;心率&quot;,&quot;result&quot;:&quot;92 次/分&quot;,&quot;referenceValue&quot;:&quot;&lt; 140&quot;,&quot;unit&quot;:&quot;次/分&quot;,&quot;interpret&quot;:&quot;心率稍高于理想范围，可能与情绪、活动或轻度心脏负担有关。&quot;,&quot;advice&quot;:&quot;建议心电图检查及定期监测心率，保持情绪稳定，适量运动。&quot;&#125;,&#123;&quot;conclusion&quot;:&quot;轻度脂肪肝可能&quot;,&quot;examinationItem&quot;:&quot;肝&quot;,&quot;result&quot;:&quot;形态大小正常，实质回声略粗糙&quot;,&quot;referenceValue&quot;:&quot;-&quot;,&quot;unit&quot;:&quot;-&quot;,&quot;interpret&quot;:&quot;肝脏实质回声略粗糙，提示可能有轻度脂肪肝，与饮食习惯、生活方式或遗传因素有关。&quot;,&quot;advice&quot;:&quot;建议调整饮食结构，减少高脂食物摄入，增加运动，定期检查肝脏情况。&quot;&#125;,&#123;&quot;conclusion&quot;:&quot;慢性胆囊炎可能&quot;,&quot;examinationItem&quot;:&quot;胆&quot;,&quot;result&quot;:&quot;胆囊壁毛糙&quot;,&quot;referenceValue&quot;:&quot;-&quot;,&quot;unit&quot;:&quot;-&quot;,&quot;interpret&quot;:&quot;胆囊壁毛糙，可能表示有慢性胆囊炎，可能与胆囊结石、感染或长期饮食不规律有关。&quot;,&quot;advice&quot;:&quot;建议进一步检查胆囊情况，保持规律饮食，避免高脂食物。&quot;&#125;,&#123;&quot;conclusion&quot;:&quot;脾轻度增大&quot;,&quot;examinationItem&quot;:&quot;脾&quot;,&quot;result&quot;:&quot;轻度增大&quot;,&quot;referenceValue&quot;:&quot;-&quot;,&quot;unit&quot;:&quot;-&quot;,&quot;interpret&quot;:&quot;脾脏轻度增大，可能与感染、血液系统疾病或自身免疫性疾病有关。&quot;,&quot;advice&quot;:&quot;建议进一步检查脾脏，以确定增大的原因，并采取相应的治疗措施。&quot;&#125;,&#123;&quot;conclusion&quot;:&quot;右肾小囊肿可能&quot;,&quot;examinationItem&quot;:&quot;肾&quot;,&quot;result&quot;:&quot;右肾下极见一大小约 5mm 的无回声区&quot;,&quot;referenceValue&quot;:&quot;-&quot;,&quot;unit&quot;:&quot;mm&quot;,&quot;interpret&quot;:&quot;右肾小囊肿，一般为良性病变，可能与肾小管憩室增多有关。&quot;,&quot;advice&quot;:&quot;建议定期监测囊肿大小，若无症状且囊肿不增大，可暂不处理。&quot;&#125;,&#123;&quot;conclusion&quot;:&quot;前列腺形态略增大&quot;,&quot;examinationItem&quot;:&quot;前列腺&quot;,&quot;result&quot;:&quot;形态略增大&quot;,&quot;referenceValue&quot;:&quot;-&quot;,&quot;unit&quot;:&quot;-&quot;,&quot;interpret&quot;:&quot;前列腺形态略增大，可能与前列腺增生有关，是老年男性常见病变。&quot;,&quot;advice&quot;:&quot;建议进行PSA检查以排除前列腺肿瘤，并定期检查前列腺情况。&quot;&#125;]&#x27;</span>,<span class="string">&#x27;中州体检&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;caution&#x27;</span>,<span class="string">&#x27;2024-10-10T01:07:42&#x27;</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;https://java110-ai.oss-cn-beijing.aliyuncs.com/2024/10/af59dc76-0c01-4043-9706-b9ed1ec08984.pdf&#x27;</span>,<span class="string">&#x27;刘爱国&#x27;</span>,<span class="number">9</span>,<span class="number">64</span>,<span class="string">&#x27;体检报告中心率、肝脏、胆囊、脾脏、肾脏、前列腺共6项指标提示异常，综合这些临床指标和数据分析：循环系统、消化系统存在隐患，其中循环系统有“中危”风险；消化系统部位有“低危”风险。&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>这样就能看到<strong>列表分页查询</strong>和<strong>查看详情</strong>的内容了</p>
<h3 id="设计Prompt"><a href="#设计Prompt" class="headerlink" title="设计Prompt"></a>设计Prompt</h3><p>回顾一下Prompt的构成部分：</p>
<ul>
<li><strong>角色</strong>：给 AI 定义一个最匹配任务的角色，比如：「你是一位软件工程师」「你是一位小学老师」</li>
<li><strong>指示</strong>：对任务进行描述</li>
<li><strong>上下文</strong>：给出与任务相关的其它背景信息（尤其在多轮交互中）</li>
<li><strong>例子</strong>：必要时给出举例，[实践证明例子对输出正确性有帮助]</li>
<li><strong>输入</strong>：任务的输入信息；在提示词中明确的标识出输入</li>
<li><strong>输出</strong>：输出的格式描述，以便后继模块自动解析模型的输出结果，比如（JSON、Java）</li>
</ul>
<p>清楚了Prompt的构成部分之后，再来分析一下之前的需求，重点来看一下哪些字段需要AI来提供，如下图：</p>
<img src="/img/loading.gif" data-original="/img/assests/303bdbfc-b2a7-4202-9276-9c0fc0fca3d0.png" alt="303bdbfc-b2a7-4202-9276-9c0fc0fca3d0" style="zoom: 67%;" />

<p>设计之后的Prompt提示词，这里涉及了大量的专业名词和健康指标，<strong>实际开发中需要找产品经理协助</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">请以一个专业医生的视角来分析这份体检报告，报告中包含了一些异常数据，我需要您对这些数据进行解读，并给出相应的健康建议。</span><br><span class="line">体检内容如下：</span><br><span class="line">    内容略....</span><br><span class="line"></span><br><span class="line">要求：</span><br><span class="line">1. 提取体检报告中的“总检日期”；</span><br><span class="line">2. 通过临床医学、疾病风险评估模型和数据智能分析，给该用户的风险等级和健康指数给出结果。风险等级分为：健康、提示、风险、危险、严重危险。健康指数范围为0至100分；</span><br><span class="line">3. 根据用户身体各项指标数据，详细说明该用户各项风险等级的占比是多少，最多保留两位小数。结论格式：该用户健康占比20.00%，提示占比20.00%，风险占比20%，危险占比20%，严重危险占比20%；</span><br><span class="line">4. 对于体检报告中的异常数据，请列出（异常数据的结论、体检项目名称、检查结果、参考值、单位、异常解读、建议）这7字段。解读异常数据，解决这些数据可能代表的健康问题或风险。分析可能的原因，包括但不限于生活习惯、饮食习惯、遗传因素等。基于这些异常数据和可能的原因，请给出具体的健康建议，包括饮食调整、运动建议、生活方式改变以及是否需要进一步检查或治疗等。</span><br><span class="line">结论格式：异常数据的结论：肥胖，体检项目名称：体重指数BMI，检查结果：29.2，参考值&gt;24，单位：-。异常解读：体重超标包括超重与肥胖。体重指数（BMI）=体重（kg）/身⾼（m）的平⽅，BMI≥24为超重，BMI≥28为肥胖；男性腰围≥90cm和⼥性腰围≥85cm为腹型肥胖。体重超标是⼀种由多因素（如遗传、进⻝油脂较多、运动少、疾病等）引起的慢性代谢性疾病，尤其是肥胖，已经被世界卫⽣组织列为导致疾病负担的⼗⼤危险因素之⼀。AI建议：采取综合措施预防和控制体重，积极改变⽣活⽅式，宜低脂、低糖、⾼纤维素膳⻝，多⻝果蔬及菌藻类⻝物，增加有氧运动。若有相关疾病（如⾎脂异常、⾼⾎压、糖尿病等）应积极治疗。</span><br><span class="line">5. 根据这个体检报告的内容，分别给人体的8大系统打分，每项满分为100分，8大系统分别为：呼吸系统、消化系统、内分泌系统、免疫系统、循环系统、泌尿系统、运动系统、感官系统</span><br><span class="line">6. 给体检报告做一个总结，总结格式：体检报告中尿蛋⽩、癌胚抗原、⾎沉、空腹⾎糖、总胆固醇、⽢油三酯、低密度脂蛋⽩胆固醇、⾎清载脂蛋⽩B、动脉硬化指数、⽩细胞、平均红细胞体积、平均⾎红蛋⽩共12项指标提示异常，尿液常规共1项指标处于临界值，⾎脂、⾎液常规、尿液常规、糖类抗原、⾎清酶类等共43项指标提示正常，综合这些临床指标和数据分析：肾脏、肝胆、⼼脑⾎管存在隐患，其中⼼脑⾎管有“⾼危”⻛险；肾脏部位有“中危”⻛险；肝胆部位有“低危”⻛险。</span><br><span class="line"></span><br><span class="line">输出要求：</span><br><span class="line">最后，将以上结果输出为纯JSON格式，不要包含其他的文字说明，也不要出现Markdown语法相关的文字，所有的返回结果都是json，详细格式如下：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;totalCheckDate&quot;: &quot;YYYY-MM-DD&quot;,</span><br><span class="line">  &quot;healthAssessment&quot;: &#123;</span><br><span class="line">    &quot;riskLevel&quot;: &quot;healthy/caution/risk/danger/severeDanger&quot;,</span><br><span class="line">    &quot;healthIndex&quot;: XX.XX</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;riskDistribution&quot;: &#123;</span><br><span class="line">    &quot;healthy&quot;: XX.XX,</span><br><span class="line">    &quot;caution&quot;: XX.XX,</span><br><span class="line">    &quot;risk&quot;: XX.XX,</span><br><span class="line">    &quot;danger&quot;: XX.XX,</span><br><span class="line">    &quot;severeDanger&quot;: XX.XX</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;abnormalData&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;conclusion&quot;: &quot;异常数据的结论&quot;,</span><br><span class="line">      &quot;examinationItem&quot;: &quot;体检项目名称&quot;,</span><br><span class="line">      &quot;result&quot;: &quot;检查结果&quot;,</span><br><span class="line">      &quot;referenceValue&quot;: &quot;参考值&quot;,</span><br><span class="line">      &quot;unit&quot;: &quot;单位&quot;,</span><br><span class="line">      &quot;interpret&quot;:&quot;对于异常的结论进一步详细的说明&quot;,</span><br><span class="line">      &quot;advice&quot;:&quot;针对于这一项的异常，给出一些健康的建议&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;systemScore&quot;: &#123;</span><br><span class="line">    &quot;breathingSystem&quot;: XX,</span><br><span class="line">    &quot;digestiveSystem&quot;: XX,</span><br><span class="line">    &quot;endocrineSystem&quot;: XX,</span><br><span class="line">    &quot;immuneSystem&quot;: XX,</span><br><span class="line">    &quot;circulatorySystem&quot;: XX,</span><br><span class="line">    &quot;urinarySystem&quot;: XX,</span><br><span class="line">    &quot;motionSystem&quot;: XX,</span><br><span class="line">    &quot;senseSystem&quot;: XX</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;summarize&quot;: &quot;体检报告的总结&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="上传体检报告"><a href="#上传体检报告" class="headerlink" title="上传体检报告"></a>上传体检报告</h3><h4 id="需求回顾"><a href="#需求回顾" class="headerlink" title="需求回顾"></a>需求回顾</h4><p>如下图，当点击了上传体检报告之后，弹窗需要输入信息，当选择了文件之后，<font color='red'>会自动触发接口调用</font></p>
<p>参数有两个：身份证号和体检报告<strong>文件</strong></p>
<p><img src="/img/loading.gif" data-original="/img/assests/578d5c58-778e-486f-91b0-32f9f0b0998b.png" alt="578d5c58-778e-486f-91b0-32f9f0b0998b"></p>
<h4 id="思路回顾"><a href="#思路回顾" class="headerlink" title="思路回顾"></a>思路回顾</h4><p>如下图：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (17).png" alt="whiteboard_exported_image (17)" style="zoom:50%;" />



<h4 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h4><p>文件需要上传到OSS中，所以需要在zzyl-nursing-platform模块中新增zzyl-oss的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zzyl-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在HealthAssessmentController中定义新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> AliyunOSSOperator aliyunOSSOperator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用上传请求（单个）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;上传体检报告&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">uploadFile</span><span class="params">(MultipartFile file, String idCardNo)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 上传到OSS</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> aliyunOSSOperator.upload(file.getBytes(), file.getOriginalFilename());</span><br><span class="line"></span><br><span class="line">        <span class="type">AjaxResult</span> <span class="variable">ajax</span> <span class="operator">=</span> AjaxResult.success();</span><br><span class="line">        ajax.put(<span class="string">&quot;url&quot;</span>, url);</span><br><span class="line">        ajax.put(<span class="string">&quot;fileName&quot;</span>, url);</span><br><span class="line">        <span class="comment">// ajax.put(&quot;newFileName&quot;, url.substring(url.lastIndexOf(&quot;/&quot;)));</span></span><br><span class="line">        ajax.put(<span class="string">&quot;originalFilename&quot;</span>, file.getOriginalFilename());</span><br><span class="line">        <span class="comment">// PDF文件内容读取为字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> PDFUtil.pdfToString(file.getInputStream());</span><br><span class="line">        <span class="comment">// 临时存储到redis中</span></span><br><span class="line">        redisTemplate.opsForHash().put(<span class="string">&quot;healthReport&quot;</span>, idCardNo, content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ajax;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.error(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="智能评测"><a href="#智能评测" class="headerlink" title="智能评测"></a>智能评测</h3><h4 id="抽取大模型调用工具"><a href="#抽取大模型调用工具" class="headerlink" title="抽取大模型调用工具"></a>抽取大模型调用工具</h4><p>提前将调用大模型的代码抽取成一个工具方法</p>
<ol>
<li>一些可变的参数，在application.yml文件中定义，在application.yml文件中定义内容，如下：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 百度千帆大模型配置</span></span><br><span class="line"><span class="attr">baidu:</span></span><br><span class="line">  <span class="attr">qianfan:</span></span><br><span class="line">    <span class="attr">apiKey:</span> <span class="string">xxxxxxxxx</span></span><br><span class="line">    <span class="attr">baseUrl:</span> <span class="string">https://qianfan.baidubce.com/v2/</span></span><br><span class="line">    <span class="attr">model:</span> <span class="string">ernie-4.0-8k</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>定义properties类来方便读取配置，在zzyl-common模块下新增一个类com.zzyl.common.ai.BaiduAIProperties</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.common.ai;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;baidu.qianfan&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaiduAIProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String apiKey;</span><br><span class="line">    <span class="keyword">private</span> String baseUrl;</span><br><span class="line">    <span class="keyword">private</span> String model;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>参考之前集成千帆大模型的方式，在zzyl-common模块下新增一个类com.zzyl.common.ai.AIModelInvoker</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.common.ai;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.openai.client.OpenAIClient;</span><br><span class="line"><span class="keyword">import</span> com.openai.client.okhttp.OpenAIOkHttpClient;</span><br><span class="line"><span class="keyword">import</span> com.openai.models.ResponseFormatJsonObject;</span><br><span class="line"><span class="keyword">import</span> com.openai.models.chat.completions.ChatCompletion;</span><br><span class="line"><span class="keyword">import</span> com.openai.models.chat.completions.ChatCompletionCreateParams;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AIModelInvoker</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BaiduAIProperties baiduAIProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">qianfanInvoker</span><span class="params">(String prompt)</span> &#123;</span><br><span class="line">        <span class="type">OpenAIClient</span> <span class="variable">client</span> <span class="operator">=</span> OpenAIOkHttpClient.builder()</span><br><span class="line">                .apiKey(baiduAIProperties.getApiKey())</span><br><span class="line">                .baseUrl(baiduAIProperties.getBaseUrl())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">ChatCompletionCreateParams</span> <span class="variable">params</span> <span class="operator">=</span> ChatCompletionCreateParams.builder()</span><br><span class="line">                .addUserMessage(prompt)</span><br><span class="line">                .model(baiduAIProperties.getModel())</span><br><span class="line">                .responseFormat(ChatCompletionCreateParams.ResponseFormat.ofJsonObject(ResponseFormatJsonObject.builder().build()))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">ChatCompletion</span> <span class="variable">chatCompletion</span> <span class="operator">=</span> client.chat().completions().create(params);</span><br><span class="line">        <span class="keyword">return</span> chatCompletion.choices().get(<span class="number">0</span>).message().content().orElseGet(() -&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="修改控制层"><a href="#修改控制层" class="headerlink" title="修改控制层"></a>修改控制层</h4><p>找到HealthAssessmentController中的add方法的返回值类型为Long类型，用来接收Service层方法返回的主键id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新增健康评估</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;新增健康评估&quot;)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;nursing:healthAssessment:add&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@Log(title = &quot;健康评估&quot;, businessType = BusinessType.INSERT)</span></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@ApiParam(&quot;新增的健康评估对象&quot;)</span> HealthAssessment healthAssessment)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> healthAssessmentService.insertHealthAssessment(healthAssessment);</span><br><span class="line">    <span class="keyword">return</span> success(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改业务层"><a href="#修改业务层" class="headerlink" title="修改业务层"></a>修改业务层</h4><ol>
<li>修改IHealthAssessmentService中的insertHealthAssessment方法，把返回值类型替换为Long</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新增健康评估</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> healthAssessment 健康评估</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">insertHealthAssessment</span><span class="params">(HealthAssessment healthAssessment)</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>实现类中的返回值类型也要改为Long，并且按照思路来编写业务代码</li>
</ol>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (18).png" alt="whiteboard_exported_image (18)" style="zoom:67%;" />

<p>最终代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> AIModelInvoker aiModelInvoker;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新增健康评估</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> healthAssessment 健康评估</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">insertHealthAssessment</span><span class="params">(HealthAssessment healthAssessment)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.设计Prompt提示词（需要从Redis中读取当前身份证号对应的体检报告）</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">prompt</span> <span class="operator">=</span> getPrompt(healthAssessment.getIdCard());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.调用百度千帆大模型，分析体检报告，获取分析结果</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">qianfanResult</span> <span class="operator">=</span> aiModelInvoker.qianfanInvoker(prompt);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.将分析结果保存到数据库中，并返回保存的这条记录的id</span></span><br><span class="line">    <span class="comment">// 将大模型返回的字符串解析为对象，方便取数据</span></span><br><span class="line">    <span class="type">HealthReportVo</span> <span class="variable">healthReportVo</span> <span class="operator">=</span> JSON.parseObject(qianfanResult, HealthReportVo.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> saveHealthAssessment(healthReportVo, healthAssessment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存大模型返回的结果和前端传递的老人信息到数据库</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> healthReportVo        千帆大模型返回的结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> healthAssessment      老人基本信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  记录的id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Long <span class="title function_">saveHealthAssessment</span><span class="params">(HealthReportVo healthReportVo, HealthAssessment healthAssessment)</span> &#123;</span><br><span class="line">    <span class="comment">// 老人身份证号</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idCard</span> <span class="operator">=</span> healthAssessment.getIdCard();</span><br><span class="line"></span><br><span class="line">    healthAssessment.setBirthDate(IDCardUtils.getBirthDateByIdCard(idCard));</span><br><span class="line">    healthAssessment.setAge(IDCardUtils.getAgeByIdCard(idCard));</span><br><span class="line">    healthAssessment.setGender(IDCardUtils.getGenderFromIdCard(idCard));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 健康评分</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">healthScore</span> <span class="operator">=</span> healthReportVo.getHealthAssessment().getHealthIndex();</span><br><span class="line">    healthAssessment.setHealthScore(String.valueOf(healthScore));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 风险等级</span></span><br><span class="line">    healthAssessment.setRiskLevel(healthReportVo.getHealthAssessment().getRiskLevel());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过健康评分判断是否建议入住</span></span><br><span class="line">    healthAssessment.setSuggestionForAdmission(healthScore &gt;= <span class="number">60</span> ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过健康评分计算一个推荐的护理等级</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">nursingLevelName</span> <span class="operator">=</span> getLevelNameByHealthScore(healthScore);</span><br><span class="line">    healthAssessment.setNursingLevelName(nursingLevelName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统一先设置未入住</span></span><br><span class="line">    healthAssessment.setAdmissionStatus(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 总检日期</span></span><br><span class="line">    healthAssessment.setTotalCheckDate(healthReportVo.getTotalCheckDate());</span><br><span class="line"></span><br><span class="line">    healthAssessment.setAssessmentTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 报告总结</span></span><br><span class="line">    healthAssessment.setReportSummary(healthReportVo.getSummarize());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 疾病风险分布</span></span><br><span class="line">    healthAssessment.setDiseaseRisk(JSON.toJSONString(healthReportVo.getRiskDistribution()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常分析</span></span><br><span class="line">    healthAssessment.setAbnormalAnalysis(JSON.toJSONString(healthReportVo.getAbnormalData()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 八大系统评分</span></span><br><span class="line">    healthAssessment.setSystemScore(JSON.toJSONString(healthReportVo.getSystemScore()));</span><br><span class="line"></span><br><span class="line">    healthAssessmentMapper.insert(healthAssessment);</span><br><span class="line">    <span class="keyword">return</span> healthAssessment.getId();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getLevelNameByHealthScore</span><span class="params">(<span class="type">double</span> healthScore)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (healthScore &gt; <span class="number">100</span> || healthScore &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;健康评分值不合法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (healthScore &gt;= <span class="number">90</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;四级护理等级&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (healthScore &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;三级护理等级&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (healthScore &gt;= <span class="number">70</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;二级护理等级&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (healthScore &gt;= <span class="number">60</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;一级护理等级&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;特级护理等级&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取Prompt提示词</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> idCard    身份证号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  提示词</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getPrompt</span><span class="params">(String idCard)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取文件中的内容</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String) redisTemplate.opsForHash().get(<span class="string">&quot;healthReport&quot;</span>, idCard);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否为空</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(content)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;文件提取内容失败，请重新上传提交报告&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="string">&quot;请以一个专业医生的视角来分析这份体检报告，报告中包含了一些异常数据，我需要您对这些数据进行解读，并给出相应的健康建议。\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;体检内容如下：\n&quot;</span> +</span><br><span class="line">            content + <span class="string">&quot;    \n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;要求：\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;1. 提取体检报告中的“总检日期”；\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;2. 通过临床医学、疾病风险评估模型和数据智能分析，给该用户的风险等级和健康指数给出结果。风险等级分为：健康、提示、风险、危险、严重危险。健康指数范围为0至100分；\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;3. 根据用户身体各项指标数据，详细说明该用户各项风险等级的占比是多少，最多保留两位小数。结论格式：该用户健康占比20.00%，提示占比20.00%，风险占比20%，危险占比20%，严重危险占比20%；\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;4. 对于体检报告中的异常数据，请列出（异常数据的结论、体检项目名称、检查结果、参考值、单位、异常解读、建议）这7字段。解读异常数据，解决这些数据可能代表的健康问题或风险。分析可能的原因，包括但不限于生活习惯、饮食习惯、遗传因素等。基于这些异常数据和可能的原因，请给出具体的健康建议，包括饮食调整、运动建议、生活方式改变以及是否需要进一步检查或治疗等。\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;结论格式：异常数据的结论：肥胖，体检项目名称：体重指数BMI，检查结果：29.2，参考值&gt;24，单位：-。异常解读：体重超标包括超重与肥胖。体重指数（BMI）=体重（kg）/身⾼（m）的平⽅，BMI≥24为超重，BMI≥28为肥胖；男性腰围≥90cm和⼥性腰围≥85cm为腹型肥胖。体重超标是⼀种由多因素（如遗传、进⻝油脂较多、运动少、疾病等）引起的慢性代谢性疾病，尤其是肥胖，已经被世界卫⽣组织列为导致疾病负担的⼗⼤危险因素之⼀。AI建议：采取综合措施预防和控制体重，积极改变⽣活⽅式，宜低脂、低糖、⾼纤维素膳⻝，多⻝果蔬及菌藻类⻝物，增加有氧运动。若有相关疾病（如⾎脂异常、⾼⾎压、糖尿病等）应积极治疗。\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;5. 根据这个体检报告的内容，分别给人体的8大系统打分，每项满分为100分，8大系统分别为：呼吸系统、消化系统、内分泌系统、免疫系统、循环系统、泌尿系统、运动系统、感官系统\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;6. 给体检报告做一个总结，总结格式：体检报告中尿蛋⽩、癌胚抗原、⾎沉、空腹⾎糖、总胆固醇、⽢油三酯、低密度脂蛋⽩胆固醇、⾎清载脂蛋⽩B、动脉硬化指数、⽩细胞、平均红细胞体积、平均⾎红蛋⽩共12项指标提示异常，尿液常规共1项指标处于临界值，⾎脂、⾎液常规、尿液常规、糖类抗原、⾎清酶类等共43项指标提示正常，综合这些临床指标和数据分析：肾脏、肝胆、⼼脑⾎管存在隐患，其中⼼脑⾎管有“⾼危”⻛险；肾脏部位有“中危”⻛险；肝胆部位有“低危”⻛险。\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;输出要求：\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;最后，将以上结果输出为纯JSON格式，不要包含其他的文字说明，也不要出现Markdown语法相关的文字，所有的返回结果都是json，详细格式如下：\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;totalCheckDate\&quot;: \&quot;YYYY-MM-DD\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;healthAssessment\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;riskLevel\&quot;: \&quot;healthy/caution/risk/danger/severeDanger\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;healthIndex\&quot;: XX.XX\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;riskDistribution\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;healthy\&quot;: XX.XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;caution\&quot;: XX.XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;risk\&quot;: XX.XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;danger\&quot;: XX.XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;severeDanger\&quot;: XX.XX\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;abnormalData\&quot;: [\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;conclusion\&quot;: \&quot;异常数据的结论\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;examinationItem\&quot;: \&quot;体检项目名称\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;result\&quot;: \&quot;检查结果\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;referenceValue\&quot;: \&quot;参考值\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;unit\&quot;: \&quot;单位\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;interpret\&quot;:\&quot;对于异常的结论进一步详细的说明\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;advice\&quot;:\&quot;针对于这一项的异常，给出一些健康的建议\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  ],\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;systemScore\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;breathingSystem\&quot;: XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;digestiveSystem\&quot;: XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;endocrineSystem\&quot;: XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;immuneSystem\&quot;: XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;circulatorySystem\&quot;: XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;urinarySystem\&quot;: XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;motionSystem\&quot;: XX,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;senseSystem\&quot;: XX\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;summarize\&quot;: \&quot;体检报告的总结\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> prompt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相关的Vo类可以在资料中获取，或者自行根据结果进行编辑</p>
<h1 id="智能检测"><a href="#智能检测" class="headerlink" title="智能检测"></a>智能检测</h1><h2 id="产品数据准备"><a href="#产品数据准备" class="headerlink" title="产品数据准备"></a>产品数据准备</h2><p>根据IOT产品设备管理的教程，创建两款产品，用于后续的使用</p>
<p><strong>1号产品</strong>：烟雾报警器</p>
<table>
<thead>
<tr>
<th><strong>属性名称</strong></th>
<th><strong>属性描述</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>访问权限</strong></th>
<th><strong>取值范围</strong></th>
</tr>
</thead>
<tbody><tr>
<td>CurrentHumidity</td>
<td>湿度</td>
<td>int</td>
<td>读写</td>
<td>0~100</td>
</tr>
<tr>
<td>IndoorTemperature</td>
<td>温度</td>
<td>int</td>
<td>读写</td>
<td>-40~80</td>
</tr>
<tr>
<td>SmokeSensorState</td>
<td>烟雾监测状态</td>
<td>bool(布尔)</td>
<td>读写</td>
<td>布尔值：0：正常1：检测到烟雾</td>
</tr>
</tbody></table>
<p><strong>二号产品</strong>：睡眠监测带</p>
<table>
<thead>
<tr>
<th><strong>属性名称</strong></th>
<th><strong>属性描述</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>访问权限</strong></th>
<th><strong>取值范围</strong></th>
</tr>
</thead>
<tbody><tr>
<td>BedTime</td>
<td>离床时间</td>
<td>dateTime(日期时间)</td>
<td>读写</td>
<td>300</td>
</tr>
<tr>
<td>BedExitCount</td>
<td>离床次数</td>
<td>int</td>
<td>读写</td>
<td>0~10</td>
</tr>
<tr>
<td>SleepPhaseState</td>
<td>睡眠状态</td>
<td>int</td>
<td>读写</td>
<td>0~2</td>
</tr>
<tr>
<td>HeartRate</td>
<td>心率</td>
<td>int</td>
<td>读写</td>
<td>1~200</td>
</tr>
<tr>
<td>RespiratoryRate</td>
<td>呼吸率</td>
<td>int</td>
<td>读写</td>
<td>1~150</td>
</tr>
</tbody></table>
<h2 id="设备管理"><a href="#设备管理" class="headerlink" title="设备管理"></a>设备管理</h2><p>熟悉了IOT平台的基本概念以及基本操作后，可以来分析后台系统的功能需求。在后台管理系统中，需要自己维护设备，不需要创建产品，因为产品直接在物联网平台创建添加即可</p>
<p>需要单独维护设备的原因是，<strong>设备需要跟养老院的<font color='red'>老人</font>或者<font color='red'>位置</font>进行绑定</strong>，才能做到精准的监控</p>
<p>比如：</p>
<ul>
<li>烟雾报警器需要绑定到某个房间</li>
<li>智能手表需要绑定某个老人</li>
</ul>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (32).png" alt="whiteboard_exported_image (32)" style="zoom:67%;" />



<h3 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h3><h4 id="设备管理列表页"><a href="#设备管理列表页" class="headerlink" title="设备管理列表页"></a>设备管理列表页</h4><p>找到智能监测-&gt;设备管理</p>
<p><img src="/img/loading.gif" data-original="/img/assests/53c755f8-d960-447c-808a-d6b6d532bc75.png" alt="53c755f8-d960-447c-808a-d6b6d532bc75"></p>
<ul>
<li>搜索：可以根据设备名称模糊查询，根据产品和设备类型精确查询<ul>
<li>所属产品&#x3D;【Iot平台-产品管理-产品名称】</li>
<li>设备类型&#x3D;随身设备、固定设备；</li>
</ul>
</li>
<li>同步数据：点击【同步数据】后，获取华为云产品数据</li>
<li>新增设备：</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/8e57cfbb-d9e6-48f6-8549-ab93d83b2aac.png" alt="8e57cfbb-d9e6-48f6-8549-ab93d83b2aac"></p>
<ul>
<li>随身设备：表示绑定在老人身上的设备，如手表；</li>
<li>固定设备：表示绑定在固定位置的设备，如睡眠监测带、门磁、摄像头；</li>
<li>接入位置为随身设备&#x3D;入退管理-&gt;入住管理-&gt;入住办理-&gt;老人姓名-&gt;当前已入住的老人；</li>
<li>接入位置为固定设备&#x3D;楼层、房间、床位 &#x3D; 在住管理-&gt;床位管理-&gt;床位房型；</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/872ca3be-7366-47c4-8f2d-9026d5f049e8.png" alt="872ca3be-7366-47c4-8f2d-9026d5f049e8"></p>
<ul>
<li><p>删除：将该条设备从列表中移除。老人与设备自动解绑</p>
</li>
<li><p>编辑：先查看该条设备，然后再修改设备数据</p>
</li>
<li><p>查看：跳转到设备详情页</p>
</li>
<li><p>开门</p>
<ul>
<li><p>当所属产品中包含“门禁”字眼；操作中【开门】可点击，若不包含，【开门】按钮置灰；</p>
</li>
<li><p>点击【开门】，若输出参数值是0，则显示开门失败，若参数是1，则显示开门成功；</p>
</li>
</ul>
</li>
</ul>
<h4 id="设备详情"><a href="#设备详情" class="headerlink" title="设备详情"></a>设备详情</h4><p>当在列表点击<strong>查看</strong>按钮之后，可以查看设备详情页，如下效果</p>
<p><img src="/img/loading.gif" data-original="/img/assests/8a4628be-140f-4c7d-8cf4-397e03cad121.png" alt="8a4628be-140f-4c7d-8cf4-397e03cad121"></p>
<h4 id="物模型数据-运行状态"><a href="#物模型数据-运行状态" class="headerlink" title="物模型数据-运行状态"></a>物模型数据-运行状态</h4><p>点击【物模型数据】，查询物模型运行状态，列表中的数据为上行指令数据；</p>
<p><img src="/img/loading.gif" data-original="/img/assests/319f5c4b-cc20-480b-8e6e-053daa8ea77b.png" alt="319f5c4b-cc20-480b-8e6e-053daa8ea77b"></p>
<p>当点击了【查看数据】，出【查看数据】弹窗；</p>
<p><img src="/img/loading.gif" data-original="/img/assests/34cfe4c6-79eb-4ca0-a621-1ddc012aa9ce.png" alt="34cfe4c6-79eb-4ca0-a621-1ddc012aa9ce"></p>
<h3 id="表结构说明-1"><a href="#表结构说明-1" class="headerlink" title="表结构说明"></a>表结构说明</h3><p>因为需要在本地维护设备数据，所以需要创建设备表；设备上报的数据也要存储，还需要创建设备数据表，如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (33).png" alt="whiteboard_exported_image (33)" style="zoom:50%;" />

<p>详细表字段说明：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/4381a0ec-e47b-4139-b4bd-3a39d5e5b590.png" alt="4381a0ec-e47b-4139-b4bd-3a39d5e5b590"></p>
<p>sql表结构：<strong>导入本章资料中的sql脚本，里面包含了智能监测模块的所有需要的表</strong></p>
<h3 id="接口分析"><a href="#接口分析" class="headerlink" title="接口分析"></a>接口分析</h3><h4 id="接口列表"><a href="#接口列表" class="headerlink" title="接口列表"></a>接口列表</h4><p>依据刚才的需求分析，在养老系统中需要维护设备数据，咱们需要开发以下接口</p>
<ul>
<li>从物联网平台同步产品列表</li>
<li>查询所有产品列表</li>
<li>注册设备</li>
<li>分页查询设备列表</li>
<li>查询设备详细数据</li>
<li>查看设备上报的数据</li>
<li>修改设备备注名称</li>
<li>删除设备</li>
<li>分页查询设备服务调用数据（暂不开发，等接收到数据之后再完成）</li>
</ul>
<h4 id="接口文档"><a href="#接口文档" class="headerlink" title="接口文档"></a>接口文档</h4><p>接口文档参考：<a target="_blank" rel="noopener" href="https://rant7bdsfuy.feishu.cn/wiki/H7zewXWzfiYH4Mk1Mw9cCOujn9f">智能监测-接口文档</a></p>
<p>接口文档中的<strong>设备管理</strong>部分</p>
<h3 id="IOT接口对接"><a href="#IOT接口对接" class="headerlink" title="IOT接口对接"></a>IOT接口对接</h3><p>刚才分析了功能中涉及到的接口，其中关于设备的维护（新增、删除、修改、查询），咱们都需要在IOT平台中去操作，同时也需要在本地保存一份，那为什么要保存两份呢？</p>
<p>IOT平台中只是维护了<strong>基础的设备信息</strong>，并没有跟业务数据进行绑定，比如，设备属于哪个位置，绑定了哪个老人</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (34).png" alt="whiteboard_exported_image (34)" style="zoom:50%;" />



<p>只有设备绑定了业务数据，等后面采集数据之后，才能有针对性的进行排查问题。</p>
<p>所以，在接口开发过程中，需要调用远程的接口维护设备，同时也需要在本地进行数据操作。关于远程接口，IOT平台给提供了丰富的API，利于开发人员操作</p>
<h4 id="API列表"><a href="#API列表" class="headerlink" title="API列表"></a>API列表</h4><p>先查阅IOT官方提供API列表：<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0200.html">API列表</a></p>
<p>目前业务中所需要的接口文档如下：</p>
<ul>
<li>产品管理的API<ul>
<li><a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0080.html">查询产品列表</a></li>
</ul>
</li>
<li>设备管理的API<ul>
<li><a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0046.html">创建设备</a></li>
<li><a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0055.html">查询设备详情</a></li>
<li><a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0041.html">删除设备</a></li>
<li><a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_1079.html">修改设备</a></li>
</ul>
</li>
<li>设备属性<ul>
<li><a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0035.html">查询设备属性</a></li>
</ul>
</li>
</ul>
<h4 id="环境集成"><a href="#环境集成" class="headerlink" title="环境集成"></a>环境集成</h4><p>IOT平台已经提供了完整的<strong>SDK</strong>，可以把它们集成到项目中进行接口的调用，集成方式：<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/sdkreference-iothub/iot_10_10002.html">官方说明</a></p>
<p>在zzyl-framework模块导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.huaweicloud.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>huaweicloud-sdk-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.76<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.huaweicloud.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>huaweicloud-sdk-iotda<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.76<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在zzyl-admin模块中的application-dev.yml文件中添加关于IOT的配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">huaweicloud:</span></span><br><span class="line">  <span class="attr">ak:</span> <span class="string">UTVLYVJKFVGYVEFFWG</span></span><br><span class="line">  <span class="attr">sk:</span> <span class="string">WkEWqfwZoFlLwbR5Kq5NmWTLmj71WhRXe</span></span><br><span class="line">  <span class="comment">#如果是上海一，请填写&quot;cn-east-3&quot;；如果是北京四，请填写&quot;cn-north-4&quot;;</span></span><br><span class="line">  <span class="attr">regionId:</span> <span class="string">cn-east-3</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">38e7abf.st1.iotda-app.cn-east-3.myhuaweicloud.com</span></span><br><span class="line">  <span class="attr">projectId:</span> <span class="string">57ee9b4c827a44cb94319a077f0fe7cb</span></span><br><span class="line">  <span class="comment">#amqp相关配置 下一章课程接收设备数据使用</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">38e7abedbf.st1.iotda-app.cn-east-3.myhuaweicloud.com</span></span><br><span class="line">  <span class="attr">accessKey:</span> <span class="string">S25ZeTC5</span></span><br><span class="line">  <span class="attr">accessCode:</span> <span class="string">a4fKpE5zbk0nbGNJU0d1bKkJNRZxQzlp</span></span><br><span class="line">  <span class="attr">queueName:</span> <span class="string">DefaultQueue</span>   <span class="comment">#默认无需改动</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>AK&#x2F;SK认证：通过AK（Access Key ID）&#x2F;SK（Secret Access Key)加密调用请求</p>
</blockquote>
<ul>
<li>ak和sk是华为云身份凭证，需要新增一个访问密钥，操作如下：</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/2e654f5c-b28c-49c4-95b4-e7559a26450b.png" alt="2e654f5c-b28c-49c4-95b4-e7559a26450b"></p>
<p><img src="/img/loading.gif" data-original="/img/assests/59673002-fa3b-4f37-b761-293efd3d74bc.png" alt="59673002-fa3b-4f37-b761-293efd3d74bc"></p>
<p><img src="/img/loading.gif" data-original="/img/assests/ab3f2d53-2381-4468-9f44-14727ce04fec.png" alt="ab3f2d53-2381-4468-9f44-14727ce04fec"></p>
<ul>
<li>endpoint  请在控制台的”总览”界面的”接入信息”中查看“应用侧”的https接入地址。</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/324f53ef-fbe5-4d24-ad3c-dee1d25c29b0.png" alt="324f53ef-fbe5-4d24-ad3c-dee1d25c29b0"></p>
<ul>
<li>projectId项目ID，<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_1001.html">获取项目ID</a></li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/e0b04007-6ea9-4df9-a636-8a7042714018.png" alt="e0b04007-6ea9-4df9-a636-8a7042714018"></p>
<ul>
<li>host是AMQP访问的地址，获取方式如下：</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/60bb5d21-b5ef-447d-b070-1019a0605b70.png" alt="60bb5d21-b5ef-447d-b070-1019a0605b70"></p>
<ul>
<li>accessKey和accessCode从<strong>预置接入凭证</strong>获取</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/5a064d48-1754-4134-a934-30e74b600e8c.png" alt="5a064d48-1754-4134-a934-30e74b600e8c"></p>
<ul>
<li>在zzyl-framework中新增HuaWeiIotConfigProperties 来读取配置文件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.framework.config.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itheima</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;huaweicloud&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HuaWeiIotConfigProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问Key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String ak;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问秘钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sk;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区域id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String regionId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用侧https接入地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 项目id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String projectId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用侧amqp接入地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * amqp连接端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">5671</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * amqp接入凭证键值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * amqp接入凭证密钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String accessCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定单个进程启动的连接数</span></span><br><span class="line">    <span class="comment">// 单个连接消费速率有限，请参考使用限制，最大64个连接</span></span><br><span class="line">    <span class="comment">// 连接数和消费速率及rebalance相关，建议每500QPS增加一个连接</span></span><br><span class="line">    <span class="comment">//可根据实际情况自由调节，目前测试和正式环境资源有限，限制更改为4</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">connectionCount</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String queueName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开门命令所属服务id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String smartDoorServiceId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开门记录属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String doorOpenPropertyName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开门命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String doorOpenCommandName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置临时密码命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String passwordSetCommandName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 仅支持true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">useSsl</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IoTDA仅支持default</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">vhost</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IoTDA仅支持PLAIN</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">saslMechanisms</span> <span class="operator">=</span> <span class="string">&quot;PLAIN&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * true: SDK自动ACK（默认）</span></span><br><span class="line"><span class="comment">     * false:收到消息后，需要手动调用message.acknowledge()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isAutoAcknowledge</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重连时延（ms）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">reconnectDelay</span> <span class="operator">=</span> <span class="number">3000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最大重连时延（ms）,随着重连次数增加重连时延逐渐增加</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxReconnectDelay</span> <span class="operator">=</span> <span class="number">30</span> * <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最大重连次数,默认值-1，代表没有限制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxReconnectAttempts</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 空闲超时，对端在这个时间段内没有发送AMQP帧则会导致连接断开。默认值为30000。单位：毫秒。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">idleTimeout</span> <span class="operator">=</span> <span class="number">30</span> * <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The values below control how many messages the remote peer can send to the client and be held in a pre-fetch buffer for each consumer instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">queuePrefetch</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扩展参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; extendedOptions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在zzyl-framework中添加如下配置：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.framework.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.core.auth.BasicCredentials;</span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.core.auth.ICredential;</span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.core.region.Region;</span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.iotda.v5.IoTDAClient;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.framework.config.properties.HuaWeiIotConfigProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IotClientConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HuaWeiIotConfigProperties huaWeiIotConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IoTDAClient <span class="title function_">huaWeiIotInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ICredential</span> <span class="variable">auth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCredentials</span>()</span><br><span class="line">                .withAk(huaWeiIotConfigProperties.getAk())</span><br><span class="line">                .withSk(huaWeiIotConfigProperties.getSk())</span><br><span class="line">                <span class="comment">// 标准版/企业版需要使用衍生算法，基础版请删除配置&quot;withDerivedPredicate&quot;</span></span><br><span class="line">                .withDerivedPredicate(BasicCredentials.DEFAULT_DERIVED_PREDICATE)</span><br><span class="line">                .withProjectId(huaWeiIotConfigProperties.getProjectId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> IoTDAClient.newBuilder()</span><br><span class="line">                .withCredential(auth)</span><br><span class="line">                <span class="comment">// 标准版/企业版：需自行创建Region对象，基础版：请使用IoTDARegion的region对象，如&quot;withRegion(IoTDARegion.CN_NORTH_4)&quot;</span></span><br><span class="line">                .withRegion(<span class="keyword">new</span> <span class="title class_">Region</span>(huaWeiIotConfigProperties.getRegionId(), huaWeiIotConfigProperties.getEndpoint()))</span><br><span class="line">                <span class="comment">// .withRegion(IoTDARegion.CN_NORTH_4)</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试，在zzyl-admin模块下创建单元测试，查询产品列表，<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0080.html">接口说明</a></p>
<p>详细代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.iotda.v5.IoTDAClient;</span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.iotda.v5.model.ListProductsRequest;</span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.iotda.v5.model.ListProductsResponse;</span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.iotda.v5.model.Page;</span><br><span class="line"><span class="keyword">import</span> com.huaweicloud.sdk.iotda.v5.model.ProductSummary;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IoTDeviceTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IoTDAClient client;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询公共实例下的所有产品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">selectProduceList</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ListProductsRequest</span> <span class="variable">listProductsRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListProductsRequest</span>();</span><br><span class="line">        listProductsRequest.setLimit(<span class="number">50</span>);</span><br><span class="line">        <span class="type">ListProductsResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.listProducts(listProductsRequest);</span><br><span class="line">        List&lt;ProductSummary&gt; products = response.getProducts();</span><br><span class="line">        System.out.println(products);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="功能实现-1"><a href="#功能实现-1" class="headerlink" title="功能实现"></a>功能实现</h2><h3 id="基础代码准备-1"><a href="#基础代码准备-1" class="headerlink" title="基础代码准备"></a>基础代码准备</h3><p>按照之前的思路，使用代码生成的功能来生成代码</p>
<ul>
<li>包名:<code>com.zzyl.nursing</code></li>
<li>模块名：<code>nursing</code></li>
</ul>
<p><strong>只拷贝后端代码到idea中</strong></p>
<p><strong>同时删除DeviceController中除了list方法之外的其他方法，如下代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 智能设备Controller</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025-06-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/nursing/device&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;智能设备的接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeviceController</span> <span class="keyword">extends</span> <span class="title class_">BaseController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDeviceService deviceService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询设备列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;elder:device:list&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;查询设备列表&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> TableDataInfo <span class="title function_">list</span><span class="params">(Device device)</span> &#123;</span><br><span class="line">        startPage();</span><br><span class="line">        List&lt;Device&gt; list = deviceService.selectDeviceList(device);</span><br><span class="line">        <span class="keyword">return</span> getDataTable(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="从物联网平台同步产品列表"><a href="#从物联网平台同步产品列表" class="headerlink" title="从物联网平台同步产品列表"></a>从物联网平台同步产品列表</h3><ol>
<li><strong>思路分析</strong>：</li>
</ol>
<p>前四个接口，分别是：从物联网平台同步产品列表、查询所有产品列表、注册设备、分页查询设备列表，这四个接口都与产品有关系</p>
<ul>
<li>物联网中的产品是在物理网平台进行维护的，设备是在养老项目后台管理并同步到物联网平台的</li>
<li>其中注册设备、分页查询设备列表都需要用到产品数据</li>
</ul>
<p>由于以上两条原因，需要先让物联网平台的产品数据同步到后台，然后再被注册设备、分页查询设备列表这两个接口所引用</p>
<p>以下就是物联网产品与养老后台同步的思路</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (35).png" alt="whiteboard_exported_image (35)" style="zoom:50%;" />



<ol start="2">
<li><strong>接口定义：</strong></li>
</ol>
<p>在DeviceController定义同步的方法，详细如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(<span class="string">&quot;/syncProductList&quot;</span>)</span><br><span class="line">@ApiOperation(value = <span class="string">&quot;从物联网平台同步产品列表&quot;</span>)</span><br><span class="line">public AjaxResult syncProductList() <span class="punctuation">&#123;</span></span><br><span class="line">    deviceService.syncProductList();</span><br><span class="line">    return success();</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<ol start="3">
<li><strong>业务层：</strong></li>
</ol>
<p>在IDeviceService类中定义同步的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从物联网平台同步产品列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">syncProductList</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>实现类的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IoTDAClient client;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步产品列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncProductList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 请求参数</span></span><br><span class="line">    <span class="type">ListProductsRequest</span> <span class="variable">listProductsRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListProductsRequest</span>();</span><br><span class="line">    <span class="comment">// 设置条数</span></span><br><span class="line">    listProductsRequest.setLimit(<span class="number">50</span>);</span><br><span class="line">    <span class="comment">// 发起请求</span></span><br><span class="line">    <span class="type">ListProductsResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.listProducts(listProductsRequest);</span><br><span class="line">    <span class="keyword">if</span>(response.getHttpStatusCode() != <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;物联网接口 - 查询产品，同步失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 存储到redis</span></span><br><span class="line">    redisTemplate.opsForValue().set(CacheConstants.IOT_ALL_PRODUCT_LIST, JSONUtil.toJsonStr(response.getProducts()));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中的缓存常量，可以自己定义</p>
<p>public static final String <em>IOT_ALL_PRODUCT_LIST</em>&#x3D; “iot:all_product_list”;</p>
</blockquote>
<h3 id="查询所有产品列表"><a href="#查询所有产品列表" class="headerlink" title="查询所有产品列表"></a>查询所有产品列表</h3><ol>
<li><strong>接口定义：</strong></li>
</ol>
<p>在DeviceController中新增方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;查询所有产品列表&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/allProduct&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R&lt;List&lt;ProductVo&gt;&gt; <span class="title function_">allProduct</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;ProductVo&gt; list = deviceService.allProduct();</span><br><span class="line">    <span class="keyword">return</span> R.ok(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="2">
<li><strong>业务层：</strong></li>
</ol>
<p>在DeviceService中新增方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有产品列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 产品列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;ProductVo&gt; <span class="title function_">allProduct</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>ProductVo </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 产品信息响应模型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itcast</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;产品信息响应模型&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductVo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产品的ProductKey,物联网平台产品唯一标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;产品的ProductKey,物联网平台产品唯一标识&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产品名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;产品名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有产品列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ProductVo&gt; <span class="title function_">allProduct</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 从redis中查询数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> redisTemplate.opsForValue().get(CacheConstants.IOT_ALL_PRODUCT_LIST);</span><br><span class="line">    <span class="comment">// 如果数据为空，则返回一个空集合</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(jsonStr))&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析数据，并返回</span></span><br><span class="line">    <span class="keyword">return</span> JSONUtil.toList(jsonStr, ProductVo.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="查询已经入住的老人列表"><a href="#查询已经入住的老人列表" class="headerlink" title="查询已经入住的老人列表"></a>查询已经入住的老人列表</h3><p>当新增设备的时候，如果选择的的<strong>随身设备</strong>，则会弹窗选择已经入住的老人，如下图</p>
<p><img src="/img/loading.gif" data-original="/img/assests/bca0ce3d-8ce0-4f86-a0b0-c679b3b5d137.png" alt="bca0ce3d-8ce0-4f86-a0b0-c679b3b5d137"></p>
<p>该接口已经在之前的代码生成中完成了</p>
<h3 id="注册设备接口"><a href="#注册设备接口" class="headerlink" title="注册设备接口"></a>注册设备接口</h3><ol>
<li><strong>思路分析：</strong></li>
</ol>
<p>整体思路如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (36).png" alt="whiteboard_exported_image (36)" style="zoom: 33%;" />

<ol start="2">
<li><strong>接口定义：</strong></li>
</ol>
<p>在DeviceController中新增方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;注册设备&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">registerDevice</span><span class="params">(<span class="meta">@RequestBody</span> DeviceDto deviceDto)</span> &#123;</span><br><span class="line">    deviceService.registerDevice(deviceDto);</span><br><span class="line">    <span class="keyword">return</span> success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于接口文档，定义DeviceDto，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.dto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value = &quot;设备注册参数&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeviceDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 备注 */</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设备标识码，通常使用IMEI、MAC地址或Serial No作为node_id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备标识码&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String nodeId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String iotId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;产品的id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String productKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;产品名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;位置名称回显字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String deviceDescription;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;位置类型 0 老人 1位置&quot;)</span></span><br><span class="line">    Integer locationType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;绑定位置&quot;)</span></span><br><span class="line">    Long bindingLocation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备名称&quot;)</span></span><br><span class="line">    String deviceName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;物理位置类型 -1 老人 0楼层 1房间 2床位&quot;)</span></span><br><span class="line">    Integer physicalLocationType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="3">
<li><strong>业务层：</strong></li>
</ol>
<p>在IDeviceService接口中新增方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册设备</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deviceDto</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">registerDevice</span><span class="params">(DeviceDto deviceDto)</span>;</span><br></pre></td></tr></table></figure>

<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册设备</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerDevice</span><span class="params">(DeviceDto dto)</span> &#123;</span><br><span class="line">    <span class="comment">// 判断设备名称是否存在</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> count(Wrappers.&lt;Device&gt;lambdaQuery().eq(Device::getDeviceName, dto.getDeviceName()));</span><br><span class="line">    <span class="keyword">if</span>(count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;设备名称已存在，请重新输入&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断设备标识是否存在</span></span><br><span class="line">    count = count(Wrappers.&lt;Device&gt;lambdaQuery().eq(Device::getNodeId, dto.getNodeId()));</span><br><span class="line">    <span class="keyword">if</span>(count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;设备标识码已存在，请重新输入&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断同一位置是否绑定了相同的产品</span></span><br><span class="line">    count = count(Wrappers.&lt;Device&gt;lambdaQuery()</span><br><span class="line">            .eq(Device::getProductKey, dto.getProductKey())</span><br><span class="line">            .eq(Device::getBindingLocation, dto.getBindingLocation())</span><br><span class="line">            .eq(Device::getLocationType, dto.getLocationType())</span><br><span class="line">            .eq(dto.getPhysicalLocationType() != <span class="literal">null</span>, Device::getPhysicalLocationType, dto.getPhysicalLocationType()));</span><br><span class="line">    <span class="keyword">if</span>(count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;该老人/位置已绑定该产品，请重新选择&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册设备---&gt;IoT平台</span></span><br><span class="line">    <span class="type">AddDeviceRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddDeviceRequest</span>();</span><br><span class="line">    <span class="type">AddDevice</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddDevice</span>();</span><br><span class="line">    body.withProductId(dto.getProductKey());</span><br><span class="line">    body.withDeviceName(dto.getDeviceName());</span><br><span class="line">    body.withNodeId(dto.getNodeId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 秘钥设置</span></span><br><span class="line">    <span class="type">AuthInfo</span> <span class="variable">authInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    authInfo.withSecret(secret);</span><br><span class="line">    body.setAuthInfo(authInfo);</span><br><span class="line">    request.setBody(body);</span><br><span class="line"></span><br><span class="line">    AddDeviceResponse response;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = client.addDevice(request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;物联网接口 - 注册设备，调用失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 本地保存设备</span></span><br><span class="line">    <span class="comment">// 属性拷贝</span></span><br><span class="line">    <span class="type">Device</span> <span class="variable">device</span> <span class="operator">=</span> BeanUtil.toBean(dto, Device.class);</span><br><span class="line">    <span class="comment">// 秘钥</span></span><br><span class="line">    device.setSecret(secret);</span><br><span class="line">    <span class="comment">// 设备id、设备绑定状态</span></span><br><span class="line">    device.setIotId(response.getDeviceId());</span><br><span class="line">    save(device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>主要的业务逻辑分为三部分：第一部分用于校验属性重复，第二部分用于注册设备，最后一部分保存设备信息</p>
</blockquote>
<h3 id="分页查询设备列表"><a href="#分页查询设备列表" class="headerlink" title="分页查询设备列表"></a>分页查询设备列表</h3><p>该接口在生成的代码中已经实现</p>
<p>其中的搜索条件，需要在后台添加数据字典：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/813081df-3f6f-461a-b8f4-ea42c81083a3.png" alt="813081df-3f6f-461a-b8f4-ea42c81083a3"></p>
<p>最终效果：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/0a335ad2-d5cc-475c-9e83-b8f51bf8990c.png" alt="0a335ad2-d5cc-475c-9e83-b8f51bf8990c"></p>
<h3 id="查询设备详细数据"><a href="#查询设备详细数据" class="headerlink" title="查询设备详细数据"></a>查询设备详细数据</h3><ol>
<li>思路分析</li>
</ol>
<p>这里的查询是有两部分数据的，第一部分是数据库中存储的设备数据，第二部分是物联网中的设备数据，查询流程如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (37).png" alt="whiteboard_exported_image (37)" style="zoom:50%;" />



<ol start="2">
<li>接口定义</li>
</ol>
<p>在DeviceController中定义方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取设备详细信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;iotId&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;获取设备详细信息&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;iotId&quot;)</span> String iotId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> success(deviceService.queryDeviceDetail(iotId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>业务层</li>
</ol>
<p>在DeviceService中新增方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询设备详情</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> iotId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DeviceDetailVo <span class="title function_">queryDeviceDetail</span><span class="params">(String iotId)</span>;</span><br></pre></td></tr></table></figure>

<p><em>DeviceDetailVo</em>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.common.annotation.Excel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;设备详情响应模型&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeviceDetailVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设备id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 物联网设备id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;物联网设备id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String iotId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设备名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String deviceName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设备标识码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备标识码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String nodeId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设备秘钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备秘钥&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;产品id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String productKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产品名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;产品名称&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String productName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 位置类型 0 随身设备 1固定设备</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;位置类型 0 随身设备 1固定设备&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer locationType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定位置,如果是随身设备为老人id，如果是固定设备为位置的最后一级id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;绑定位置,如果是随身设备为老人id，如果是固定设备为位置的最后一级id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long bindingLocation;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接入位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;接入位置&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设备状态，ONLINE：设备在线，OFFLINE：设备离线，ABNORMAL：设备异常，INACTIVE：设备未激活，FROZEN：设备冻结</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备状态，ONLINE：设备在线，OFFLINE：设备离线，ABNORMAL：设备异常，INACTIVE：设备未激活，FROZEN：设备冻结&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String deviceStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 激活时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;激活时间,格式：yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime activeTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;创建时间,格式：yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;创建人id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long createBy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;创建人名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String creator;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 位置备注 */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;位置备注&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String deviceDescription;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DeviceDetailVo <span class="title function_">queryDeviceDetail</span><span class="params">(String iotId)</span> &#123;</span><br><span class="line">    <span class="comment">// 查询本地设备数据</span></span><br><span class="line">    <span class="type">Device</span> <span class="variable">device</span> <span class="operator">=</span> getOne(Wrappers.&lt;Device&gt;lambdaQuery().eq(Device::getIotId, iotId));</span><br><span class="line">    <span class="keyword">if</span>(ObjectUtil.isEmpty(device)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用华为云接口查询设备详情</span></span><br><span class="line">    <span class="type">ShowDeviceRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShowDeviceRequest</span>();</span><br><span class="line">    request.setDeviceId(iotId);</span><br><span class="line">    ShowDeviceResponse response;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = client.showDevice(request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;物联网接口 - 查询设备详情，调用失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 属性拷贝</span></span><br><span class="line">    <span class="type">DeviceDetailVo</span> <span class="variable">deviceVo</span> <span class="operator">=</span> BeanUtil.toBean(device, DeviceDetailVo.class);</span><br><span class="line">    deviceVo.setDeviceStatus(response.getStatus());</span><br><span class="line">    <span class="type">String</span> <span class="variable">activeTimeStr</span> <span class="operator">=</span> response.getActiveTime();</span><br><span class="line">    <span class="comment">// 日期转换</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(activeTimeStr)) &#123;</span><br><span class="line">        <span class="comment">// 把字符串转换为LocalDateTime</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">activeTime</span> <span class="operator">=</span> LocalDateTimeUtil.parse(activeTimeStr, DatePattern.UTC_MS_PATTERN);</span><br><span class="line">        <span class="comment">// 日期时区转换</span></span><br><span class="line">        deviceVo.setActiveTime(DateTimeZoneConverter.utcToShanghai(activeTime));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deviceVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从本章资料可以找到日期转换工具类<em>DateTimeZoneConverter</em></p>
</blockquote>
<h3 id="查看设备上报的数据（设备影子）"><a href="#查看设备上报的数据（设备影子）" class="headerlink" title="查看设备上报的数据（设备影子）"></a>查看设备上报的数据（设备影子）</h3><ol>
<li><strong>接口定义：</strong></li>
</ol>
<ul>
<li>华为云接口文档：<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0079.html">https://support.huaweicloud.com/api-iothub/iot_06_v5_0079.html</a></li>
</ul>
<p>在DeviceController中新增方法，如下：</p>
<p>接收的参数就是<strong>接口的请求参数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询设备上报数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/queryServiceProperties/&#123;iotId&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询设备上报数据&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">queryServiceProperties</span><span class="params">(<span class="meta">@PathVariable(&quot;iotId&quot;)</span> String iotId)</span> &#123;</span><br><span class="line">    <span class="type">AjaxResult</span> <span class="variable">ajaxResult</span> <span class="operator">=</span> deviceService.queryServiceProperties(iotId);</span><br><span class="line">    <span class="keyword">return</span> ajaxResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>业务层：</strong></li>
</ol>
<p>在IDeviceService中定义新的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询设备上报数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> iotId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">AjaxResult <span class="title function_">queryServiceProperties</span><span class="params">(String iotId)</span>;</span><br></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">queryServiceProperties</span><span class="params">(String iotId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ShowDeviceShadowRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShowDeviceShadowRequest</span>();</span><br><span class="line">    request.setDeviceId(iotId);</span><br><span class="line">    <span class="type">ShowDeviceShadowResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.showDeviceShadow(request);</span><br><span class="line">    <span class="keyword">if</span>(response.getHttpStatusCode() != <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;物联网接口 - 查询设备影子，调用失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;DeviceShadowData&gt; shadow = response.getShadow();</span><br><span class="line">    <span class="keyword">if</span>(CollUtil.isEmpty(shadow)) &#123;</span><br><span class="line">        List&lt;Object&gt; emptyList = Collections.emptyList();</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.success(emptyList);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取上报数据的reported （参考返回的json数据）</span></span><br><span class="line">    <span class="type">DeviceShadowProperties</span> <span class="variable">reported</span> <span class="operator">=</span> shadow.get(<span class="number">0</span>).getReported();</span><br><span class="line">    <span class="comment">// 把数据转换为JSONObject(map)，方便处理</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONUtil.parseObj(reported.getProperties());</span><br><span class="line">    <span class="comment">// 遍历数据，封装到list中</span></span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt;  list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 事件上报时间</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">eventTimeStr</span> <span class="operator">=</span> reported.getEventTime();</span><br><span class="line">    <span class="comment">// 把字符串转换为LocalDateTime</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">eventTimeLocalDateTime</span> <span class="operator">=</span> LocalDateTimeUtil.parse(eventTimeStr, <span class="string">&quot;yyyyMMdd&#x27;T&#x27;HHmmss&#x27;Z&#x27;&quot;</span>);</span><br><span class="line">    <span class="comment">// 时区转换</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">eventTime</span> <span class="operator">=</span> DateTimeZoneConverter.utcToShanghai(eventTimeLocalDateTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// k:属性标识，v:属性值</span></span><br><span class="line">    jsonObject.forEach((k,v) -&gt; &#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;functionId&quot;</span>, k);</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, v);</span><br><span class="line">        map.put(<span class="string">&quot;eventTime&quot;</span>, eventTime);</span><br><span class="line">        list.add(map);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据返回</span></span><br><span class="line">    <span class="keyword">return</span> AjaxResult.success(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里利用的是Map构造返回值，而不是使用实体类（实体类也是可以的）</p>
</blockquote>
<h1 id="接收设备端数据"><a href="#接收设备端数据" class="headerlink" title="接收设备端数据"></a>接收设备端数据</h1><p>前置内容：智能检测-数据处理展示</p>
<p>整体的接收数据思路如下：</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (42).png" alt="whiteboard_exported_image (42)" style="zoom:80%;" />



<h2 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h2><p><img src="/img/loading.gif" data-original="/img/assests/34d49a12-d850-4281-ad90-0ed8758e8f67.png" alt="34d49a12-d850-4281-ad90-0ed8758e8f67"></p>
<h2 id="基础代码生成"><a href="#基础代码生成" class="headerlink" title="基础代码生成"></a>基础代码生成</h2><p>使用代码生成的功能，来生成代码</p>
<ul>
<li>包名:<code>com.zzyl.nursing</code></li>
<li>模块名：<code>nursing</code></li>
<li>除了主键之外的Long类型，改为Integer</li>
<li>数据上报时间字段改为LocalDateTime类型</li>
<li>生成业务名称：data</li>
<li>生成功能名称：设备数据</li>
</ul>
<p><strong>只拷贝后端代码到idea中</strong></p>
<p>修改DeviceData表，添加三个注解，方便使用<strong>构建者设计模式</strong>来构建对象，如下图：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/296770ca-53e9-4815-828a-3437cb6e8c2c.png" alt="296770ca-53e9-4815-828a-3437cb6e8c2c"></p>
<h2 id="功能实现-2"><a href="#功能实现-2" class="headerlink" title="功能实现"></a>功能实现</h2><ol>
<li>思路分析</li>
</ol>
<p>接收到的数据格式如下，是一个json字符串，可以定义一个类来转换接收数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;device.property&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event&quot;</span><span class="punctuation">:</span> <span class="string">&quot;report&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20250706T023712Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event_time_ms&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-07-06T02:37:12.573Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c13e6473-2709-4f34-8017-3538d9c57ccd&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;notify_data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;header&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a7bb0103499749d984777860b53eadf6&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6864b04ed582f2001837367e_watch01&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;node_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;watch01&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6864b04ed582f2001837367e&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gateway_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6864b04ed582f2001837367e_watch01&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;watch_services&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;BodyTemp&quot;</span><span class="punctuation">:</span> <span class="number">36.8</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;HeartRate&quot;</span><span class="punctuation">:</span> <span class="number">5.9712353</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;xueyang&quot;</span><span class="punctuation">:</span> <span class="number">84.60445</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;BatteryPercentage&quot;</span><span class="punctuation">:</span> <span class="number">24.040668</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;event_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20250706T023712Z&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>重点关注：device_id、properties、event_time</p>
</blockquote>
<p>上述json的数据结构中，已经标明颜色的是重点要解析的，由于嵌套层级较多，需要定义多个类来进行接收，对应的类可以在本章资料中找到，如下图</p>
<p><img src="/img/loading.gif" data-original="/img/assests/be1f59a7-64b8-414f-b14d-bb1519b0e3e5.png" alt="be1f59a7-64b8-414f-b14d-bb1519b0e3e5"></p>
<p>在设备数据表中，一次上报需要保存一个设备的多个物模型数据</p>
<blockquote>
<p>比如，烟雾报警有三个物模型，那么当接收到一个数据上报的时候，就要保存三条数据到设备数据中</p>
</blockquote>
<ol start="2">
<li>修改AmqpClient类，解析json数据并调用设备数据的业务层，批量添加数据</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.text.CharSequenceUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ObjectUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.framework.config.properties.HuaWeiIotConfigProperties;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.job.vo.IotMsgNotifyData;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.service.IDeviceDataService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.qpid.jms.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.qpid.jms.message.JmsInboundMessageDispatch;</span><br><span class="line"><span class="keyword">import</span> org.apache.qpid.jms.transports.TransportOptions;</span><br><span class="line"><span class="keyword">import</span> org.apache.qpid.jms.transports.TransportSupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"><span class="keyword">import</span> java.text.MessageFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AmqpClient</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HuaWeiIotConfigProperties huaWeiIotConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 业务处理异步线程池，线程池参数可以根据您的业务特点调整，或者您也可以用其他异步方式处理接收到的消息。</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ExecutorService executorService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 控制台服务端订阅中消费组状态页客户端ID一栏将显示clientId参数。</span></span><br><span class="line">    <span class="comment">// 建议使用机器UUID、MAC地址、IP等唯一标识等作为clientId。便于您区分识别不同的客户端。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String clientId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clientId = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 参数说明，请参见AMQP客户端接入说明文档。</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; huaWeiIotConfigProperties.getConnectionCount(); i++) &#123;</span><br><span class="line">            <span class="comment">// 创建amqp连接</span></span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getConnection();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 加入监听者</span></span><br><span class="line">            ((JmsConnection) connection).addConnectionListener(myJmsConnectionListener);</span><br><span class="line">            <span class="comment">// 创建会话。</span></span><br><span class="line">            <span class="comment">// Session.CLIENT_ACKNOWLEDGE: 收到消息后，需要手动调用message.acknowledge()。</span></span><br><span class="line">            <span class="comment">// Session.AUTO_ACKNOWLEDGE: SDK自动ACK（推荐）。</span></span><br><span class="line">            <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            connection.start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建Receiver连接。</span></span><br><span class="line">            <span class="type">MessageConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> newConsumer(session, connection, huaWeiIotConfigProperties.getQueueName());</span><br><span class="line">            consumer.setMessageListener(messageListener);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;amqp  is started successfully, and will exit after server shutdown &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建amqp连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> amqp连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">connectionUrl</span> <span class="operator">=</span> generateConnectUrl();</span><br><span class="line">        <span class="type">JmsConnectionFactory</span> <span class="variable">cf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JmsConnectionFactory</span>(connectionUrl);</span><br><span class="line">        <span class="comment">// 信任服务端</span></span><br><span class="line">        <span class="type">TransportOptions</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransportOptions</span>();</span><br><span class="line">        to.setTrustAll(<span class="literal">true</span>);</span><br><span class="line">        cf.setSslContext(TransportSupport.createJdkSslContext(to));</span><br><span class="line">        <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> <span class="string">&quot;accessKey=&quot;</span> + huaWeiIotConfigProperties.getAccessKey();</span><br><span class="line">        cf.setExtension(JmsConnectionExtensions.USERNAME_OVERRIDE.toString(), (connection, uri) -&gt; &#123;</span><br><span class="line">            <span class="comment">// IoTDA的userName组成格式如下：“accessKey=$&#123;accessKey&#125;|timestamp=$&#123;timestamp&#125;”</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">newUserName</span> <span class="operator">=</span> userName;</span><br><span class="line">            <span class="keyword">if</span> (connection <span class="keyword">instanceof</span> JmsConnection) &#123;</span><br><span class="line">                newUserName = ((JmsConnection) connection).getUsername();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> newUserName + <span class="string">&quot;|timestamp=&quot;</span> + System.currentTimeMillis();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建连接。</span></span><br><span class="line">        <span class="keyword">return</span> cf.createConnection(userName, huaWeiIotConfigProperties.getAccessCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成amqp连接地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> amqp连接地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateConnectUrl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> MessageFormat.format(<span class="string">&quot;&#123;0&#125;://&#123;1&#125;:&#123;2&#125;&quot;</span>,</span><br><span class="line">                (huaWeiIotConfigProperties.isUseSsl() ? <span class="string">&quot;amqps&quot;</span> : <span class="string">&quot;amqp&quot;</span>),</span><br><span class="line">                huaWeiIotConfigProperties.getHost(),</span><br><span class="line">                String.valueOf(huaWeiIotConfigProperties.getPort()));</span><br><span class="line">        Map&lt;String, String&gt; uriOptions = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        uriOptions.put(<span class="string">&quot;amqp.vhost&quot;</span>, huaWeiIotConfigProperties.getVhost());</span><br><span class="line">        uriOptions.put(<span class="string">&quot;amqp.idleTimeout&quot;</span>, String.valueOf(huaWeiIotConfigProperties.getIdleTimeout()));</span><br><span class="line">        uriOptions.put(<span class="string">&quot;amqp.saslMechanisms&quot;</span>, huaWeiIotConfigProperties.getSaslMechanisms());</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; jmsOptions = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        jmsOptions.put(<span class="string">&quot;jms.prefetchPolicy.queuePrefetch&quot;</span>, String.valueOf(huaWeiIotConfigProperties.getQueuePrefetch()));</span><br><span class="line">        <span class="keyword">if</span> (CharSequenceUtil.isNotBlank(clientId)) &#123;</span><br><span class="line">            jmsOptions.put(<span class="string">&quot;jms.clientID&quot;</span>, clientId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            jmsOptions.put(<span class="string">&quot;jms.clientID&quot;</span>, UUID.randomUUID().toString());</span><br><span class="line">        &#125;</span><br><span class="line">        jmsOptions.put(<span class="string">&quot;failover.reconnectDelay&quot;</span>, String.valueOf(huaWeiIotConfigProperties.getReconnectDelay()));</span><br><span class="line">        jmsOptions.put(<span class="string">&quot;failover.maxReconnectDelay&quot;</span>, String.valueOf(huaWeiIotConfigProperties.getMaxReconnectDelay()));</span><br><span class="line">        <span class="keyword">if</span> (huaWeiIotConfigProperties.getMaxReconnectAttempts() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            jmsOptions.put(<span class="string">&quot;failover.maxReconnectAttempts&quot;</span>, String.valueOf(huaWeiIotConfigProperties.getMaxReconnectAttempts()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (huaWeiIotConfigProperties.getExtendedOptions() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; option : huaWeiIotConfigProperties.getExtendedOptions().entrySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (option.getKey().startsWith(<span class="string">&quot;amqp.&quot;</span>) || option.getKey().startsWith(<span class="string">&quot;transport.&quot;</span>)) &#123;</span><br><span class="line">                    uriOptions.put(option.getKey(), option.getValue());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    jmsOptions.put(option.getKey(), option.getValue());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        stringBuilder.append(uriOptions.entrySet().stream()</span><br><span class="line">                .map(option -&gt; MessageFormat.format(<span class="string">&quot;&#123;0&#125;=&#123;1&#125;&quot;</span>, option.getKey(), option.getValue()))</span><br><span class="line">                .collect(Collectors.joining(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;failover:(&quot;</span> + uri + <span class="string">&quot;?&quot;</span>, <span class="string">&quot;)&quot;</span>)));</span><br><span class="line">        stringBuilder.append(jmsOptions.entrySet().stream()</span><br><span class="line">                .map(option -&gt; MessageFormat.format(<span class="string">&quot;&#123;0&#125;=&#123;1&#125;&quot;</span>, option.getKey(), option.getValue()))</span><br><span class="line">                .collect(Collectors.joining(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;?&quot;</span>, <span class="string">&quot;&quot;</span>)));</span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建消费者</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session    session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> connection amqp连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueName  队列名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 消费者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> MessageConsumer <span class="title function_">newConsumer</span><span class="params">(Session session, Connection connection, String queueName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="literal">null</span> || !(connection <span class="keyword">instanceof</span> JmsConnection) || ((JmsConnection) connection).isClosed()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;create consumer failed,the connection is disconnected.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> session.createConsumer(<span class="keyword">new</span> <span class="title class_">JmsQueue</span>(queueName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">MessageListener</span> <span class="variable">messageListener</span> <span class="operator">=</span> message -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//异步处理收到的消息，确保onMessage函数里没有耗时逻辑</span></span><br><span class="line">            executorService.submit(() -&gt; processMessage(message));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;submit task occurs exception &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDeviceDataService deviceDataService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在这里处理您收到消息后的具体业务逻辑。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        String contentStr;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            contentStr = message.getBody(String.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> message.getStringProperty(<span class="string">&quot;topic&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">messageId</span> <span class="operator">=</span> message.getStringProperty(<span class="string">&quot;messageId&quot;</span>);</span><br><span class="line">            log.info(<span class="string">&quot;receive message,\n topic = &#123;&#125;,\n messageId = &#123;&#125;,\n content = &#123;&#125;&quot;</span>, topic, messageId, contentStr);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;服务器错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将消息转换为json格式，数据为空，直接返回</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonMsg</span> <span class="operator">=</span> JSONUtil.parseObj(contentStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取出消息中的notify_data字段，数据为空，直接返回</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonNotifyData</span> <span class="operator">=</span> jsonMsg.getJSONObject(<span class="string">&quot;notify_data&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isEmpty(jsonNotifyData)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将json字符串转换为对象，如果属性上报为空，程序结束</span></span><br><span class="line">        <span class="type">IotMsgNotifyData</span> <span class="variable">iotMsgNotifyData</span> <span class="operator">=</span> JSONUtil.toBean(jsonNotifyData, IotMsgNotifyData.class);</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isEmpty(iotMsgNotifyData.getBody()) || ObjectUtil.isEmpty(iotMsgNotifyData.getBody().getServices())) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        deviceDataService.batchInsertDeviceData(iotMsgNotifyData);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">JmsConnectionListener</span> <span class="variable">myJmsConnectionListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JmsConnectionListener</span>() &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 连接成功建立。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConnectionEstablished</span><span class="params">(URI remoteURI)</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;onConnectionEstablished, remoteUri:&#123;&#125;&quot;</span>, remoteURI);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 尝试过最大重试次数之后，最终连接失败。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConnectionFailure</span><span class="params">(Throwable error)</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;onConnectionFailure, &#123;&#125;&quot;</span>, error.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 连接中断。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConnectionInterrupted</span><span class="params">(URI remoteURI)</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;onConnectionInterrupted, remoteUri:&#123;&#125;&quot;</span>, remoteURI);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 连接中断后又自动重连上。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConnectionRestored</span><span class="params">(URI remoteURI)</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;onConnectionRestored, remoteUri:&#123;&#125;&quot;</span>, remoteURI);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onInboundMessage</span><span class="params">(JmsInboundMessageDispatch envelope)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSessionClosed</span><span class="params">(Session session, Throwable cause)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConsumerClosed</span><span class="params">(MessageConsumer consumer, Throwable cause)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProducerClosed</span><span class="params">(MessageProducer producer, Throwable cause)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a><strong>流程</strong></h2><img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (43).png" alt="whiteboard_exported_image (43)" style="zoom:50%;" />

<ol start="3">
<li>在设备数据的业务层定义批量添加的方法</li>
</ol>
<p>在IDeviceDataService中定义新的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量保存数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> iotMsgNotifyData</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">batchInsertDeviceData</span><span class="params">(IotMsgNotifyData iotMsgNotifyData)</span>;</span><br></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DeviceMapper deviceMapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量保存设备数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> iotMsgNotifyData</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchInsertDeviceData</span><span class="params">(IotMsgNotifyData iotMsgNotifyData)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">iotId</span> <span class="operator">=</span> iotMsgNotifyData.getHeader().getDeviceId();</span><br><span class="line">    <span class="comment">// 查询设备信息</span></span><br><span class="line">    <span class="type">Device</span> <span class="variable">device</span> <span class="operator">=</span> deviceMapper.selectOne(Wrappers.&lt;Device&gt;lambdaQuery().eq(Device::getIotId, iotId));</span><br><span class="line">    <span class="keyword">if</span>(ObjectUtil.isEmpty(device)) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;设备不存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 批量保存设备数据</span></span><br><span class="line">    iotMsgNotifyData.getBody().getServices().forEach(s -&gt; &#123;</span><br><span class="line">        <span class="comment">// 判断属性是否为空</span></span><br><span class="line">        Map&lt;String, Object&gt; properties = s.getProperties();</span><br><span class="line">        <span class="keyword">if</span>(CollUtil.isEmpty(properties)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上报时间处理</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">eventTimeStr</span> <span class="operator">=</span> s.getEventTime();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">localDateTime</span> <span class="operator">=</span> LocalDateTimeUtil.parse(eventTimeStr, <span class="string">&quot;yyyyMMdd&#x27;T&#x27;HHmmss&#x27;Z&#x27;&quot;</span>);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">eventTime</span> <span class="operator">=</span> DateTimeZoneConverter.utcToShanghai(localDateTime);</span><br><span class="line"></span><br><span class="line">        List&lt;DeviceData&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// key:属性id，value:属性值</span></span><br><span class="line">        properties.forEach((k,v) -&gt; &#123;</span><br><span class="line">            <span class="type">DeviceData</span> <span class="variable">deviceData</span> <span class="operator">=</span> BeanUtil.toBean(device, DeviceData.class);</span><br><span class="line">            deviceData.setId(<span class="literal">null</span>);</span><br><span class="line">            deviceData.setAlarmTime(eventTime);</span><br><span class="line">            deviceData.setFunctionId(k);</span><br><span class="line">            deviceData.setDataValue(v + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            list.add(deviceData);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 批量保存设备数据</span></span><br><span class="line">        saveBatch(list);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>AmqpClient 是通过消息队列接收华为IoT数据的后台服务，<strong>它运行在独立的线程中</strong>，不是Web请求线程。当这个线程中执行数据库操作时，会触发 MyMetaObjectHandler 的自动填充功能，但由于没有HTTP请求上下文，request 对象无法正常使用。需要修改一下MyMetaObjectHandler中的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public boolean isExclude() &#123;</span><br><span class="line">	// 当request无法正常获取到请求路径时，会抛出异常。如果抛出异常，就直接设置为true即可</span><br><span class="line">    try &#123;</span><br><span class="line">        String requestURI = request.getRequestURI();</span><br><span class="line">        if (requestURI.startsWith(&quot;/member&quot;)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="bug修复"><a href="#bug修复" class="headerlink" title="bug修复"></a>bug修复</h2><p>当设备增多后，数据库连接池可能会很快耗尽，可以适当增加连接数数量和等待时间</p>
<p>可能的错误提示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wait</span> millis 60003, active 20, maxActive 20, creating 0</span><br></pre></td></tr></table></figure>

<p><font color='red'>数据库连接池耗尽</font>，活跃连接数已达上限(maxActive&#x3D;20)，无可用连接且等待超时(60秒)，导致新请求无法获取连接</p>
<p>修改application.yml文件关于数据库的配置，如下标颜色内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="comment"># 主库数据源</span></span><br><span class="line">      <span class="attr">master:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.100.168:3306/zzyl?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">heima123</span></span><br><span class="line">      <span class="comment"># 从库数据源</span></span><br><span class="line">      <span class="attr">slave:</span></span><br><span class="line">        <span class="comment"># 从数据源开关/默认关闭</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">url:</span></span><br><span class="line">        <span class="attr">username:</span></span><br><span class="line">        <span class="attr">password:</span></span><br><span class="line">      <span class="comment"># 初始连接数</span></span><br><span class="line">      <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">      <span class="comment"># 最小连接池数量</span></span><br><span class="line">      <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">      <span class="comment"># 最大连接池数量</span></span><br><span class="line">      <span class="attr">maxActive:</span> <span class="number">60</span>   <span class="comment"># 提升最大连接数</span></span><br><span class="line">      <span class="comment"># 配置获取连接等待超时的时间</span></span><br><span class="line">      <span class="attr">maxWait:</span> <span class="number">120000</span>   <span class="comment"># 延长等待时间至2分钟</span></span><br><span class="line">      <span class="comment"># 配置连接超时时间</span></span><br><span class="line">      <span class="attr">connectTimeout:</span> <span class="number">30000</span></span><br><span class="line">      <span class="comment"># 配置网络超时时间</span></span><br><span class="line">      <span class="attr">socketTimeout:</span> <span class="number">60000</span></span><br><span class="line">      <span class="comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span></span><br><span class="line">      <span class="attr">timeBetweenEvictionRunsMillis:</span> <span class="number">60000</span></span><br><span class="line">      <span class="comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span></span><br><span class="line">      <span class="attr">minEvictableIdleTimeMillis:</span> <span class="number">300000</span></span><br><span class="line">      <span class="comment"># 配置一个连接在池中最大生存的时间，单位是毫秒</span></span><br><span class="line">      <span class="attr">maxEvictableIdleTimeMillis:</span> <span class="number">900000</span></span><br><span class="line">      <span class="comment"># 配置检测连接是否有效</span></span><br><span class="line">      <span class="attr">validationQuery:</span> <span class="string">SELECT</span> <span class="number">1</span> <span class="string">FROM</span> <span class="string">DUAL</span></span><br><span class="line">      <span class="attr">testWhileIdle:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">testOnBorrow:</span> <span class="literal">true</span>  <span class="comment"># 借出连接时校验有效性</span></span><br><span class="line">      <span class="attr">testOnReturn:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">webStatFilter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">statViewServlet:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 设置白名单，不填则允许所有访问</span></span><br><span class="line">        <span class="attr">allow:</span></span><br><span class="line">        <span class="attr">url-pattern:</span> <span class="string">/druid/*</span></span><br><span class="line">        <span class="comment"># 控制台管理用户名和密码</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">ruoyi</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment"># 慢SQL记录</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">1000</span></span><br><span class="line">          <span class="attr">merge-sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">wall:</span></span><br><span class="line">          <span class="attr">config:</span></span><br><span class="line">            <span class="attr">multi-statement-allow:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改了maxActive、maxWait、testOnBorrow</p>
</blockquote>
<h1 id="查询设备的物模型数据"><a href="#查询设备的物模型数据" class="headerlink" title="查询设备的物模型数据"></a>查询设备的物模型数据</h1><h2 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a>需求分析</h2><p>最终的效果：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/d5b49406-220f-493f-b6f0-648c28a66295.png" alt="d5b49406-220f-493f-b6f0-648c28a66295"></p>
<p>其中的数据值，是从IOT平台实时获取到的数据值</p>
<p>当点击了某个功能（物模型）的<strong>查看数据</strong>按钮，则会显示这个功能的历史数据，可以按照时间范围进行检索，如下图：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/500ba212-026e-4fad-8877-8c5a444eb29b.png" alt="500ba212-026e-4fad-8877-8c5a444eb29b"></p>
<p>时间范围&#x3D;1小时、24小时、7天</p>
<h2 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h2><p>参考接口文档：<a target="_blank" rel="noopener" href="https://rant7bdsfuy.feishu.cn/wiki/H7zewXWzfiYH4Mk1Mw9cCOujn9f">智能监测-接口文档</a></p>
<h2 id="功能实现-3"><a href="#功能实现-3" class="headerlink" title="功能实现"></a>功能实现</h2><h3 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h3><p>在DeviceDataController ，改造查询数据的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询设备数据列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;elder:data:list&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询设备数据列表&quot;)</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">list</span><span class="params">(DeviceDataPageReqDto deviceDataPageReqDto)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> deviceDataService.selectDeviceDataList(deviceDataPageReqDto);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 导出设备数据列表   删除这个方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;导出设备数据列表&quot;)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;nursing:deviceData:export&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@Log(title = &quot;设备数据&quot;, businessType = BusinessType.EXPORT)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/export&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(HttpServletResponse response, DeviceData deviceData)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;DeviceData&gt; list = deviceDataService.selectDeviceDataList(deviceData);</span><br><span class="line">    ExcelUtil&lt;DeviceData&gt; util = <span class="keyword">new</span> <span class="title class_">ExcelUtil</span>&lt;DeviceData&gt;(DeviceData.class);</span><br><span class="line">    util.exportExcel(response, list, <span class="string">&quot;设备数据数据&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DeviceDataPageReqDto </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;设备数据分页查询请求模型&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeviceDataPageReqDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备名称&quot;, required = false)</span></span><br><span class="line">    <span class="keyword">private</span> String deviceName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;功能ID&quot;, required = false)</span></span><br><span class="line">    <span class="keyword">private</span> String functionId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;开始时间&quot;, required = false)</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime startTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;结束时间&quot;, required = false)</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime endTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;页码&quot;, required = true, example = &quot;1&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;页面大小&quot;, required = true, example = &quot;10&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageSize;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="业务层-2"><a href="#业务层-2" class="headerlink" title="业务层"></a>业务层</h3><p>在IDeviceDataService接口，改造分页查询方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询设备数据列表</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deviceDataPageReqDto 设备数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 设备数据集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">selectDeviceDataList</span><span class="params">(DeviceDataPageReqDto deviceDataPageReqDto)</span>;</span><br></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询设备数据列表</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto 设备数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 设备数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">selectDeviceDataList</span><span class="params">(DeviceDataPageReqDto dto)</span> &#123;</span><br><span class="line"></span><br><span class="line">    LambdaQueryWrapper&lt;DeviceData&gt; lambdaQueryWrapper =  <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    Page&lt;DeviceData&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>(dto.getPageNum(), dto.getPageSize());</span><br><span class="line">    <span class="comment">// 模糊查询设备名称</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(dto.getDeviceName())) &#123;</span><br><span class="line">        lambdaQueryWrapper.eq(DeviceData::getDeviceName, dto.getDeviceName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 精确查询功能名称</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotEmpty(dto.getFunctionId())) &#123;</span><br><span class="line">        lambdaQueryWrapper.eq(DeviceData::getFunctionId, dto.getFunctionId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 时间范围查询</span></span><br><span class="line">    <span class="keyword">if</span>(ObjectUtils.isNotEmpty(dto.getStartTime()) &amp;&amp; ObjectUtils.isNotEmpty(dto.getEndTime())) &#123;</span><br><span class="line">        lambdaQueryWrapper.between(DeviceData::getAlarmTime, dto.getStartTime(), dto.getEndTime());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分页查询</span></span><br><span class="line">    page = page(page, lambdaQueryWrapper);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装分页对象</span></span><br><span class="line">    <span class="keyword">return</span> getTableDataInfo(page);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装分页对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotNull</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> TableDataInfo <span class="title function_">getTableDataInfo</span><span class="params">(Page&lt;DeviceData&gt; page)</span> &#123;</span><br><span class="line">    <span class="type">TableDataInfo</span> <span class="variable">tableData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TableDataInfo</span>();</span><br><span class="line">    tableData.setCode(HttpStatus.SUCCESS);</span><br><span class="line">    tableData.setMsg(<span class="string">&quot;查询成功&quot;</span>);</span><br><span class="line">    tableData.setRows(page.getRecords());</span><br><span class="line">    tableData.setTotal(page.getTotal());</span><br><span class="line">    <span class="keyword">return</span> tableData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="智能床位"><a href="#智能床位" class="headerlink" title="智能床位"></a>智能床位</h1><p>参考接口文档：<a target="_blank" rel="noopener" href="https://rant7bdsfuy.feishu.cn/wiki/H7zewXWzfiYH4Mk1Mw9cCOujn9f">智能监测-接口文档</a></p>
<p>数据准备：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/PixPin_2025-09-12_17-43-34.png" alt="PixPin_2025-09-12_17-43-34"></p>
<h2 id="获取所有楼层（智能楼层）"><a href="#获取所有楼层（智能楼层）" class="headerlink" title="获取所有楼层（智能楼层）"></a>获取所有楼层（智能楼层）</h2><h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><p>目的<strong>是为了展示绑定了智能设备的楼层和楼层下的房间、床位信息以及智能设备最近一次上报的数据</strong></p>
<p>比如下图中，只有3楼、4楼、5楼、1楼绑定了设备，那就只展示这些楼层</p>
<p><img src="/img/loading.gif" data-original="/img/assests/4c26fab4-095b-451f-a525-826ddf9fd9da.png" alt="4c26fab4-095b-451f-a525-826ddf9fd9da"></p>
<p>表关系</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (44).png" alt="whiteboard_exported_image (44)" style="zoom: 50%;" />

<p>目前设备的绑定都是<strong>房间</strong>或者是<strong>床位</strong></p>
<blockquote>
<p>比如：烟雾报警绑定的位置是房间，睡眠监测带绑定的位置是床位</p>
</blockquote>
<p>在设备（device）表中同时有三个字段确定绑定的位置</p>
<ul>
<li>location_type  位置类型   0：随身设备 1：固定设备</li>
<li>physical_location_type  物理位置类型   0楼层 1房间 2床位</li>
<li>binding_location   具体位置对应的id值（如果是房间，则是房间id，如果是床位，则对应床位id）</li>
</ul>
<p>5张表关联查询（floor、room、bed、device【房间|床位】），对应的sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> f.id, f.name, f.code</span><br><span class="line"><span class="keyword">from</span> floor f</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> room r <span class="keyword">on</span> f.id <span class="operator">=</span> r.floor_id</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> bed b <span class="keyword">on</span> r.id <span class="operator">=</span> b.room_id</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> device rd <span class="keyword">on</span> rd.binding_location <span class="operator">=</span> r.id <span class="keyword">and</span> rd.location_type <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> rd.physical_location_type <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> device bd <span class="keyword">on</span> bd.binding_location <span class="operator">=</span> b.id <span class="keyword">and</span> bd.location_type <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> bd.physical_location_type <span class="operator">=</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">where</span> (rd.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">or</span> bd.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> f.id;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述sql中的group by f.id 是为了去除重复数据</p>
</blockquote>
<h3 id="控制层-4"><a href="#控制层-4" class="headerlink" title="控制层"></a>控制层</h3><p>在FloorController中新增查询智能楼层的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getAllFloorsWithDevice&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询所有楼层（智能设备）&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R&lt;List&lt;FloorVo&gt;&gt; <span class="title function_">getAllFloorsWithDevice</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> R.ok(floorService.getAllFloorsWithDevice());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="业务层-3"><a href="#业务层-3" class="headerlink" title="业务层"></a>业务层</h3><p>在FloorService中新增查询智能楼层的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询智能楼层</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;FloorVo&gt; <span class="title function_">getAllFloorsWithDevice</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>对应的实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询智能楼层</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;FloorVo&gt; <span class="title function_">getAllFloorsWithDevice</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> floorMapper.getAllFloorsWithDevice();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="持久层"><a href="#持久层" class="headerlink" title="持久层"></a>持久层</h3><p>在FloorMapper中新增方法，无参</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;FloorVo&gt; <span class="title function_">getAllFloorsWithDevice</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>对应的映射文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;getAllFloorsWithDevice&quot;</span> resultType=<span class="string">&quot;com.zzyl.nursing.vo.FloorVo&quot;</span>&gt;</span><br><span class="line">    select f.id, f.name, f.code</span><br><span class="line">    from floor f</span><br><span class="line">             left join room r on f.id = r.floor_id</span><br><span class="line">             left join bed b on r.id = b.room_id</span><br><span class="line">             left join device rd on rd.binding_location = r.id and rd.location_type = <span class="number">1</span> and rd.physical_location_type = <span class="number">1</span></span><br><span class="line">             left join device bd on bd.binding_location = b.id and bd.location_type = <span class="number">1</span> and bd.physical_location_type = <span class="number">2</span></span><br><span class="line">    where (rd.id is not <span class="literal">null</span> or bd.id is not <span class="literal">null</span>)</span><br><span class="line">    group by f.id</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>



<h2 id="获取房间中的智能设备及数据"><a href="#获取房间中的智能设备及数据" class="headerlink" title="获取房间中的智能设备及数据"></a>获取房间中的智能设备及数据</h2><h3 id="思路分析-1"><a href="#思路分析-1" class="headerlink" title="思路分析"></a>思路分析</h3><ul>
<li>根据<strong>楼层ID</strong>查询房间或者是床位的设备数据（最新的一条数据）</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/9978fc8a-c437-4fc4-8620-0c8e62bfbd54.png" alt="9978fc8a-c437-4fc4-8620-0c8e62bfbd54"></p>
<p>在这个接口中返回的数据较多：</p>
<ul>
<li>房间数据以及房间绑定的设备、设备上报的数据</li>
<li>床位数据以及床位入住的老人姓名、绑定的设备、设备上报的数据</li>
</ul>
<p><strong>实现方案有两种</strong></p>
<ul>
<li>方案一：通过楼层关联房间、床位、老人、设备表2次、设备数据表2次共7张表查询对应的数据（设备数据表数据较多，效率不高），不推荐这种方案</li>
<li>方案二：使用缓存，因为只需要查询<strong>最近一次</strong>的设备数据，可以把最近一次采集的数据存储到redis中，然后让房间或者床位进行匹配</li>
</ul>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (45).png" alt="whiteboard_exported_image (45)" style="zoom:67%;" />

<p> 按照这种实现思路，需要改造上报数据的接收逻辑，将设备上报的数据保存到Redis中存储，将来需要展示设备最近一次上报的数据时只需从Redis中获取即可</p>
<h3 id="改造上报数据接收逻辑"><a href="#改造上报数据接收逻辑" class="headerlink" title="改造上报数据接收逻辑"></a>改造上报数据接收逻辑</h3><p>找到DeviceDataServiceImpl类中的batchInsertDeviceData方法，把每次上报的数据存储到Redis中，由于Redis保存数据的时候key相同的情况下可以覆盖旧数据，所以在Redis中存储的永远都是最新的数据</p>
<p>详细代码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量保存</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchInsertDeviceData</span><span class="params">(IotMsgNotifyData data)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据iotId查询设备</span></span><br><span class="line">    <span class="type">Device</span> <span class="variable">device</span> <span class="operator">=</span> deviceMapper.selectOne(Wrappers.&lt;Device&gt;lambdaQuery().eq(Device::getIotId, data.getHeader().getDeviceId()));</span><br><span class="line">    <span class="keyword">if</span>(ObjectUtil.isEmpty(device))&#123;</span><br><span class="line">        log.info(<span class="string">&quot;设备不存在，设备id：&#123;&#125;&quot;</span>,data.getHeader().getDeviceId());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建设备数据，可能会有多条</span></span><br><span class="line">    List&lt;IotMsgService&gt; services = data.getBody().getServices();</span><br><span class="line">    <span class="keyword">if</span>(CollUtil.isEmpty(services))&#123;</span><br><span class="line">        log.info(<span class="string">&quot;设备数据为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历services</span></span><br><span class="line">    services.forEach(s-&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理上报时间</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">eventTimeStr</span> <span class="operator">=</span> s.getEventTime();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">localDateTime</span> <span class="operator">=</span> LocalDateTimeUtil.parse(eventTimeStr, <span class="string">&quot;yyyyMMdd&#x27;T&#x27;HHmmss&#x27;Z&#x27;&quot;</span>);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">eventTime</span> <span class="operator">=</span> DateTimeZoneConverter.utcToShanghai(localDateTime);</span><br><span class="line"></span><br><span class="line">        List&lt;DeviceData&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        s.getProperties().forEach((k,v)-&gt;&#123;</span><br><span class="line">            <span class="comment">//属性拷贝，从设备拷贝到设备数据</span></span><br><span class="line">            <span class="type">DeviceData</span> <span class="variable">deviceData</span> <span class="operator">=</span> BeanUtil.toBean(device, DeviceData.class);</span><br><span class="line">            deviceData.setId(<span class="literal">null</span>);</span><br><span class="line">            deviceData.setCreateTime(<span class="literal">null</span>);</span><br><span class="line">            deviceData.setFunctionId(k);</span><br><span class="line">            deviceData.setDataValue(v+<span class="string">&quot;&quot;</span>);</span><br><span class="line">            deviceData.setAlarmTime(eventTime);</span><br><span class="line">            list.add(deviceData);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//批量保存</span></span><br><span class="line">        saveBatch(list);</span><br><span class="line">        redisTemplate.opsForHash().put(CacheConstants.IOT_DEVICE_LAST_DATA, device.getIotId(), JSONUtil.toJsonStr(list));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要在CacheConstants类中定义新的常量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static final String `*`IOT_DEVICE_LAST_DATA `*`= &quot;iot:device_last_data&quot;;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="查询基础数据"><a href="#查询基础数据" class="headerlink" title="查询基础数据"></a>查询基础数据</h3><p>按照前面分析的思路实现，结合接口需要的响应结果，需要准备基础数据并返回，基础数据就包括了房间、床位、老人、设备（房间或床位），其中的<strong>设备数据</strong>从Redis中获取</p>
<p><strong>查询基础的sql</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> r.<span class="operator">*</span>,  <span class="comment">-- 房间数据</span></span><br><span class="line">       b.id bid,<span class="comment">-- 床位数据</span></span><br><span class="line">       b.bed_number,</span><br><span class="line">       b.sort,</span><br><span class="line">       b.bed_status,</span><br><span class="line">       b.room_id,</span><br><span class="line">       b.create_by,</span><br><span class="line">       b.update_by,</span><br><span class="line">       b.remark,</span><br><span class="line">       b.create_time,</span><br><span class="line">       b.update_time,</span><br><span class="line">       e.name ename,<span class="comment">-- 老人数据</span></span><br><span class="line">       e.id eid,</span><br><span class="line">       d.id <span class="keyword">as</span> r_did,<span class="comment">-- 房间关联的设备</span></span><br><span class="line">       d.iot_id,</span><br><span class="line">       d.product_key <span class="keyword">as</span> product_key,</span><br><span class="line">       d.device_name,</span><br><span class="line">       d.product_name,</span><br><span class="line">       dd.id <span class="keyword">as</span> b_did,<span class="comment">-- 床位关联的设备</span></span><br><span class="line">       dd.iot_id b_iot_id,</span><br><span class="line">       dd.product_key <span class="keyword">as</span> b_product_key,</span><br><span class="line">       dd.device_name <span class="keyword">as</span> b_device_name,</span><br><span class="line">       dd.product_name <span class="keyword">as</span> b_product_name</span><br><span class="line"><span class="keyword">from</span> room r</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> bed b <span class="keyword">on</span> r.id <span class="operator">=</span> b.room_id</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> elder e <span class="keyword">on</span> b.id <span class="operator">=</span> e.bed_id</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> device d <span class="keyword">on</span> d.binding_location <span class="operator">=</span> r.id <span class="keyword">and</span> d.location_type <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> d.physical_location_type <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> device dd <span class="keyword">on</span> dd.binding_location <span class="operator">=</span> b.id <span class="keyword">and</span> dd.location_type <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> dd.physical_location_type <span class="operator">=</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">where</span> r.floor_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span>  (d.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">or</span> dd.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>)</span><br></pre></td></tr></table></figure>



<h3 id="根据接口文档中返回数据的样式修改Vo"><a href="#根据接口文档中返回数据的样式修改Vo" class="headerlink" title="根据接口文档中返回数据的样式修改Vo"></a>根据接口文档中返回数据的样式修改Vo</h3><ul>
<li>新建<code>DeviceInfo</code>来存储设备信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.domain.DeviceData;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModel(&quot;设备信息响应模型&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeviceInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;主键&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;物联网设备ID&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String iotId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String deviceName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;产品key&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String productKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;产品名称&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String productName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;设备数据&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;DeviceData&gt; deviceDataVos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中的设备数据<code>deviceDataVos</code>字段，是不需要从数据库中查询数据的，后面会到redis中查询设备数据</p>
</blockquote>
<ul>
<li>在<code>RoomVo</code>和<code>BedVo</code>中两个类中分别添加一个<code>deviceVos</code>设备集合属性</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关联的设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;DeviceInfo&gt; deviceVos;</span><br></pre></td></tr></table></figure>



<h3 id="控制层-5"><a href="#控制层-5" class="headerlink" title="控制层"></a>控制层</h3><p>根据接口中的路径分析，这个接口需要定义在RoomController中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getRoomsWithDeviceByFloorId/&#123;floorId&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;获取所有房间（智能床位）&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R&lt;List&lt;RoomVo&gt;&gt; <span class="title function_">getRoomsWithDeviceByFloorId</span><span class="params">(<span class="meta">@PathVariable(name = &quot;floorId&quot;)</span> Long floorId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> R.ok(roomService.getRoomsWithDeviceByFloorId(floorId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="持久层-1"><a href="#持久层-1" class="headerlink" title="持久层"></a>持久层</h3><p>这里需要使用MyBatis的多表查询，根据刚才的sql，其中的房间、床位、老人、房间设备、床位设备数据都要返回</p>
<p>在RoomMapper中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;RoomVo&gt; <span class="title function_">getRoomsWithDeviceByFloorId</span><span class="params">(Long floorId)</span>;</span><br></pre></td></tr></table></figure>



<h3 id="业务层-4"><a href="#业务层-4" class="headerlink" title="业务层"></a>业务层</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取所有房间（负责老人）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> floorId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;RoomVo&gt; <span class="title function_">getRoomsWithDeviceByFloorId</span><span class="params">(Long floorId)</span>;</span><br></pre></td></tr></table></figure>

<p>对应的实现方法，需要到redis中根据iotId匹配最新上报的设备数据</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> <span class="title class_">RedisTemplate</span>&lt;<span class="title class_">String</span>,<span class="title class_">String</span>&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询智能楼层的基础数据和设备上报的数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">floorId</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">RoomVo</span>&gt; <span class="title function_">getRoomsWithDeviceByFloorId</span>(<span class="params">Long floorId</span>) &#123;</span><br><span class="line"><span class="comment">//        redisTemplate.opsForHash().get(CacheConstants.IOT_DEVICE_LAST_DATA,&quot;&quot;);</span></span><br><span class="line">    <span class="comment">// SQL返回的数据是基础数据，找到的是房间、床位、设备（房间|床位）</span></span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">RoomVo</span>&gt; roomVos = roomMapper.<span class="title function_">getRoomsWithDeviceByFloorId</span>(floorId);</span><br><span class="line">    roomVos.<span class="title function_">forEach</span>(roomVo -&gt; &#123;</span><br><span class="line">        <span class="comment">// 遍历的是房间数据</span></span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">DeviceInfo</span>&gt; deviceVos = roomVo.<span class="title function_">getDeviceVos</span>();</span><br><span class="line">        <span class="comment">// 房间设备所对应的设备上报的数据</span></span><br><span class="line">        deviceVos.<span class="title function_">forEach</span>(deviceInfo -&gt; &#123;</span><br><span class="line">            <span class="title class_">String</span> jsonStr = (<span class="title class_">String</span>) redisTemplate.<span class="title function_">opsForHash</span>().<span class="title function_">get</span>(<span class="title class_">CacheConstants</span>.<span class="property">IOT_DEVICE_LAST_DATA</span>, deviceInfo.<span class="title function_">getIotId</span>());</span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">StringUtils</span>.<span class="title function_">isEmpty</span>(jsonStr)) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// 跳出本次循环，并不是结束方法</span></span><br><span class="line">            &#125;</span><br><span class="line">            deviceInfo.<span class="title function_">setDeviceDataVos</span>(<span class="title class_">JSON</span>Util.<span class="title function_">toList</span>(jsonStr, <span class="title class_">DeviceData</span>.<span class="property">class</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 遍历的是床位数据</span></span><br><span class="line">        roomVo.<span class="title function_">getBedVoList</span>().<span class="title function_">forEach</span>(bedVo -&gt; &#123;</span><br><span class="line">            <span class="comment">// 获取床位对应的设备列表</span></span><br><span class="line">            bedVo.<span class="title function_">getDeviceVos</span>().<span class="title function_">forEach</span>(deviceInfo -&gt; &#123;</span><br><span class="line">                <span class="title class_">String</span> jsonStr = (<span class="title class_">String</span>) redisTemplate.<span class="title function_">opsForHash</span>().<span class="title function_">get</span>(<span class="title class_">CacheConstants</span>.<span class="property">IOT_DEVICE_LAST_DATA</span>, deviceInfo.<span class="title function_">getIotId</span>());</span><br><span class="line">                <span class="keyword">if</span>(<span class="title class_">StringUtils</span>.<span class="title function_">isEmpty</span>(jsonStr)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>; <span class="comment">// 跳出本次循环，并不是结束方法</span></span><br><span class="line">                &#125;</span><br><span class="line">                deviceInfo.<span class="title function_">setDeviceDataVos</span>(<span class="title class_">JSON</span>Util.<span class="title function_">toList</span>(jsonStr, <span class="title class_">DeviceData</span>.<span class="property">class</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> roomVos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="报警管理和通知"><a href="#报警管理和通知" class="headerlink" title="报警管理和通知"></a>报警管理和通知</h1><h2 id="报警规则"><a href="#报警规则" class="headerlink" title="报警规则"></a>报警规则</h2><p>想要获取报警数据，必须先根据不同的设备，不同的物模型来定义报警规则</p>
<h3 id="新增报警规则"><a href="#新增报警规则" class="headerlink" title="新增报警规则"></a>新增报警规则</h3><p>先分析需求，打开原型图</p>
<p><img src="/img/loading.gif" data-original="/img/assests/43c3ca7d-a37f-48c9-a256-e407f36f655a.png" alt="43c3ca7d-a37f-48c9-a256-e407f36f655a"></p>
<p>数据来源：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/49764d49-edca-437a-9c7f-28e6b3f2e6c1.png" alt="49764d49-edca-437a-9c7f-28e6b3f2e6c1"></p>
<p>逻辑规则：</p>
<p>1）若多条报警规则是包含&#x2F;互斥关系时，只要符合报警规则时，就会产生一条报警数据；</p>
<p>例如：规则1: 手表电量 &gt;&#x3D;10 ，规则2:手表电量&lt; 50, 此时是包含关系，当手机电量&#x3D;40时，符合两条报警规则，则产生两条报警数据；</p>
<p>2）报警数据见下方示例，1分钟（数据聚合周期）检查一次智能手表（所属产品）中的全部设备（关联设备）的血氧（功能名称），</p>
<p>监控值（统计字段）是否 &lt; 90（运算符+阈值），当持续3个周期（持续周期）都满足这个规则时，触发报警；</p>
<p><img src="/img/loading.gif" data-original="/img/assests/66f20602-9055-470f-a03a-e176d41b5c1d.png" alt="66f20602-9055-470f-a03a-e176d41b5c1d"></p>
<p><strong>通知方式</strong>：</p>
<p>1）报警生效时间：报警规则的生效时间，报警规则只在生效时间内才会检查监控数据是否需要报警；</p>
<p>2）报警沉默周期：指报警发生后如果未恢复正常，重复发送报警通知的时间间隔；</p>
<p><strong>报警方式：</strong></p>
<p>1）当触发报警规则时，则发送消息通知，</p>
<p>2）通知对象：设备数据类型&#x3D;老人异常数据时，通知老人对应的护理员；设备数据类型&#x3D;设备异常数据时，通知后勤部维修工；</p>
<h3 id="报警规则其他需求"><a href="#报警规则其他需求" class="headerlink" title="报警规则其他需求"></a>报警规则其他需求</h3><p>下面展示的就是刚刚创建的报警规则查询列表</p>
<p><img src="/img/loading.gif" data-original="/img/assests/781f58d5-248a-4ab3-90b6-98db3f734d08.png" alt="781f58d5-248a-4ab3-90b6-98db3f734d08"></p>
<p>其中在操作中可以处理报警规则（删除，编辑，启用禁用）</p>
<h3 id="表结构-1"><a href="#表结构-1" class="headerlink" title="表结构"></a>表结构</h3><p><img src="/img/loading.gif" data-original="/img/assests/aead7b46-7823-4215-b42a-fb91460d9568.png" alt="aead7b46-7823-4215-b42a-fb91460d9568"></p>
<p><strong>报警规则建表语句：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> &quot;alert_rule&quot; (</span><br><span class="line">  &quot;id&quot; <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  &quot;product_key&quot; <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;所属产品的key&#x27;</span>,</span><br><span class="line">  &quot;product_name&quot; <span class="type">varchar</span>(<span class="number">500</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;产品名称&#x27;</span>,</span><br><span class="line">  &quot;module_id&quot; <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;模块的key&#x27;</span>,</span><br><span class="line">  &quot;module_name&quot; <span class="type">varchar</span>(<span class="number">500</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;模块名称&#x27;</span>,</span><br><span class="line">  &quot;function_name&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;功能名称&#x27;</span>,</span><br><span class="line">  &quot;function_id&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;功能标识&#x27;</span>,</span><br><span class="line">  &quot;iot_id&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;物联网设备id&#x27;</span>,</span><br><span class="line">  &quot;device_name&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;设备名称&#x27;</span>,</span><br><span class="line">  &quot;alert_data_type&quot; <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;报警数据类型，0：老人异常数据，1：设备异常数据&#x27;</span>,</span><br><span class="line">  &quot;alert_rule_name&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;告警规则名称&#x27;</span>,</span><br><span class="line">  &quot;operator&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;运算符&#x27;</span>,</span><br><span class="line">  &quot;value&quot; <span class="type">float</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;阈值&#x27;</span>,</span><br><span class="line">  &quot;duration&quot; <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;持续周期&#x27;</span>,</span><br><span class="line">  &quot;alert_effective_period&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;报警生效时段&#x27;</span>,</span><br><span class="line">  &quot;alert_silent_period&quot; <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;报警沉默周期&#x27;</span>,</span><br><span class="line">  &quot;status&quot; <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;0 禁用 1启用&#x27;</span>,</span><br><span class="line">  &quot;create_time&quot; datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  &quot;update_time&quot; datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  &quot;create_by&quot; <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人id&#x27;</span>,</span><br><span class="line">  &quot;update_by&quot; <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人id&#x27;</span>,</span><br><span class="line">  &quot;remark&quot; <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (&quot;id&quot;) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">53</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_unicode_ci ROW_FORMAT<span class="operator">=</span><span class="keyword">DYNAMIC</span>;</span><br></pre></td></tr></table></figure>



<h2 id="需求加强说明"><a href="#需求加强说明" class="headerlink" title="需求加强说明"></a>需求加强说明</h2><p>基于前面的报警规则，一旦有不符合预期的数据就会触发报警，产生报警数据，通知相关的负责人解决</p>
<h3 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h3><p>详细报警规则，如下图：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/f24573d6-b420-4845-8ecb-6297a899201e.png" alt="f24573d6-b420-4845-8ecb-6297a899201e"></p>
<ul>
<li>监测的产品为<strong>睡眠监测带</strong>，物模型为<strong>心率，</strong>过滤的是该产品下的<strong>所有设备</strong></li>
<li>报警类型为老人异常数据（设备报警通知<strong>老人绑定的护理员和超级管理员</strong>）</li>
<li>持续周期：<ul>
<li>持续1个周期（1周期&#x3D;1分钟）：表示触发报警之后，马上会保存报警数据</li>
<li><strong>持续</strong>3个周期（1周期&#x3D;1分钟）：表示触发报警之后，连续三次都是异常数据才会保存报警数据**</li>
<li>依此类推</li>
</ul>
</li>
<li>阈值为65，运算符为**&lt;：<strong>表示采集的</strong>心率数据如果小于65**就触发报警</li>
<li>沉默周期为5分钟，已经保存报警数据之后，如果后面有连续报警，5分钟之后再触发报警规则</li>
<li>报警生效时段为00:00:00~23:59:59：表示任意时段都会采集数据</li>
</ul>
<h3 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h3><p>报警规则如下图：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/4a09cdda-a2c8-48ca-a97f-d862009f7ecc.png" alt="4a09cdda-a2c8-48ca-a97f-d862009f7ecc"></p>
<ul>
<li>监测的产品为<strong>烟雾报警器</strong>，物模型为<strong>温度，</strong>过滤的是该产品下的全部设备</li>
<li>报警类型为<strong>设备异常数据</strong>（设备报警通知<strong>行政和超级管理员</strong>）</li>
<li>持续周期为<strong>持续1个周期（1后期&#x3D;1分钟）：表示触发报警之后，马上会保存报警数据</strong></li>
<li>阈值为<strong>55</strong>，运算符为**&gt;&#x3D;：<strong>表示采集的室内</strong>温度数据大于等于55**就触发报警</li>
<li>沉默周期为5分钟，已经保存报警数据之后，如果后面有连续报警，5分钟之后再触发报警规则</li>
<li>报警生效时段为00:00:00~23:59:59：表示任意时段都会采集数据</li>
</ul>
<h2 id="报警规则基础代码准备"><a href="#报警规则基础代码准备" class="headerlink" title="报警规则基础代码准备"></a>报警规则基础代码准备</h2><ul>
<li>包名:<code>com.zzyl.nursing</code></li>
<li>模块名：<code>nursing</code></li>
<li>生成业务名称：alertRule</li>
<li>生成功能名称：报警规则</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/481dacf6-3a22-49c2-8b71-cfecc08f3947.png" alt="481dacf6-3a22-49c2-8b71-cfecc08f3947"></p>
<ul>
<li>只需要拷贝后端代码</li>
<li>由于报警规则页面就是单表的增删改查，在若依代码生成功能生成的代码中所有功能都已经实现了，无需编写代码，但是要充分理解业务</li>
</ul>
<h2 id="查询产品详情接口"><a href="#查询产品详情接口" class="headerlink" title="查询产品详情接口"></a>查询产品详情接口</h2><h3 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h3><p>当新增报警规则的时候，需要选择产品中具体的功能，所以在选择产品之后需要查询到该产品下的服务列表及属性列表</p>
<p><img src="/img/loading.gif" data-original="/img/assests/2f2fe026-0e30-4176-ac39-7b01676dc833.png" alt="2f2fe026-0e30-4176-ac39-7b01676dc833"></p>
<h3 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h3><p>接口文档参考：<a target="_blank" rel="noopener" href="https://rant7bdsfuy.feishu.cn/wiki/H7zewXWzfiYH4Mk1Mw9cCOujn9f">智能监测-接口文档</a></p>
<p>华为云接口：<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/api-iothub/iot_06_v5_0052.html">https://support.huaweicloud.com/api-iothub/iot_06_v5_0052.html</a></p>
<p>在DeviceController定义新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/queryProduct/&#123;productKey&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;查询产品详情&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">queryProduct</span><span class="params">(<span class="meta">@PathVariable</span> String productKey)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> deviceService.queryProduct(productKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="业务层-5"><a href="#业务层-5" class="headerlink" title="业务层"></a>业务层</h3><p>在IDeviceService中定义新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询产品详情</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> productKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">AjaxResult <span class="title function_">queryProduct</span><span class="params">(String productKey)</span>;</span><br></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询产品详情</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> productKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">queryProduct</span><span class="params">(String productKey)</span> &#123;</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(productKey)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;请输入正确的参数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用华为云IOT平台接口</span></span><br><span class="line">    <span class="type">ShowProductRequest</span> <span class="variable">showProductRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShowProductRequest</span>();</span><br><span class="line">    showProductRequest.setProductId(productKey);</span><br><span class="line">    ShowProductResponse response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = client.showProduct(showProductRequest);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;查询产品详情失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否存在服务数据</span></span><br><span class="line">    List&lt;ServiceCapability&gt; serviceCapabilities = response.getServiceCapabilities();</span><br><span class="line">    <span class="keyword">if</span>(CollUtil.isEmpty(serviceCapabilities)) &#123;</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.success(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> AjaxResult.success(serviceCapabilities);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="报警数据过滤及处理"><a href="#报警数据过滤及处理" class="headerlink" title="报警数据过滤及处理"></a>报警数据过滤及处理</h2><h3 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h3><img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (46).png" alt="whiteboard_exported_image (46)" style="zoom:80%;" />



<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="负责老人功能介绍"><a href="#负责老人功能介绍" class="headerlink" title="负责老人功能介绍"></a>负责老人功能介绍</h4><ul>
<li>在服务管理下提供了一个<strong>负责老人</strong>功能，在这里可以给已经入住的老人分配对应的护理员：</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/2589d277-98ad-4a66-a447-ab91b9b18996.png" alt="2589d277-98ad-4a66-a447-ab91b9b18996"></p>
<ul>
<li>表结构介绍</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/de45bcd0-a28d-480b-862a-924196ce4b9f.png" alt="de45bcd0-a28d-480b-862a-924196ce4b9f"></p>
<ul>
<li>用户表<code>sys_user</code>：存储养老院的员工信息，包含了院长、销售、财务、护理员等各种角色的员工信息</li>
<li>老人表<code>elder</code>：养老院中入住的老人数据</li>
<li>护理员老人关联表<code>nursing_elder</code>：养老院的老人所负责的护理员列表</li>
</ul>
<h4 id="批量保存报警数据"><a href="#批量保存报警数据" class="headerlink" title="批量保存报警数据"></a>批量保存报警数据</h4><p>一旦有了报警数据之后，可能需要通知多个人，所以要为每一个要通知的人保存一条报警数据</p>
<p>告警数据表结构：alert_data（已提供）</p>
<p><img src="/img/loading.gif" data-original="/img/assests/fd36b136-b4c4-47de-9503-f1cf50879425.png" alt="fd36b136-b4c4-47de-9503-f1cf50879425"></p>
<ul>
<li>报警规则与报警数据为一对多的关系</li>
<li>重要字段提醒<ul>
<li>user_id：是指需要处理报警的用户</li>
</ul>
</li>
<li>报警数据基础代码准备<ul>
<li>包名:<code>com.zzyl.nursing</code></li>
<li>模块名：<code>nursing</code></li>
<li>生成业务名称：alertData</li>
<li>处理时间字段为：LocalDateTime</li>
<li>生成功能名称：报警数据</li>
</ul>
</li>
</ul>
<p><img src="/img/loading.gif" data-original="/img/assests/b40c5db7-f90c-425c-83f4-e623e0e65b67.png" alt="b40c5db7-f90c-425c-83f4-e623e0e65b67"></p>
<p> 只需要拷贝后端代码</p>
<h4 id="查询报警通知人"><a href="#查询报警通知人" class="headerlink" title="查询报警通知人"></a>查询报警通知人</h4><p>在流程结束之后，如果出现了报警数据，基于不同的报警设备的类型，通知的人的也是不同的</p>
<ul>
<li>老人异常数据，通知负责老人的<strong>护理员及超级管理员</strong><ul>
<li>如果是随身设备，可以通过设备找到老人ID，然后通过老人id查询nursing_elder表找到护理员的ID</li>
<li>如果是床位上的固定设备，则需要通过设备表中存储的床位ID查询老人表找到老人ID，，然后通过老人id查询nursing_elder表找到护理员的ID</li>
</ul>
</li>
<li>设备异常数据，通知<strong>行政人员（维修工）及超级管理员</strong><ul>
<li>如果是楼层或者房间中的固定设备，不需要通知护理员，需要根据<strong>维修工</strong>角色名称找到对应的维修工的ID</li>
</ul>
</li>
</ul>
<h4 id="查询老人异常数据要通知的护理员"><a href="#查询老人异常数据要通知的护理员" class="headerlink" title="查询老人异常数据要通知的护理员"></a>查询老人异常数据要通知的护理员</h4><p>表关系</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (47).png" alt="whiteboard_exported_image (47)" style="zoom:80%;" />

<p>在DeviceMapper中新增两个方法，都是通过iotId查询对应的护理员</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据随身设备id查询老人关联的护理人员id列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> iotId 设备id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  护理人员列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;Long&gt; <span class="title function_">selectNursingIdsByIotIdWithElder</span><span class="params">(<span class="meta">@Param(&quot;iotId&quot;)</span> String iotId)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据固定设备id查询老人关联的护理人员id列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> iotId 设备id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  护理人员列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;Long&gt; <span class="title function_">selectNursingIdsByIotIdWithBed</span><span class="params">(<span class="meta">@Param(&quot;iotId&quot;)</span> String iotId)</span>;</span><br></pre></td></tr></table></figure>

<p>对应的xml映射文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNursingIdsByIotIdWithElder&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">    select ne.nursing_id</span><br><span class="line">    from device d</span><br><span class="line">             left join nursing_elder ne on ne.elder_id = d.binding_location</span><br><span class="line">    where d.location_type = 0</span><br><span class="line">      and d.iot_id = #&#123;iotId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNursingIdsByIotIdWithBed&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">    select ne.nursing_id</span><br><span class="line">    from device d</span><br><span class="line">             left join elder e on e.bed_id = d.binding_location</span><br><span class="line">             left join nursing_elder ne on ne.elder_id = e.id</span><br><span class="line">    where d.location_type = 1 and d.physical_location_type = 2</span><br><span class="line">      and d.iot_id = #&#123;iotId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="通过角色名称查询用户id"><a href="#通过角色名称查询用户id" class="headerlink" title="通过角色名称查询用户id"></a>通过角色名称查询用户id</h4><p>表关系</p>
<img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (48).png" alt="whiteboard_exported_image (48)" style="zoom:80%;" />

<p>需要在SysUserRoleMapper(zzyl-system模块下)中新增方法，通过角色名称查询用户id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;select sur.user_id from sys_user_role sur left join sys_role sr on sur.role_id = sr.role_id where sr.role_name = #&#123;roleName&#125;&quot;)</span></span><br><span class="line">List&lt;Long&gt; <span class="title function_">selectUserIdByRoleName</span><span class="params">(String roleName)</span>;</span><br></pre></td></tr></table></figure>



<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p>在zzyl-nursing-platform中新增定时任务类，启动数据过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.service.IAlertRuleService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlertTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IAlertRuleService alertRuleService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deviceDataAlertFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        alertRuleService.alertFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="核心过滤逻辑"><a href="#核心过滤逻辑" class="headerlink" title="核心过滤逻辑"></a>核心过滤逻辑</h3><p>在AlertRuleService中新增方法，过滤数据，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 过滤报警</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">alertFilter</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>实现方法（在编写代码的过程中，需要打开流程图，按图编写代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SysUserRoleMapper userRoleMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DeviceMapper deviceMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IAlertDataService alertDataService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;alert.deviceMaintainerRole&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String deviceMaintainerRole;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;alert.managerRole&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String managerRole;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 报警过滤</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">alertFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 查询所有规则，遍历规则</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> count(Wrappers.&lt;AlertRule&gt;lambdaQuery().eq(AlertRule::getStatus, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查询所有上报的数据</span></span><br><span class="line">    List&lt;Object&gt; values = redisTemplate.opsForHash().values(CacheConstants.IOT_DEVICE_LAST_DATA);</span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isEmpty(values)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析上报的数据</span></span><br><span class="line">    List&lt;DeviceData&gt; deviceDatas = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    values.forEach(v -&gt; deviceDatas.addAll(JSONUtil.toList(v.toString(), DeviceData.class)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历报警数据，逐条处理</span></span><br><span class="line">    deviceDatas.forEach(d -&gt; alertFilter(d));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逐条过滤报警数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deviceData 设备数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">alertFilter</span><span class="params">(DeviceData deviceData)</span> &#123;</span><br><span class="line">    <span class="comment">// 判断当前上报的数据是否超过了1分钟</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">alarmTime</span> <span class="operator">=</span> deviceData.getAlarmTime();</span><br><span class="line">    <span class="type">long</span> <span class="variable">between</span> <span class="operator">=</span> LocalDateTimeUtil.between(alarmTime, LocalDateTime.now(), ChronoUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (between &gt; <span class="number">60</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查询所有的该产品规则和该物模型的规则</span></span><br><span class="line">    List&lt;AlertRule&gt; allRules = list(Wrappers.&lt;AlertRule&gt;lambdaQuery()</span><br><span class="line">            .eq(AlertRule::getProductKey, deviceData.getProductKey())</span><br><span class="line">            .eq(AlertRule::getIotId, <span class="string">&quot;-1&quot;</span>)</span><br><span class="line">            .eq(AlertRule::getFunctionId, deviceData.getFunctionId())</span><br><span class="line">            .eq(AlertRule::getStatus, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    List&lt;AlertRule&gt; iotIdRules = list(Wrappers.&lt;AlertRule&gt;lambdaQuery()</span><br><span class="line">            .eq(AlertRule::getProductKey, deviceData.getProductKey())</span><br><span class="line">            .eq(AlertRule::getIotId, deviceData.getIotId())</span><br><span class="line">            .eq(AlertRule::getFunctionId, deviceData.getFunctionId())</span><br><span class="line">            .eq(AlertRule::getStatus, <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// 合并</span></span><br><span class="line">    Collection&lt;AlertRule&gt; allArertRules = CollUtil.addAll(allRules, iotIdRules);</span><br><span class="line">    <span class="comment">// 如果为空，则中断</span></span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isEmpty(allArertRules)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 按照过滤规则和上报的数据进行匹配</span></span><br><span class="line">    allArertRules.forEach(alertRule -&gt; deviceDataAlarmHandler(alertRule, deviceData));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 过滤数据是否触发报警规则</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rule</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deviceData</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deviceDataAlarmHandler</span><span class="params">(AlertRule rule, DeviceData deviceData)</span> &#123;</span><br><span class="line">    <span class="comment">// 判断上报时间是否在规则的生效时段内 00:00:00~23:59:59</span></span><br><span class="line">    String[] split = rule.getAlertEffectivePeriod().split(<span class="string">&quot;~&quot;</span>);</span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">startTime</span> <span class="operator">=</span> LocalTime.parse(split[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalTime.parse(split[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">// 获取上报时间</span></span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTimeUtil.of(deviceData.getAlarmTime()).toLocalTime();</span><br><span class="line">    <span class="comment">// 不在上报时间内，则结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (time.isBefore(startTime) || time.isAfter(endTime)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取IOTID</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">iotId</span> <span class="operator">=</span> deviceData.getIotId();</span><br><span class="line">    <span class="comment">// 统计次数的key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">aggCountKey</span> <span class="operator">=</span> CacheConstants.ALERT_TRIGGER_COUNT_PREFIX + iotId + <span class="string">&quot;:&quot;</span> + deviceData.getFunctionId() + <span class="string">&quot;:&quot;</span> + rule.getId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据对比，上报的数据与规则中的阈值进行对比</span></span><br><span class="line">    <span class="comment">// 两个参数x,y(参数有顺序要求，左边是上报的数据，后边是规则的数据)  x==y 返回0  x&gt;y 返回大于0  x&lt;y 返回小于0的数值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">compare</span> <span class="operator">=</span> NumberUtil.compare(Double.valueOf(deviceData.getDataValue()), rule.getValue());</span><br><span class="line">    <span class="keyword">if</span> ((rule.getOperator().equals(<span class="string">&quot;&gt;=&quot;</span>) &amp;&amp; compare &gt;= <span class="number">0</span>) || (rule.getOperator().equals(<span class="string">&quot;&lt;&quot;</span>) &amp;&amp; compare &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前上报的数据符合规则异常&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 正常的数据</span></span><br><span class="line">        redisTemplate.delete(aggCountKey);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 异常的数据会走到这里</span></span><br><span class="line">    <span class="comment">// 判断是否在沉默周期内</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">silentKey</span> <span class="operator">=</span> CacheConstants.ALERT_SILENT_PREFIX + iotId + <span class="string">&quot;:&quot;</span> + deviceData.getFunctionId() + <span class="string">&quot;:&quot;</span> + rule.getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">silentData</span> <span class="operator">=</span> redisTemplate.opsForValue().get(silentKey);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotEmpty(silentData)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 持续周期的逻辑</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">aggData</span> <span class="operator">=</span> redisTemplate.opsForValue().get(aggCountKey);</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> StringUtils.isEmpty(aggData) ? <span class="number">1</span> : Integer.parseInt(aggData) + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 如果count与持续周期的值相等，则触发报警</span></span><br><span class="line">    <span class="keyword">if</span> (ObjectUtil.notEqual(count, rule.getDuration())) &#123;</span><br><span class="line">        <span class="comment">// 不相等</span></span><br><span class="line">        redisTemplate.opsForValue().set(aggCountKey, count + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 删除redis的报警数据</span></span><br><span class="line">    redisTemplate.delete(aggCountKey);</span><br><span class="line">    <span class="comment">// 存储数据到沉默周期，设置一个过期时间，规则中的沉默周期</span></span><br><span class="line">    redisTemplate.opsForValue().set(silentKey, <span class="string">&quot;1&quot;</span>, rule.getAlertSilentPeriod(), TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 报警数据，需要找到对应的人</span></span><br><span class="line">    List&lt;Long&gt; userIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (rule.getAlertDataType().equals(<span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// 老人异常数据</span></span><br><span class="line">        <span class="keyword">if</span> (deviceData.getLocationType().equals(<span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="comment">// 说明是报警手表，直接可以找到老人的id,通过老人id,找到对应的护理员</span></span><br><span class="line">            userIds = deviceMapper.selectNursingIdsByIotIdWithElder(iotId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (deviceData.getLocationType().equals(<span class="number">1</span>) &amp;&amp; deviceData.getPhysicalLocationType().equals(<span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="comment">// 说明是床位设备，可以通过床位id找到老人，通过老人id,找到对应的护理员</span></span><br><span class="line">            userIds = deviceMapper.selectNursingIdsByIotIdWithBed(iotId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 设备异常数据，找维修工，或者是行政人员</span></span><br><span class="line">        userIds = userRoleMapper.selectUserIdByRoleName(deviceMaintainerRole);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 不论是哪种情况，都要通知超级管理员</span></span><br><span class="line">    List&lt;Long&gt; managerIds = userRoleMapper.selectUserIdByRoleName(managerRole);</span><br><span class="line">    Collection&lt;Long&gt; allUserIds = CollUtil.addAll(userIds, managerIds);</span><br><span class="line">    <span class="comment">// 去重</span></span><br><span class="line">    allUserIds = CollUtil.distinct(allUserIds);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存报警数据</span></span><br><span class="line">    insertAlertData(allUserIds, rule, deviceData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存报警数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> allUserIds</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rule</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deviceData</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">insertAlertData</span><span class="params">(Collection&lt;Long&gt; allUserIds, AlertRule rule, DeviceData deviceData)</span> &#123;</span><br><span class="line">    <span class="comment">// 对象拷贝</span></span><br><span class="line">    <span class="type">AlertData</span> <span class="variable">alertData</span> <span class="operator">=</span> BeanUtil.toBean(deviceData, AlertData.class);</span><br><span class="line">    alertData.setAlertRuleId(rule.getId());</span><br><span class="line">    <span class="comment">// 心率&lt;60,持续3个周期就报警</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">alertReason</span> <span class="operator">=</span> CharSequenceUtil.format(<span class="string">&quot;&#123;&#125;&#123;&#125;&#123;&#125;,持续&#123;&#125;个周期就报警&quot;</span>, rule.getFunctionName(), rule.getOperator(), rule.getValue(), rule.getDuration());</span><br><span class="line">    alertData.setAlertReason(alertReason);</span><br><span class="line">    alertData.setStatus(<span class="number">0</span>);</span><br><span class="line">    alertData.setType(rule.getAlertDataType());</span><br><span class="line">    <span class="comment">// 遍历allUserIds</span></span><br><span class="line">    List&lt;AlertData&gt; list = allUserIds.stream().map(userId -&gt; &#123;</span><br><span class="line">        <span class="type">AlertData</span> <span class="variable">dbAlertData</span> <span class="operator">=</span> BeanUtil.toBean(alertData, AlertData.class);</span><br><span class="line">        dbAlertData.setUserId(userId);</span><br><span class="line">        dbAlertData.setId(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> dbAlertData;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 批量保存</span></span><br><span class="line">    alertDataService.saveBatch(list);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>逻辑相对复杂，一定要对照流程图阅读代码理解</p>
</blockquote>
<p>上述代码中多次用到了redis，并且定义了常量来表示redis的key，需要在CacheConstants新增常量，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 报警规则连续触发次数，缓存前缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALERT_TRIGGER_COUNT_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;iot:alert_trigger_count:&quot;</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 报警规则沉默周期，缓存前缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALERT_SILENT_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;iot:alert_silent:&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>上述代码中，对于超级管理员和维修工是通过配置的方式读取的名字，需要在application-dev.yml文件中添加数据</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alert:</span></span><br><span class="line">    <span class="attr">deviceMaintainerRole:</span> <span class="string">维修工</span></span><br><span class="line">    <span class="attr">managerRole:</span> <span class="string">超级管理员</span></span><br></pre></td></tr></table></figure>



<h2 id="报警通知提醒"><a href="#报警通知提醒" class="headerlink" title="报警通知提醒"></a>报警通知提醒</h2><h3 id="需求说明-1"><a href="#需求说明-1" class="headerlink" title="需求说明"></a>需求说明</h3><p>当设备上报的数据触发了报警规则之后，需要及时提醒相关人员来处理，为了更快的让相应的负责人收到消息，一旦监测到异常数据，可以给相关负责人发送通知，例如：</p>
<img src="/img/loading.gif" data-original="/img/assests/53140333-3dc5-47de-8fc0-fd58ece655a3.png" alt="53140333-3dc5-47de-8fc0-fd58ece655a3" style="zoom:50%;" />

<p>对于当前项目来说，可以在后台管理系统中进行通知，效果如下：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/80d06052-65a5-4613-a234-8225acfa576e.png" alt="80d06052-65a5-4613-a234-8225acfa576e"></p>
<p>要想实现这个功能，需要使用一个新的技术：WebSocket</p>
<h3 id="功能实现-4"><a href="#功能实现-4" class="headerlink" title="功能实现"></a>功能实现</h3><h4 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h4><img src="/img/loading.gif" data-original="/img/assests/whiteboard_exported_image (49).png" alt="whiteboard_exported_image (49)" style="zoom:50%;" />

<h4 id="环境集成-1"><a href="#环境集成-1" class="headerlink" title="环境集成"></a>环境集成</h4><ol>
<li><strong>导入依赖</strong></li>
</ol>
<p>在zzyl-nursing-platform中如导入以下依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>定义WebSocket服务和注册WebSocket</strong></li>
</ol>
<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册基于<span class="doctag">@ServerEndpoint</span>声明的Websocket Endpoint</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebSocketServer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ObjectUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.common.exception.base.BaseException;</span><br><span class="line"><span class="keyword">import</span> com.zzyl.nursing.vo.AlertNotifyVo;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/ws/&#123;sid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接建立时触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;有客户端连接到了服务器 , &#123;&#125;&quot;</span>, sid);</span><br><span class="line">        sessionMap.put(sid, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务端接收到消息时触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Session session, String message, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;接收到了客户端 &#123;&#125; 发来的消息 : &#123;&#125;&quot;</span>, sid, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接关闭时触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;连接断开:&quot;</span> + sid);</span><br><span class="line">        sessionMap.remove(sid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通信发生错误时触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid, Throwable throwable)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;出现错误:&quot;</span> + sid);</span><br><span class="line">        throwable.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 广播消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageToAll</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Collection&lt;Session&gt; sessions = sessionMap.values();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(sessions)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Session session : sessions) &#123;</span><br><span class="line">                <span class="comment">//服务器向客户端发送消息</span></span><br><span class="line">                session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送websocket消息给指定消费者</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> alertNotifyVo 报警消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userIds   报警数据map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException io异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageToConsumer</span><span class="params">(AlertNotifyVo alertNotifyVo, Collection&lt;Long&gt; userIds)</span> &#123;</span><br><span class="line">        <span class="comment">//如果消费者为空，程序结束</span></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(userIds)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果websoket客户端为空，程序结束</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isEmpty(sessionMap)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历消费者，发送消息</span></span><br><span class="line">        <span class="comment">//key为消息接收人id，value为报警数据id</span></span><br><span class="line">        userIds.forEach(userId -&gt; &#123;</span><br><span class="line">            <span class="comment">//获取该消费者的websocket连接，如果不存在，跳出本次循环</span></span><br><span class="line">            <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> sessionMap.get(String.valueOf(userId));</span><br><span class="line">            <span class="keyword">if</span> (ObjectUtil.isEmpty(session)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取该消费者的websocket连接，并发送消息</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                session.getBasicRemote().sendText(JSONUtil.toJsonStr(alertNotifyVo));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BaseException</span>(<span class="string">&quot;websocket推送消息失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消息通知Vo：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyl.nursing.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 报警通知消息对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlertNotifyVo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 报警数据id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接入位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String accessLocation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 位置类型 0：随身设备 1：固定设备</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer locationType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 物理位置类型 0楼层 1房间 2床位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer physicalLocationType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设备位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String deviceDescription;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产品名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String functionName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String dataValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 报警数据类型，0：老人异常数据，1：设备异常数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer alertDataType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 语音通知状态，0：关闭，1：开启</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer voiceNotifyStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 报警通知类型，0：解除报警，1：报警</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer notifyType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否全员通知&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 智能床位的报警消息是全员通知，对于护理员和固定设备维护人员不是全员通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isAllConsumer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="报警数据推送到前端"><a href="#报警数据推送到前端" class="headerlink" title="报警数据推送到前端"></a>报警数据推送到前端</h4><p>修改AlertRuleServiceImpl类，添加推送报警数据逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设备数据匹配过滤规则</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deviceData</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rule</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deviceDataAlarmHandler</span><span class="params">(DeviceData deviceData, AlertRule rule)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断上报的数据是否在生效时段内  00:00:00~23:59:59    00:05:00~22:59:59</span></span><br><span class="line">    String[] split = rule.getAlertEffectivePeriod().split(<span class="string">&quot;~&quot;</span>);</span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">startTime</span> <span class="operator">=</span> LocalTime.parse(split[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalTime.parse(split[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">// 数据上报的时间</span></span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">localTime</span> <span class="operator">=</span> deviceData.getAlarmTime().toLocalTime();</span><br><span class="line">    <span class="comment">// 如果上报的时间不在生效时段内，则结束请求</span></span><br><span class="line">    <span class="keyword">if</span>(localTime.isBefore(startTime) || localTime.isAfter(endTime)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统计次数的key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">aggCountKey</span> <span class="operator">=</span> CacheConstants.IOT_COUNT_ALERT+deviceData.getIotId()+<span class="string">&quot;:&quot;</span>+deviceData.getFunctionId()+<span class="string">&quot;:&quot;</span>+rule.getId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断上报的数据是否达到了规则的阈值</span></span><br><span class="line">    <span class="type">Double</span> <span class="variable">dataValue</span> <span class="operator">=</span> Double.valueOf(deviceData.getDataValue());</span><br><span class="line">    <span class="type">Double</span> <span class="variable">value</span> <span class="operator">=</span> rule.getValue();</span><br><span class="line">    <span class="comment">// 工具类x,y（顺序有要求，左边是上报的数据，后边是规则定义的数据）  x等于y 返回0  x&gt;y  返回大于0的值   x&lt;y  返回小于0的值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">compare</span> <span class="operator">=</span> NumberUtil.compare(dataValue, value);</span><br><span class="line">    <span class="keyword">if</span>((rule.getOperator().equals(<span class="string">&quot;&gt;=&quot;</span>) &amp;&amp; compare &gt;= <span class="number">0</span>) || (rule.getOperator().equals(<span class="string">&quot;&lt;&quot;</span>) &amp;&amp; compare &lt; <span class="number">0</span>))&#123;</span><br><span class="line">        <span class="comment">//符合上报的规则，产生了异常数据</span></span><br><span class="line">        log.info(<span class="string">&quot;当前数据符合报警规则&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;正常上报的数据&quot;</span>);</span><br><span class="line">        redisTemplate.delete(aggCountKey);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 沉默周期  持续周期</span></span><br><span class="line">    <span class="comment">// 设计一个redis的可以，必须唯一，代表的当前的设备、物模型、规则ID</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">silentKey</span> <span class="operator">=</span> CacheConstants.IOT_SILENT_ALERT+deviceData.getIotId()+<span class="string">&quot;:&quot;</span>+deviceData.getFunctionId()+<span class="string">&quot;:&quot;</span>+rule.getId();</span><br><span class="line">    <span class="comment">//获取沉默周期</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">silentData</span> <span class="operator">=</span> redisTemplate.opsForValue().get(silentKey);</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(silentData))&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 持续周期</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">aggCountData</span> <span class="operator">=</span> redisTemplate.opsForValue().get(aggCountKey);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> StringUtils.isEmpty(aggCountData)? <span class="number">1</span> : (Integer.parseInt(aggCountData) + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 当前count不等于持续周期，就累加数据，并且结束请求</span></span><br><span class="line">    <span class="keyword">if</span>(ObjectUtil.notEqual(count,rule.getDuration()))&#123;</span><br><span class="line">        <span class="comment">// 累加数据</span></span><br><span class="line">        redisTemplate.opsForValue().set(aggCountKey,count+<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 到了报警的条件了，保存一份沉默周期</span></span><br><span class="line">    redisTemplate.opsForValue().set(silentKey,<span class="string">&quot;1&quot;</span>,rule.getAlertSilentPeriod(), TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">// 删除统计的次数</span></span><br><span class="line">    redisTemplate.delete(aggCountKey);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存异常数据</span></span><br><span class="line">    <span class="comment">// 判断上报数据的设备的类型，如果老人的异常数据（手表、睡眠检测带） 设备异常（烟雾报警）</span></span><br><span class="line">    List&lt;Long&gt; userIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(rule.getAlertDataType().equals(<span class="number">0</span>))&#123;</span><br><span class="line">        <span class="comment">// 老人异常（手表、睡眠检测带）  设备id--&gt;设备--&gt;老人id---&gt;护理员</span></span><br><span class="line">        <span class="keyword">if</span>(deviceData.getLocationType().equals(<span class="number">0</span>))&#123;</span><br><span class="line">            <span class="comment">// 随身设备</span></span><br><span class="line">            userIds = deviceMapper.selectNursingIdsByIotIdWithElder(deviceData.getIotId());</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(deviceData.getLocationType().equals(<span class="number">1</span>) &amp;&amp; deviceData.getPhysicalLocationType().equals(<span class="number">2</span>))&#123;</span><br><span class="line">            <span class="comment">// 床位设备  设备id--&gt;设备--&gt;床位--&gt;老人id---&gt;护理员</span></span><br><span class="line">            userIds = deviceMapper.selectNursingIdsByIotIdWithBed(deviceData.getIotId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 设备异常  找维修人员   通过角色名称（维修工）   用户  角色  用户角色中间表</span></span><br><span class="line">        userIds = sysUserRoleMapper.selectByRoleName(<span class="string">&quot;维修工&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 找到超级管理员</span></span><br><span class="line">    List&lt;Long&gt; managerIds = sysUserRoleMapper.selectByRoleName(<span class="string">&quot;超级管理员&quot;</span>);</span><br><span class="line">    <span class="comment">// 合并两份用户id</span></span><br><span class="line">    Collection&lt;Long&gt; allUserIds = CollUtil.addAll(userIds, managerIds);</span><br><span class="line">    <span class="comment">// 去重</span></span><br><span class="line">    allUserIds = CollUtil.distinct(allUserIds);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 批量保存异常数据</span></span><br><span class="line">    List&lt;AlertData&gt; alertDataList = insertAlertData(allUserIds, deviceData, rule);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// websocket推送消息</span></span><br><span class="line">    webSocketNotity(alertDataList.get(<span class="number">0</span>), rule, allUserIds);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WebSocketServer webSocketServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * websocket推送消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> alertData</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rule</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> allUserIds</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">webSocketNotity</span><span class="params">(AlertData alertData, AlertRule rule, Collection&lt;Long&gt; allUserIds)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//属性拷贝</span></span><br><span class="line">    <span class="type">AlertNotifyVo</span> <span class="variable">alertNotifyVo</span> <span class="operator">=</span> BeanUtil.toBean(alertData, AlertNotifyVo.class);</span><br><span class="line">    alertNotifyVo.setAccessLocation(alertData.getRemark());</span><br><span class="line">    alertNotifyVo.setFunctionName(alertRule.getFunctionName());</span><br><span class="line">    alertNotifyVo.setAlertDataType(alertRule.getAlertDataType());</span><br><span class="line">    alertNotifyVo.setNotifyType(<span class="number">1</span>);    </span><br><span class="line">    <span class="comment">// 向指定的人推送消息</span></span><br><span class="line">    webSocketServer.sendMessageToConsumer(alertNotifyVo, ids);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IAlertDataService alertDataService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存异常数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> allUserIds</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deviceData</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rule</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;AlertData&gt; <span class="title function_">insertAlertData</span><span class="params">(Collection&lt;Long&gt; allUserIds, DeviceData deviceData, AlertRule rule)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 属性拷贝，从deviceData拷贝到alertData</span></span><br><span class="line">    <span class="type">AlertData</span> <span class="variable">alertData</span> <span class="operator">=</span> BeanUtil.toBean(deviceData, AlertData.class);</span><br><span class="line">    <span class="comment">// 关于规则的数据都拷贝不过去</span></span><br><span class="line">    alertData.setAlertRuleId(rule.getId());</span><br><span class="line">    <span class="comment">// 功能名称+运算符+阈值+持续周期+聚合周期</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">reason</span> <span class="operator">=</span> CharSequenceUtil.format(<span class="string">&quot;&#123;&#125;&#123;&#125;&#123;&#125;,持续了&#123;&#125;周期，就报警&quot;</span>,rule.getFunctionId(),</span><br><span class="line">            rule.getOperator(),rule.getValue(),rule.getDuration());</span><br><span class="line">    alertData.setAlertReason(reason);</span><br><span class="line">    <span class="comment">// 报警状态</span></span><br><span class="line">    alertData.setStatus(<span class="number">0</span>);</span><br><span class="line">    alertData.setType(rule.getAlertDataType());</span><br><span class="line">    <span class="comment">// 批量保存数据了，由于多个人</span></span><br><span class="line">    List&lt;AlertData&gt; list = allUserIds.stream().map(userId -&gt; &#123;</span><br><span class="line">        <span class="comment">// 再次拷贝</span></span><br><span class="line">        <span class="type">AlertData</span> <span class="variable">dBalertData</span> <span class="operator">=</span> BeanUtil.toBean(alertData, AlertData.class);</span><br><span class="line">        dBalertData.setUserId(userId);</span><br><span class="line">        dBalertData.setId(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> dBalertData;</span><br><span class="line"></span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 批量保存</span></span><br><span class="line">    alertDataService.saveBatch(list);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="前端环境配置"><a href="#前端环境配置" class="headerlink" title="前端环境配置"></a>前端环境配置</h4><p>用资料中提供的index.vue替换src&#x2F;layout目录下的index.vue（主要是集成WebSocket）</p>
<p>修改前端的ws的连接地址：</p>
<p><img src="/img/loading.gif" data-original="/img/assests/88000054-cf7a-4d90-a864-2b31e12730a7.png" alt="88000054-cf7a-4d90-a864-2b31e12730a7"></p>
<p><strong>注意：是<font color='red'>ws</font>不是wss</strong></p>
<p>由于前端要发请求到后端建立连接，所以还需要在SpringSecurity中放行<strong>ws</strong>开头的请求</p>
<p>放行代码</p>
<p><img src="/img/loading.gif" data-original="/img/assests/5bd0b57d-99e2-4820-a324-2a6490a283f3.png" alt="5bd0b57d-99e2-4820-a324-2a6490a283f3"></p>
<h1 id="中州养老项目总结"><a href="#中州养老项目总结" class="headerlink" title="中州养老项目总结"></a>中州养老项目总结</h1><h2 id="若依框架的使用"><a href="#若依框架的使用" class="headerlink" title="若依框架的使用"></a>若依框架的使用</h2><p>若依框架的使用，重点关注三个功能：代码生成、表单构建、定时任务</p>
<ol>
<li><strong>代码生成功能</strong>：若依提供的代码生成功能可以<strong>基于数据库表结构快速生成前后端基础增删改查代码和系统菜单</strong></li>
<li><strong>表单构建功能</strong>：若依提供的表单构建功能可以<strong>通过图形化界面拖拉拽的形式快速生成复杂的页面表单</strong></li>
<li><strong>定时任务功能</strong>：若依提供的定时任务功能可以<strong>在系统页面管理系统中的定时任务以及查看定时任务的执行情况</strong></li>
</ol>
<h2 id="入退管理模块"><a href="#入退管理模块" class="headerlink" title="入退管理模块"></a>入退管理模块</h2><p>入退管理模块是项目中一个比较重要的模块，涉及到健康评估和入住办理两个功能：</p>
<ol>
<li><strong>健康评估</strong>：老人在入住养老院之前，需要提供一份最近完成的PDF版本的体检报告，在系统中上传体检报告后（从PDF中提取体检信息文本），AI大模型会自动分析体检报告并给出分析结果</li>
<li><strong>入住办理</strong>：当老人确定要入住养老院后，可以在系统上发起入住办理，在入住办理页面填写老人的<strong>基本信息、家属信息、入住配置信息和签约办理信息</strong>，就可以让老人入住到养老院中</li>
</ol>
<h2 id="在住管理模块"><a href="#在住管理模块" class="headerlink" title="在住管理模块"></a>在住管理模块</h2><p>在住管理模块包括三个功能：房型设置、床位预览、智能床位</p>
<ol>
<li><strong>房型设置</strong>：在房型设置页面可以维护养老院中的房型，包括<strong>房间图片、房型类型、床位费用、房型介绍</strong>等</li>
<li><strong>床位预览</strong>：在床位预览页面可以维护养老院中的<strong>楼层、楼层下的房间、房间中的床位</strong></li>
<li><strong>智能床位</strong>：智能床位功能展示的是养老院中有智能床位的楼层、楼层下有智能设备的房间和床位信息以及智能设备最近一次上报的数据</li>
</ol>
<h2 id="服务管理模块"><a href="#服务管理模块" class="headerlink" title="服务管理模块"></a>服务管理模块</h2><p>服务管理模块包括四个功能：</p>
<ol>
<li><strong>护理项目</strong>：在护理项目页面可以<strong>维护养老院中能够提供的护理项目</strong>，例如：洗头、洗脚、助餐等</li>
<li><strong>护理计划</strong>：在护理计划页面可以<strong>维护养老院中的护理计划</strong>，一个护理计划中可以关联多个护理项目</li>
<li><strong>护理等级</strong>：在护理等级页面可以<strong>维护养老院中的护理等级</strong>，一个护理等级唯一对应一个护理计划</li>
<li><strong>负责老人</strong>：在负责老人页面可以<strong>展示出有老人入住的楼层，以及楼层下的房间和床位信息，可以单独维护某一个床位的护理人员，也可以批量维护一个房间中所有床位上的护理人员</strong></li>
</ol>
<h2 id="智能监测模块"><a href="#智能监测模块" class="headerlink" title="智能监测模块"></a>智能监测模块</h2><p>智能监测模块包括三个功能：设备管理、报警规则、报警数据</p>
<ol>
<li><strong>设备管理</strong>：在设备管理页面可以<strong>维护华为云IOT平台的设备，并将设备和系统中的位置（老人、床位、房间）进行绑定</strong></li>
<li><strong>报警规则</strong>：在报警规则页面可以<strong>维护系统中的报警规则，方便通过报警规则过滤异常数据</strong></li>
<li><strong>报警数据</strong>：在报警数据页面可以<strong>看到符合报警规则的数据，并能对报警数据进行处理</strong></li>
</ol>
<h2 id="微信小程序模块"><a href="#微信小程序模块" class="headerlink" title="微信小程序模块"></a>微信小程序模块</h2><p>微信小程序模块包括：<strong>微信小程序登录、绑定家人、参观预约</strong></p>
<ol>
<li><strong>微信小程序登录</strong>：在微信小程序端获取用户授权后，<strong>调用微信开放平台提供的登录接口进行登录</strong></li>
<li><strong>绑定家人</strong>：在微信小程序端<strong>绑定正在养老院入住的家人信息</strong>，方便发起探访预约申请和查看家人的身体健康数据等</li>
<li><strong>参观预约</strong>：可以<strong>在微信小程序端发起参观预约申请</strong>，并在预约的时间到养老院进行参观</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Zhao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://norlcyan.netlify.app">https://norlcyan.netlify.app</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Norlcyan's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF/">后端</a><a class="post-meta__tags" href="/tags/Java-Web%E5%85%A5%E9%97%A8/">Java Web入门</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/archives/f119c603.html" title="AOP面向切面编程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="title">AOP面向切面编程</div></div></a></div><div><a href="/archives/5b040530.html" title="Spring MyBatis"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="title">Spring MyBatis</div></div></a></div><div><a href="/archives/dede2c3d.html" title="Spring MyBatis Plus"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="title">Spring MyBatis Plus</div></div></a></div><div><a href="/archives/6de32429.html" title="Spring PageHelper"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="title">Spring PageHelper</div></div></a></div><div><a href="/archives/80a14eb9.html" title="SpringBoot使用总结"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="title">SpringBoot使用总结</div></div></a></div><div><a href="/archives/1c8f9546.html" title="Spring 事务管理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="title">Spring 事务管理</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/loading.gif" data-original="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Zhao</div><div class="author-info__description">人生最遗憾的，莫过于，轻易地放弃了不该放弃的，固执地，坚持了不该坚持的。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">142</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Noober-jpg"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">如有侵权文章，可以加我QQ：3481765114通知我</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%A5%E4%BD%8F%E5%8A%9E%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">入住办理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E4%BD%8F%E5%8A%9E%E7%90%86%E5%88%97%E8%A1%A8%E9%A1%B5"><span class="toc-number">1.1.1.</span> <span class="toc-text">入住办理列表页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E4%BD%8F%E5%8A%9E%E7%90%86%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">1.1.2.</span> <span class="toc-text">入住办理详情页</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.</span> <span class="toc-text">表结构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">后端开发流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E8%A1%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">如何设计表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ER%E5%9B%BE"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">ER图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">详细设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E8%A1%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">建表工具</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E4%BD%8F%E7%9B%B8%E5%85%B3%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.3.</span> <span class="toc-text">入住相关表结构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%E7%9A%84E-R%E5%9B%BE"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">表结构的E-R图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%9E%82%E7%9B%B4%E5%88%86%E5%89%B2"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">什么是垂直分割</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">最终表结构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.</span> <span class="toc-text">接口设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%9B%9B%E8%A6%81%E7%B4%A0"><span class="toc-number">1.3.1.</span> <span class="toc-text">接口四要素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">接口测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E4%BD%8F%E7%9B%B8%E5%85%B3%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.3.</span> <span class="toc-text">入住相关的接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.4.</span> <span class="toc-text">接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%8A%A4%E7%90%86%E7%AD%89%E7%BA%A7%E5%88%97%E8%A1%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">查询所有护理等级列表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">控制层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">Service层实现类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%BA%8A%E4%BD%8D%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%A5%BC%E5%B1%82%E6%95%B0%E6%8D%AE"><span class="toc-number">1.4.2.</span> <span class="toc-text">根据床位状态查询所有楼层数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">思路说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%B1%82-1"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">控制层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">业务层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%B1%82%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">持久层（重点）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%88%BF%E9%97%B4id%E6%9F%A5%E8%AF%A2%E6%88%BF%E9%97%B4%E6%95%B0%E6%8D%AE%EF%BC%88%E6%A5%BC%E5%B1%82%E3%80%81%E6%88%BF%E9%97%B4%E3%80%81%E4%BB%B7%E6%A0%BC%EF%BC%89"><span class="toc-number">1.4.3.</span> <span class="toc-text">根据房间id查询房间数据（楼层、房间、价格）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E8%AF%B4%E6%98%8E-1"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">思路说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%B1%82-2"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">控制层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82-1"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">业务层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%B1%82%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89-1"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">持久层（重点）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E5%85%A5%E4%BD%8F"><span class="toc-number">1.4.4.</span> <span class="toc-text">申请入住</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%B1%82-3"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">控制层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">业务层（重点）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B7%BB%E5%8A%A0%E7%BC%93%E5%AD%98"><span class="toc-number">1.5.</span> <span class="toc-text">接口添加缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A4%E7%90%86%E7%AD%89%E7%BA%A7%E6%B7%BB%E5%8A%A0%E7%BC%93%E5%AD%98"><span class="toc-number">1.5.1.</span> <span class="toc-text">护理等级添加缓存</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E8%AF%84%E4%BC%B0"><span class="toc-number">2.</span> <span class="toc-text">智能评估</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-number">2.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-number">2.2.</span> <span class="toc-text">表结构说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E"><span class="toc-number">2.3.</span> <span class="toc-text">接口说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">2.4.</span> <span class="toc-text">实现方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96PDF%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-number">2.5.</span> <span class="toc-text">读取PDF文件内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BE%E5%BA%A6%E5%8D%83%E5%B8%86%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.6.</span> <span class="toc-text">百度千帆大模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E6%A8%A1%E5%9E%8BAPI%E8%AF%B4%E6%98%8E"><span class="toc-number">2.6.1.</span> <span class="toc-text">大模型API说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.6.2.</span> <span class="toc-text">集成大模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-1"><span class="toc-number">2.7.</span> <span class="toc-text">接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%A3%E7%A0%81%E5%87%86%E5%A4%87"><span class="toc-number">2.7.1.</span> <span class="toc-text">基础代码准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1Prompt"><span class="toc-number">2.7.2.</span> <span class="toc-text">设计Prompt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E4%BD%93%E6%A3%80%E6%8A%A5%E5%91%8A"><span class="toc-number">2.7.3.</span> <span class="toc-text">上传体检报告</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%9B%9E%E9%A1%BE"><span class="toc-number">2.7.3.1.</span> <span class="toc-text">需求回顾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%9B%9E%E9%A1%BE"><span class="toc-number">2.7.3.2.</span> <span class="toc-text">思路回顾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.7.3.3.</span> <span class="toc-text">功能实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E8%AF%84%E6%B5%8B"><span class="toc-number">2.7.4.</span> <span class="toc-text">智能评测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%BD%E5%8F%96%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%B0%83%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">2.7.4.1.</span> <span class="toc-text">抽取大模型调用工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">2.7.4.2.</span> <span class="toc-text">修改控制层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="toc-number">2.7.4.3.</span> <span class="toc-text">修改业务层</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E6%A3%80%E6%B5%8B"><span class="toc-number">3.</span> <span class="toc-text">智能检测</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A7%E5%93%81%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="toc-number">3.1.</span> <span class="toc-text">产品数据准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">设备管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-2"><span class="toc-number">3.2.1.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E5%88%97%E8%A1%A8%E9%A1%B5"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">设备管理列表页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E8%AF%A6%E6%83%85"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">设备详情</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%A9%E6%A8%A1%E5%9E%8B%E6%95%B0%E6%8D%AE-%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">物模型数据-运行状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">表结构说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="toc-number">3.2.3.</span> <span class="toc-text">接口分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%88%97%E8%A1%A8"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">接口列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">接口文档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IOT%E6%8E%A5%E5%8F%A3%E5%AF%B9%E6%8E%A5"><span class="toc-number">3.2.4.</span> <span class="toc-text">IOT接口对接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#API%E5%88%97%E8%A1%A8"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">API列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%9B%86%E6%88%90"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">环境集成</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">3.3.</span> <span class="toc-text">功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%A3%E7%A0%81%E5%87%86%E5%A4%87-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">基础代码准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E7%89%A9%E8%81%94%E7%BD%91%E5%B9%B3%E5%8F%B0%E5%90%8C%E6%AD%A5%E4%BA%A7%E5%93%81%E5%88%97%E8%A1%A8"><span class="toc-number">3.3.2.</span> <span class="toc-text">从物联网平台同步产品列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E4%BA%A7%E5%93%81%E5%88%97%E8%A1%A8"><span class="toc-number">3.3.3.</span> <span class="toc-text">查询所有产品列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%B7%B2%E7%BB%8F%E5%85%A5%E4%BD%8F%E7%9A%84%E8%80%81%E4%BA%BA%E5%88%97%E8%A1%A8"><span class="toc-number">3.3.4.</span> <span class="toc-text">查询已经入住的老人列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%AE%BE%E5%A4%87%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.3.5.</span> <span class="toc-text">注册设备接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E8%AE%BE%E5%A4%87%E5%88%97%E8%A1%A8"><span class="toc-number">3.3.6.</span> <span class="toc-text">分页查询设备列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%AE%BE%E5%A4%87%E8%AF%A6%E7%BB%86%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.7.</span> <span class="toc-text">查询设备详细数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%AE%BE%E5%A4%87%E4%B8%8A%E6%8A%A5%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%88%E8%AE%BE%E5%A4%87%E5%BD%B1%E5%AD%90%EF%BC%89"><span class="toc-number">3.3.8.</span> <span class="toc-text">查看设备上报的数据（设备影子）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E8%AE%BE%E5%A4%87%E7%AB%AF%E6%95%B0%E6%8D%AE"><span class="toc-number">4.</span> <span class="toc-text">接收设备端数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">4.1.</span> <span class="toc-text">表结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="toc-number">4.2.</span> <span class="toc-text">基础代码生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">4.3.</span> <span class="toc-text">功能实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">4.4.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bug%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.5.</span> <span class="toc-text">bug修复</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%AE%BE%E5%A4%87%E7%9A%84%E7%89%A9%E6%A8%A1%E5%9E%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">5.</span> <span class="toc-text">查询设备的物模型数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-3"><span class="toc-number">5.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">5.2.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">5.3.</span> <span class="toc-text">功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-number">5.3.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82-2"><span class="toc-number">5.3.2.</span> <span class="toc-text">业务层</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%BA%8A%E4%BD%8D"><span class="toc-number">6.</span> <span class="toc-text">智能床位</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%A5%BC%E5%B1%82%EF%BC%88%E6%99%BA%E8%83%BD%E6%A5%BC%E5%B1%82%EF%BC%89"><span class="toc-number">6.1.</span> <span class="toc-text">获取所有楼层（智能楼层）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">6.1.1.</span> <span class="toc-text">思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%B1%82-4"><span class="toc-number">6.1.2.</span> <span class="toc-text">控制层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82-3"><span class="toc-number">6.1.3.</span> <span class="toc-text">业务层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%B1%82"><span class="toc-number">6.1.4.</span> <span class="toc-text">持久层</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%88%BF%E9%97%B4%E4%B8%AD%E7%9A%84%E6%99%BA%E8%83%BD%E8%AE%BE%E5%A4%87%E5%8F%8A%E6%95%B0%E6%8D%AE"><span class="toc-number">6.2.</span> <span class="toc-text">获取房间中的智能设备及数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90-1"><span class="toc-number">6.2.1.</span> <span class="toc-text">思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9%E9%80%A0%E4%B8%8A%E6%8A%A5%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E9%80%BB%E8%BE%91"><span class="toc-number">6.2.2.</span> <span class="toc-text">改造上报数据接收逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE"><span class="toc-number">6.2.3.</span> <span class="toc-text">查询基础数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E4%B8%AD%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E7%9A%84%E6%A0%B7%E5%BC%8F%E4%BF%AE%E6%94%B9Vo"><span class="toc-number">6.2.4.</span> <span class="toc-text">根据接口文档中返回数据的样式修改Vo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%B1%82-5"><span class="toc-number">6.2.5.</span> <span class="toc-text">控制层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%B1%82-1"><span class="toc-number">6.2.6.</span> <span class="toc-text">持久层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82-4"><span class="toc-number">6.2.7.</span> <span class="toc-text">业务层</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E7%AE%A1%E7%90%86%E5%92%8C%E9%80%9A%E7%9F%A5"><span class="toc-number">7.</span> <span class="toc-text">报警管理和通知</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">7.1.</span> <span class="toc-text">报警规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%8A%A5%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">7.1.1.</span> <span class="toc-text">新增报警规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E8%A7%84%E5%88%99%E5%85%B6%E4%BB%96%E9%9C%80%E6%B1%82"><span class="toc-number">7.1.2.</span> <span class="toc-text">报警规则其他需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84-1"><span class="toc-number">7.1.3.</span> <span class="toc-text">表结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%8A%A0%E5%BC%BA%E8%AF%B4%E6%98%8E"><span class="toc-number">7.2.</span> <span class="toc-text">需求加强说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80"><span class="toc-number">7.2.1.</span> <span class="toc-text">案例一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C"><span class="toc-number">7.2.2.</span> <span class="toc-text">案例二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E8%A7%84%E5%88%99%E5%9F%BA%E7%A1%80%E4%BB%A3%E7%A0%81%E5%87%86%E5%A4%87"><span class="toc-number">7.3.</span> <span class="toc-text">报警规则基础代码准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%BA%A7%E5%93%81%E8%AF%A6%E6%83%85%E6%8E%A5%E5%8F%A3"><span class="toc-number">7.4.</span> <span class="toc-text">查询产品详情接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E"><span class="toc-number">7.4.1.</span> <span class="toc-text">需求说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="toc-number">7.4.2.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82-5"><span class="toc-number">7.4.3.</span> <span class="toc-text">业务层</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4%E5%8F%8A%E5%A4%84%E7%90%86"><span class="toc-number">7.5.</span> <span class="toc-text">报警数据过滤及处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">7.5.1.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">7.5.2.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%B4%A3%E8%80%81%E4%BA%BA%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.5.2.1.</span> <span class="toc-text">负责老人功能介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E4%BF%9D%E5%AD%98%E6%8A%A5%E8%AD%A6%E6%95%B0%E6%8D%AE"><span class="toc-number">7.5.2.2.</span> <span class="toc-text">批量保存报警数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%8A%A5%E8%AD%A6%E9%80%9A%E7%9F%A5%E4%BA%BA"><span class="toc-number">7.5.2.3.</span> <span class="toc-text">查询报警通知人</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%80%81%E4%BA%BA%E5%BC%82%E5%B8%B8%E6%95%B0%E6%8D%AE%E8%A6%81%E9%80%9A%E7%9F%A5%E7%9A%84%E6%8A%A4%E7%90%86%E5%91%98"><span class="toc-number">7.5.2.4.</span> <span class="toc-text">查询老人异常数据要通知的护理员</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%A7%92%E8%89%B2%E5%90%8D%E7%A7%B0%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7id"><span class="toc-number">7.5.2.5.</span> <span class="toc-text">通过角色名称查询用户id</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">7.5.3.</span> <span class="toc-text">定时任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E8%BF%87%E6%BB%A4%E9%80%BB%E8%BE%91"><span class="toc-number">7.5.4.</span> <span class="toc-text">核心过滤逻辑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E9%80%9A%E7%9F%A5%E6%8F%90%E9%86%92"><span class="toc-number">7.6.</span> <span class="toc-text">报警通知提醒</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E-1"><span class="toc-number">7.6.1.</span> <span class="toc-text">需求说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0-4"><span class="toc-number">7.6.2.</span> <span class="toc-text">功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">7.6.2.1.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%9B%86%E6%88%90-1"><span class="toc-number">7.6.2.2.</span> <span class="toc-text">环境集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E6%95%B0%E6%8D%AE%E6%8E%A8%E9%80%81%E5%88%B0%E5%89%8D%E7%AB%AF"><span class="toc-number">7.6.2.3.</span> <span class="toc-text">报警数据推送到前端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">7.6.2.4.</span> <span class="toc-text">前端环境配置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%AD%E5%B7%9E%E5%85%BB%E8%80%81%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">中州养老项目总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8B%A5%E4%BE%9D%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">8.1.</span> <span class="toc-text">若依框架的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%80%80%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">8.2.</span> <span class="toc-text">入退管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E4%BD%8F%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">8.3.</span> <span class="toc-text">在住管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">8.4.</span> <span class="toc-text">服务管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E7%9B%91%E6%B5%8B%E6%A8%A1%E5%9D%97"><span class="toc-number">8.5.</span> <span class="toc-text">智能监测模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%A8%A1%E5%9D%97"><span class="toc-number">8.6.</span> <span class="toc-text">微信小程序模块</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/archives/4c776360.html" title="EasyExcel（报表导出）">EasyExcel（报表导出）</a><time datetime="2026-01-16T09:04:36.000Z" title="发表于 2026-01-16 17:04:36">2026-01-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/archives/30ee4bff.html" title="XXL-JOB">XXL-JOB</a><time datetime="2026-01-16T08:58:34.000Z" title="发表于 2026-01-16 16:58:34">2026-01-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/archives/27717283.html" title="Jmeter快速入门">Jmeter快速入门</a><time datetime="2026-01-16T08:43:23.000Z" title="发表于 2026-01-16 16:43:23">2026-01-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/archives/2040d45d.html" title="Canal">Canal</a><time datetime="2026-01-16T08:30:26.000Z" title="发表于 2026-01-16 16:30:26">2026-01-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/archives/d48132d3.html" title="ElasticSearch">ElasticSearch</a><time datetime="2026-01-16T08:30:26.000Z" title="发表于 2026-01-16 16:30:26">2026-01-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2026 By Zhao</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="/js/header_bg.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html>